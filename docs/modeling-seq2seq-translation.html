---

title: modeling.seq2seq.translation


keywords: fastai
sidebar: home_sidebar

summary: "This module contains custom models, custom splitters, etc... translation tasks."
description: "This module contains custom models, custom splitters, etc... translation tasks."
nb_path: "nbs/02zc_modeling-seq2seq-translation.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/02zc_modeling-seq2seq-translation.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[nltk_data] Downloading package wordnet to /home/wgilliam/nltk_data...
[nltk_data]   Package wordnet is already up-to-date!
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using GPU #</span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">current_device</span><span class="p">()</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Using GPU #1: GeForce GTX 1080 Ti
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Translation">Translation<a class="anchor-link" href="#Translation"> </a></h2><p>Translation tasks attempt to convert text in one language into another</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Prepare-the-data">Prepare the data<a class="anchor-link" href="#Prepare-the-data"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;wmt16&#39;</span><span class="p">,</span> <span class="s1">&#39;de-en&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train[:1%]&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset wmt16 (/home/wgilliam/.cache/huggingface/datasets/wmt16/de-en/1.0.0/7b2c4443a7d34c2e13df267eaa8cab4c62dd82f6b62b0d9ecc2e3a673ce17308)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
<span class="n">wmt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;translation&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;de&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">]);</span> <span class="nb">len</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>45489</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">wmt_df</span> <span class="o">=</span> <span class="n">wmt_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">wmt_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>de</th>
      <th>en</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Wiederaufnahme der Sitzungsperiode</td>
      <td>Resumption of the session</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ich erkläre die am Freitag, dem 17. Dezember unterbrochene Sitzungsperiode des Europäischen Parlaments für wiederaufgenommen, wünsche Ihnen nochmals alles Gute zum Jahreswechsel und hoffe, daß Sie schöne Ferien hatten.</td>
      <td>I declare resumed the session of the European Parliament adjourned on Friday 17 December 1999, and I would like once again to wish you a happy new year in the hope that you enjoyed a pleasant festive period.</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pretrained_model_name</span> <span class="o">=</span> <span class="s2">&quot;facebook/bart-large-cnn&quot;</span>
<span class="n">task</span> <span class="o">=</span> <span class="n">HF_TASKS_AUTO</span><span class="o">.</span><span class="n">Seq2SeqLM</span>

<span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span> <span class="o">=</span> <span class="n">BLURR_MODEL_HELPER</span><span class="o">.</span><span class="n">get_hf_objects</span><span class="p">(</span><span class="n">pretrained_model_name</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>

<span class="n">hf_arch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_config</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&#39;bart&#39;,
 transformers.models.bart.tokenization_bart_fast.BartTokenizerFast,
 transformers.models.bart.configuration_bart.BartConfig,
 transformers.models.bart.modeling_bart.BartForConditionalGeneration)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">HF_Seq2SeqBlock</span><span class="p">(</span><span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">),</span> <span class="n">noop</span><span class="p">)</span>
<span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> <span class="n">get_x</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">&#39;de&#39;</span><span class="p">),</span> <span class="n">get_y</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">&#39;en&#39;</span><span class="p">),</span> <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(2, torch.Size([2, 325]), torch.Size([2, 86]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">dataloaders</span><span class="o">=</span><span class="n">dls</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Angesichts dieser Situation muß aus dem Bericht, den das Parlament annimmt, klar hervorgehen, daß Maßnahmen notwendig sind, die eindeutig auf die Bekämpfung der relativen Armut und der Arbeitslosigkeit gerichtet sind. Maßnahmen wie die für diese Zwe</td>
      <td>Given this situation, the report approved by Parliament must highlight the need for measures that aim unequivocally to fight relative poverty and unemployment: measures such as the appropriate use of structural funds for these purposes, which are of</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Es muß daran erinnert werden, daß die globale Wettbewerbsfähigkeit der Europäischen Union gegenwärtig 81 % des Niveaus der Vereinigten Staaten von Amerika erreicht und daß diese Kennziffer sich nur dann verbessern wird, wenn sich die unserer wettbew</td>
      <td>It must be remembered that, currently, the European Union' s overall competitiveness is, in general terms, 81% of that of the United States of America and that this figure will only improve if the figure for our competitive units, that is the region</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Train-model">Train model<a class="anchor-link" href="#Train-model"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">seq2seq_metrics</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;bleu&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;returns&#39;</span><span class="p">:</span> <span class="s2">&quot;bleu&quot;</span> <span class="p">},</span>
    <span class="s1">&#39;meteor&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;returns&#39;</span><span class="p">:</span> <span class="s2">&quot;meteor&quot;</span> <span class="p">},</span>
    <span class="s1">&#39;sacrebleu&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;returns&#39;</span><span class="p">:</span> <span class="s2">&quot;score&quot;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">HF_BaseModelWrapper</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>

<span class="n">learn_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">HF_BaseModelCallback</span><span class="p">]</span>
<span class="n">fit_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">HF_Seq2SeqMetricsCallback</span><span class="p">(</span><span class="n">custom_metrics</span><span class="o">=</span><span class="n">seq2seq_metrics</span><span class="p">)]</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> 
                <span class="n">model</span><span class="p">,</span>
                <span class="n">opt_func</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">Adam</span><span class="p">),</span>
                <span class="n">loss_func</span><span class="o">=</span><span class="n">CrossEntropyLossFlat</span><span class="p">(),</span> <span class="c1">#HF_PreCalculatedLoss()</span>
                <span class="n">cbs</span><span class="o">=</span><span class="n">learn_cbs</span><span class="p">,</span>
                <span class="n">splitter</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">seq2seq_splitter</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">hf_arch</span><span class="p">))</span> <span class="c1">#.to_native_fp16() #.to_fp16()</span>

<span class="n">learn</span><span class="o">.</span><span class="n">create_opt</span><span class="p">()</span> 
<span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># preds = learn.model(b[0])</span>

<span class="c1"># len(preds),preds[&#39;loss&#39;].shape, preds[&#39;logits&#39;].shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(2, 3, torch.Size([2, 325]), 2, torch.Size([2, 86]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>3
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">(</span><span class="n">suggestions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SuggestedLRs(lr_min=8.317637839354575e-05, lr_steep=0.00015848931798245758)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">4e-5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">fit_cbs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>bleu</th>
      <th>meteor</th>
      <th>sacrebleu</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.287987</td>
      <td>2.100064</td>
      <td>0.088155</td>
      <td>0.290024</td>
      <td>8.252259</td>
      <td>02:28</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Aus diesem Grund ist es eines der wichtigsten und weitreichendsten Ziele, die wir uns in der Europäischen Union stellen sollten, Anstrengungen zur Schaffung neuer Arbeitsplätze in den ländlichen Gebieten außerhalb des Agrarsektors zu unternehmen, unter anderem in den Bereichen ländlicher Tourismus, Sport, Kultur, Sanierung der Ressourcen, Umstellung von Unternehmen, neue Technologien, Dienstleistungen usw. Doch obwohl die Landwirtschaft keine ausschließliche Rolle mehr spielt, ist sie weiterhin</td>
      <td>For this reason, one of the most important and essential objectives which we should set in the European Union is to make efforts to create new jobs in rural areas, outside of the agricultural sector, in sectors such as rural tourism, sport, culture, heritage conservation, the conversion of businesses, new technologies, services, etc. However, even though the role of agriculture is not exclusive, it is still essential, not only to prevent economic and social disintegration and the creation of gh</td>
      <td>Despite the fact that the Landwirtschaft has no significant role to play, it is still very important, not only to ensure the economic and social cohesion of the regions, but also to ensure that the Territoriums have a significant role in the development of the territorial environment and the protection of the environment. It is one of the most important objectives of the European Union, which is to ensure an increase in employment in the rural areas, particularly in tourism, sport, culture, agr</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Herr Präsident, Herr Kommissar, sehr geehrte Kollegen! Als Beweis dafür, daß dieses Parlament die Phase einer beratenden und untergeordneten Institution noch nicht überwunden hat, konnte der ausgezeichnete Bericht meiner Fraktionskollegin Elisabeth Schroedter nicht ins Plenum gelangen, weil die Regionalentwicklungspläne des Zeitraums 2000-2006 für die Ziel-1-Regionen bereits mehrere Monate in den Arbeitszimmern der Kommission liegen.</td>
      <td>Mr President, Commissioner, as proof that this Parliament has not yet overcome its role as a consultative and subordinate institution, the excellent report by a fellow member of my Group, Elisabeth Schroedter, has not been able to reach plenary sitting because the plans for regional development for the period 2000-2006 for Objective 1 regions have been sitting in the Commission' s offices for several months.</td>
      <td>Mr President, Commissioner, I would like to congratulate you on a very good report by your rapporteur, Elisabeth Schroedter, which did not make it to the plenary session because it had already been discussed for several months in the Commission' s offices.</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_de</span> <span class="o">=</span> <span class="s2">&quot;Ich trinke gerne Bier&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">outputs</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">blurr_generate</span><span class="p">(</span><span class="n">test_de</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;=== Prediction </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1"> ===</span><span class="se">\n</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>=== Prediction 1 ===
 I am a beer drinker, and I like to drink a beer, as you know. It is a very good thing to be a beer tipple, in a sense. It&#39;s a very beautiful thing. I like it. I think it is a good thing.

=== Prediction 2 ===
 I am a beer drinker, and I like to drink a beer, as you know. It is a very good thing to be a beer tipple, in a sense. It&#39;s a very beautiful thing. I like it. I think it is a good idea.

=== Prediction 3 ===
 I am a beer drinker, and I like to drink a beer, as you know. It is a very good thing to be a beer tipple, in a sense. It&#39;s a very beautiful thing. I like it. I think it is a good product.

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Inference">Inference<a class="anchor-link" href="#Inference"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">export_fname</span> <span class="o">=</span> <span class="s1">&#39;translation_export&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">learn</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">export_fname</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">inf_learn</span> <span class="o">=</span> <span class="n">load_learner</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">export_fname</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>
<span class="n">inf_learn</span><span class="o">.</span><span class="n">blurr_generate</span><span class="p">(</span><span class="n">test_de</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#34; I am a beer drinker, and I like to drink a beer, as you know. It is a very good thing to be a beer tipple, in a sense. It&#39;s a very beautiful thing. I like it. I think it is a good thing.&#34;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tests">Tests<a class="anchor-link" href="#Tests"> </a></h2><p>The purpose of the following tests is to ensure as much as possible, that the core training code works for the pretrained <strong>summarization models</strong> below.  These tests are excluded from the CI workflow because of how long they would take to run and the amount of data that would be required to download.</p>
<p><strong>Note</strong>: Feel free to modify the code below to test whatever pretrained summarization models you are working with ... and if any of your pretrained summarization models fail, please submit a github issue <em>(or a PR if you'd like to fix it yourself)</em></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">try</span><span class="p">:</span> <span class="k">del</span> <span class="n">learn</span><span class="p">;</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span> <span class="n">model_type</span> <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="n">BLURR_MODEL_HELPER</span><span class="o">.</span><span class="n">get_models</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="s1">&#39;ConditionalGeneration&#39;</span><span class="p">)</span> 
 <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;TF&#39;</span><span class="p">))</span> <span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[transformers.models.bart.modeling_bart.BartForConditionalGeneration,
 transformers.models.blenderbot.modeling_blenderbot.BlenderbotForConditionalGeneration,
 transformers.models.blenderbot_small.modeling_blenderbot_small.BlenderbotSmallForConditionalGeneration,
 transformers.models.fsmt.modeling_fsmt.FSMTForConditionalGeneration,
 transformers.models.led.modeling_led.LEDForConditionalGeneration,
 transformers.models.mbart.modeling_mbart.MBartForConditionalGeneration,
 transformers.models.mt5.modeling_mt5.MT5ForConditionalGeneration,
 transformers.models.pegasus.modeling_pegasus.PegasusForConditionalGeneration,
 transformers.models.prophetnet.modeling_prophetnet.ProphetNetForConditionalGeneration,
 transformers.models.t5.modeling_t5.T5ForConditionalGeneration,
 transformers.models.xlm_prophetnet.modeling_xlm_prophetnet.XLMProphetNetForConditionalGeneration]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pretrained_model_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;facebook/bart-base&#39;</span><span class="p">,</span>
    <span class="s1">&#39;facebook/wmt19-de-en&#39;</span><span class="p">,</span>                      <span class="c1"># FSMT</span>
    <span class="s1">&#39;Helsinki-NLP/opus-mt-de-en&#39;</span><span class="p">,</span>                <span class="c1"># MarianMT</span>
    <span class="c1">#&#39;sshleifer/tiny-mbart&#39;,</span>
    <span class="c1">#&#39;google/mt5-small&#39;,</span>
    <span class="s1">&#39;t5-small&#39;</span>
<span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;wmt16&#39;</span><span class="p">,</span> <span class="s1">&#39;de-en&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train[:1%]&#39;</span><span class="p">)</span>
<span class="n">wmt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;translation&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;de&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">]);</span> <span class="nb">len</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">)</span>
<span class="n">wmt_df</span> <span class="o">=</span> <span class="n">wmt_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset wmt16 (/home/wgilliam/.cache/huggingface/datasets/wmt16/de-en/1.0.0/7b2c4443a7d34c2e13df267eaa8cab4c62dd82f6b62b0d9ecc2e3a673ce17308)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#hide_output</span>
<span class="n">task</span> <span class="o">=</span> <span class="n">HF_TASKS_AUTO</span><span class="o">.</span><span class="n">Seq2SeqLM</span>
<span class="n">bsz</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">inp_seq_sz</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span> <span class="n">trg_seq_sz</span> <span class="o">=</span> <span class="mi">128</span>

<span class="n">test_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">pretrained_model_names</span><span class="p">:</span>
    <span class="n">error</span><span class="o">=</span><span class="kc">None</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;=== </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1"> ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span> <span class="o">=</span> <span class="n">BLURR_MODEL_HELPER</span><span class="o">.</span><span class="n">get_hf_objects</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;architecture:</span><span class="se">\t</span><span class="si">{</span><span class="n">hf_arch</span><span class="si">}</span><span class="se">\n</span><span class="s1">tokenizer:</span><span class="se">\t</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s1">model:</span><span class="se">\t\t</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># 1. build your DataBlock</span>
    <span class="n">text_gen_kwargs</span> <span class="o">=</span> <span class="n">default_text_gen_kwargs</span><span class="p">(</span><span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s1">&#39;translation&#39;</span><span class="p">)</span>
    
    <span class="n">tok_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hf_arch</span> <span class="o">==</span> <span class="s1">&#39;mbart&#39;</span><span class="p">):</span>
        <span class="n">tok_kwargs</span><span class="p">[</span><span class="s1">&#39;src_lang&#39;</span><span class="p">],</span> <span class="n">tok_kwargs</span><span class="p">[</span><span class="s1">&#39;tgt_lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;de_DE&quot;</span><span class="p">,</span> <span class="s2">&quot;en_XX&quot;</span>
            
    <span class="k">def</span> <span class="nf">add_t5_prefix</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;translate German to English: </span><span class="si">{</span><span class="n">inp</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">hf_arch</span> <span class="o">==</span> <span class="s1">&#39;t5&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">inp</span>
    
    <span class="n">before_batch_tfm</span> <span class="o">=</span> <span class="n">HF_Seq2SeqBeforeBatchTransform</span><span class="p">(</span><span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">,</span>
                                                      <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;max_length&#39;</span><span class="p">,</span> 
                                                      <span class="n">max_length</span><span class="o">=</span><span class="n">inp_seq_sz</span><span class="p">,</span> 
                                                      <span class="n">max_target_length</span><span class="o">=</span><span class="n">trg_seq_sz</span><span class="p">,</span> 
                                                      <span class="n">tok_kwargs</span><span class="o">=</span><span class="n">tok_kwargs</span><span class="p">,</span> <span class="n">text_gen_kwargs</span><span class="o">=</span><span class="n">text_gen_kwargs</span><span class="p">)</span>
    
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">HF_Seq2SeqBlock</span><span class="p">(</span><span class="n">before_batch_tfm</span><span class="o">=</span><span class="n">before_batch_tfm</span><span class="p">),</span> <span class="n">noop</span><span class="p">)</span>
    <span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> 
                   <span class="n">get_x</span><span class="o">=</span><span class="n">Pipeline</span><span class="p">([</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">&#39;de&#39;</span><span class="p">),</span> <span class="n">add_t5_prefix</span><span class="p">]),</span> 
                   <span class="n">get_y</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">&#39;en&#39;</span><span class="p">),</span> 
                   <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">())</span>

    <span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bsz</span><span class="p">)</span> 
    <span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>

    <span class="c1"># 2. build your Learner</span>
    <span class="n">seq2seq_metrics</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">HF_BaseModelWrapper</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>
    <span class="n">fit_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">HF_Seq2SeqMetricsCallback</span><span class="p">(</span><span class="n">custom_metrics</span><span class="o">=</span><span class="n">seq2seq_metrics</span><span class="p">)]</span>

    <span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> 
                    <span class="n">model</span><span class="p">,</span>
                    <span class="n">opt_func</span><span class="o">=</span><span class="n">ranger</span><span class="p">,</span>
                    <span class="n">loss_func</span><span class="o">=</span><span class="n">HF_PreCalculatedLoss</span><span class="p">(),</span>
                    <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">HF_BaseModelCallback</span><span class="p">],</span>
                    <span class="n">splitter</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">seq2seq_splitter</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">hf_arch</span><span class="p">))</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">()</span>

    <span class="n">learn</span><span class="o">.</span><span class="n">create_opt</span><span class="p">()</span> 
    <span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
    
    <span class="c1"># 3. Run your tests</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** TESTING DataLoaders ***</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]),</span> <span class="n">bsz</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">bsz</span><span class="p">,</span> <span class="n">inp_seq_sz</span><span class="p">]))</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">bsz</span><span class="p">)</span>

<span class="c1">#         print(&#39;*** TESTING One pass through the model ***&#39;)</span>
<span class="c1">#         preds = learn.model(b[0])</span>
<span class="c1">#         test_eq(preds[1].shape[0], bsz)</span>
<span class="c1">#         test_eq(preds[1].shape[2], hf_config.vocab_size)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** TESTING Training/Results ***&#39;</span><span class="p">)</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">fit_cbs</span><span class="p">)</span>

        <span class="n">test_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">hf_arch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;PASSED&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">test_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">hf_arch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;FAILED&#39;</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># cleanup</span>
        <span class="k">del</span> <span class="n">learn</span><span class="p">;</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>arch</th>
      <th>tokenizer</th>
      <th>model_name</th>
      <th>result</th>
      <th>error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>bart</td>
      <td>BartTokenizerFast</td>
      <td>BartForConditionalGeneration</td>
      <td>PASSED</td>
      <td></td>
    </tr>
    <tr>
      <th>1</th>
      <td>fsmt</td>
      <td>FSMTTokenizer</td>
      <td>FSMTForConditionalGeneration</td>
      <td>PASSED</td>
      <td></td>
    </tr>
    <tr>
      <th>2</th>
      <td>marian</td>
      <td>MarianTokenizer</td>
      <td>MarianMTModel</td>
      <td>PASSED</td>
      <td></td>
    </tr>
    <tr>
      <th>3</th>
      <td>t5</td>
      <td>T5TokenizerFast</td>
      <td>T5ForConditionalGeneration</td>
      <td>PASSED</td>
      <td></td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Cleanup">Cleanup<a class="anchor-link" href="#Cleanup"> </a></h2>
</div>
</div>
</div>
</div>
 

