---

title: modeling.seq2seq.translation


keywords: fastai
sidebar: home_sidebar

summary: "This module contains custom models, custom splitters, etc... translation tasks."
description: "This module contains custom models, custom splitters, etc... translation tasks."
nb_path: "nbs/02zc_modeling-seq2seq-translation.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/02zc_modeling-seq2seq-translation.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using GPU #</span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">current_device</span><span class="p">()</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Using GPU #1: GeForce GTX 1080 Ti
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Translation">Translation<a class="anchor-link" href="#Translation"> </a></h2><p>Translation tasks attempt to convert text in one language into another</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Prepare-the-data">Prepare the data<a class="anchor-link" href="#Prepare-the-data"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;wmt16&#39;</span><span class="p">,</span> <span class="s1">&#39;de-en&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train[:1%]&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset wmt16 (/home/wgilliam/.cache/huggingface/datasets/wmt16/de-en/1.0.0/7b2c4443a7d34c2e13df267eaa8cab4c62dd82f6b62b0d9ecc2e3a673ce17308)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
<span class="n">wmt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;translation&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;de&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">]);</span> <span class="nb">len</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>45489</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">wmt_df</span> <span class="o">=</span> <span class="n">wmt_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">wmt_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>de</th>
      <th>en</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Wiederaufnahme der Sitzungsperiode</td>
      <td>Resumption of the session</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ich erkläre die am Freitag, dem 17. Dezember unterbrochene Sitzungsperiode des Europäischen Parlaments für wiederaufgenommen, wünsche Ihnen nochmals alles Gute zum Jahreswechsel und hoffe, daß Sie schöne Ferien hatten.</td>
      <td>I declare resumed the session of the European Parliament adjourned on Friday 17 December 1999, and I would like once again to wish you a happy new year in the hope that you enjoyed a pleasant festive period.</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pretrained_model_name</span> <span class="o">=</span> <span class="s2">&quot;facebook/bart-large-cnn&quot;</span>
<span class="n">model_cls</span> <span class="o">=</span> <span class="n">AutoModelForSeq2SeqLM</span>

<span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span> <span class="o">=</span> <span class="n">BLURR</span><span class="o">.</span><span class="n">get_hf_objects</span><span class="p">(</span><span class="n">pretrained_model_name</span><span class="p">,</span> <span class="n">model_cls</span><span class="o">=</span><span class="n">model_cls</span><span class="p">)</span>
<span class="n">hf_arch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_config</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&#39;bart&#39;,
 transformers.models.bart.tokenization_bart_fast.BartTokenizerFast,
 transformers.models.bart.configuration_bart.BartConfig,
 transformers.models.bart.modeling_bart.BartForConditionalGeneration)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">HF_Seq2SeqBlock</span><span class="p">(</span><span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">),</span> <span class="n">noop</span><span class="p">)</span>
<span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> <span class="n">get_x</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">&#39;de&#39;</span><span class="p">),</span> <span class="n">get_y</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">&#39;en&#39;</span><span class="p">),</span> <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(2, torch.Size([2, 325]), torch.Size([2, 103]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">dataloaders</span><span class="o">=</span><span class="n">dls</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Angesichts dieser Situation muß aus dem Bericht, den das Parlament annimmt, klar hervorgehen, daß Maßnahmen notwendig sind, die eindeutig auf die Bekämpfung der relativen Armut und der Arbeitslosigkeit gerichtet sind. Maßnahmen wie die für diese Zwe</td>
      <td>Given this situation, the report approved by Parliament must highlight the need for measures that aim unequivocally to fight relative poverty and unemployment: measures such as the appropriate use of structural funds for these purposes, which are of</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ich gehe mit der Berichterstatterin konform, daß das Kommissionsdokument leider zu wenig Empfehlungen an die Mitgliedstaaten zur Verwaltungsvereinfachung enthält, und unterstreiche Forderungen wie Konzentration bei Verhandlungen auf die Förderung ei</td>
      <td>I agree with the rapporteur that unfortunately the Commission document contains too little in the way of recommendations to the Member States on simplifying administration, and I support the calls for negotiations to concentrate on promoting a favou</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Train-model">Train model<a class="anchor-link" href="#Train-model"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">seq2seq_metrics</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;bleu&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;returns&#39;</span><span class="p">:</span> <span class="s2">&quot;bleu&quot;</span> <span class="p">},</span>
    <span class="s1">&#39;meteor&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;returns&#39;</span><span class="p">:</span> <span class="s2">&quot;meteor&quot;</span> <span class="p">},</span>
    <span class="s1">&#39;sacrebleu&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;returns&#39;</span><span class="p">:</span> <span class="s2">&quot;score&quot;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">HF_BaseModelWrapper</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>

<span class="n">learn_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">HF_BaseModelCallback</span><span class="p">]</span>
<span class="n">fit_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">HF_Seq2SeqMetricsCallback</span><span class="p">(</span><span class="n">custom_metrics</span><span class="o">=</span><span class="n">seq2seq_metrics</span><span class="p">)]</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> 
                <span class="n">model</span><span class="p">,</span>
                <span class="n">opt_func</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">Adam</span><span class="p">),</span>
                <span class="n">loss_func</span><span class="o">=</span><span class="n">CrossEntropyLossFlat</span><span class="p">(),</span> <span class="c1">#HF_PreCalculatedLoss()</span>
                <span class="n">cbs</span><span class="o">=</span><span class="n">learn_cbs</span><span class="p">,</span>
                <span class="n">splitter</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">seq2seq_splitter</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">hf_arch</span><span class="p">))</span> <span class="c1">#.to_native_fp16() #.to_fp16()</span>

<span class="n">learn</span><span class="o">.</span><span class="n">create_opt</span><span class="p">()</span> 
<span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># preds = learn.model(b[0])</span>

<span class="c1"># len(preds),preds[&#39;loss&#39;].shape, preds[&#39;logits&#39;].shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(2, 3, torch.Size([2, 325]), 2, torch.Size([2, 103]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>3
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">(</span><span class="n">suggestions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SuggestedLRs(lr_min=0.00010000000474974513, lr_steep=0.0831763744354248)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">4e-5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">fit_cbs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>bleu</th>
      <th>meteor</th>
      <th>sacrebleu</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.223296</td>
      <td>2.126458</td>
      <td>0.082567</td>
      <td>0.288516</td>
      <td>7.607020</td>
      <td>02:10</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Sie wird aber auf Seite 5 dieser Leitlinien ganz eindeutig genannt, und ich möchte darauf verweisen - weil sie mich dazu aufgefordert haben -, daß diese Partnerschaft für mich - und ich habe lange genug eine Region betreut, um dies beurteilen zu können - ein sehr wirkungsvolles Instrument zur Mobilisierung der geistigen Ressourcen auf lokaler Ebene ist - sowohl derer im öffentlichen Sektor - die Stadt- und Gemeinderäte, den schulischen und gesellschaftlichen Bereich, die Vereine und Verbände -</td>
      <td>However, I do wish to mention - since you have asked me to do so - that, as far as I am concerned, this partnership - and I spent long enough as a regional administrator within my own country to be able to say this most sincerely - is a tool, one used to involve local brainpower, be it in the public sector, in the form of elected representatives, the social and educational sectors, associations, or in the private sector; a decentralised partnership, and let me mention in this connection, in res</td>
      <td>As you know, I would like to point out that, because I was asked to do so, this partnership is a very important one for me - and I have had a long-standing interest in it - and that it is an important instrument for the development of local communities, not only in the public sector but also in the private sector as well. And the territorial agreements which I have just mentioned are one of the forms of cooperation between me and Mrs Angelilli, for example, in the form of territorial agreements</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ich möchte daher die Kommission auf zwei Punkte hinweisen: Erstens muß die Konzertierung als Instrument der Koordinierung und der Beteiligung sämtlicher lokaler und regionaler Marktteilnehmer an den Entscheidungen optimal genutzt werden, um speziell Ungleichgewichte und Ungleichheiten zu vermeiden; zweitens bedarf es einer Vereinfachung und transparenteren Gestaltung der Verwaltungsprozesse, die sich allzu häufig unnötig in die Länge ziehen und derart kompliziert sind, daß sie, was vor allem vo</td>
      <td>Firstly, we need to make the best possible use of consultation as a means of ensuring proper coordination and participation by all local and regional operators in decision-making, precisely so that imbalances and inequalities can be avoided. Secondly, a genuine effort is required to make administrative procedures simpler and more transparent, since, they are all too often unnecessarily lengthy and complicated, to the point of hindering access to the Funds.</td>
      <td>I would like the Commission to focus on two points, firstly, on the importance of the Commission' s role as an instrument for the coordination and cooperation of local and regional stakeholders in the decision-making process, so as to ensure that there is a level of transparency and coordination in the implementation of the procedures, which are all too often difficult to implement and, in particular, because of the influence of the European Commission, the Commission has been a major factor in</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_de</span> <span class="o">=</span> <span class="s2">&quot;Ich trinke gerne Bier&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">outputs</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">blurr_generate</span><span class="p">(</span><span class="n">test_de</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;=== Prediction </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1"> ===</span><span class="se">\n</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>=== Prediction 1 ===
 I would like to make a beer, however, for the sake of beer, of course. I am a beer drinker, after all, and I like to drink a beer of some kind, as you do too, I would say, in a sense.

=== Prediction 2 ===
 I would like to make a beer, however, for the sake of beer, of course. I am a beer drinker, after all, and I like to drink a beer of some kind, as you do too, I would say, but not a beer.

=== Prediction 3 ===
 I would like to make a beer, however, for the sake of beer, of course. I am a beer drinker, after all, and I like to drink a beer of some kind, as you do too, I would say, in a way.

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Inference">Inference<a class="anchor-link" href="#Inference"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">export_fname</span> <span class="o">=</span> <span class="s1">&#39;translation_export&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">learn</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">export_fname</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">inf_learn</span> <span class="o">=</span> <span class="n">load_learner</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">export_fname</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>
<span class="n">inf_learn</span><span class="o">.</span><span class="n">blurr_generate</span><span class="p">(</span><span class="n">test_de</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39; I would like to make a beer, however, for the sake of beer, of course. I am a beer drinker, after all, and I like to drink a beer of some kind, as you do too, I would say, in a sense.&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tests">Tests<a class="anchor-link" href="#Tests"> </a></h2><p>The purpose of the following tests is to ensure as much as possible, that the core training code works for the pretrained <strong>summarization models</strong> below.  These tests are excluded from the CI workflow because of how long they would take to run and the amount of data that would be required to download.</p>
<p><strong>Note</strong>: Feel free to modify the code below to test whatever pretrained summarization models you are working with ... and if any of your pretrained summarization models fail, please submit a github issue <em>(or a PR if you'd like to fix it yourself)</em></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">try</span><span class="p">:</span> <span class="k">del</span> <span class="n">learn</span><span class="p">;</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span> <span class="n">model_type</span> <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="n">BLURR</span><span class="o">.</span><span class="n">get_models</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="s1">&#39;ConditionalGeneration&#39;</span><span class="p">)</span> 
 <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;TF&#39;</span><span class="p">))</span> <span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[transformers.models.bart.modeling_bart.BartForConditionalGeneration,
 transformers.models.blenderbot.modeling_blenderbot.BlenderbotForConditionalGeneration,
 transformers.models.blenderbot_small.modeling_blenderbot_small.BlenderbotSmallForConditionalGeneration,
 transformers.models.fsmt.modeling_fsmt.FSMTForConditionalGeneration,
 transformers.models.led.modeling_led.LEDForConditionalGeneration,
 transformers.models.m2m_100.modeling_m2m_100.M2M100ForConditionalGeneration,
 transformers.models.mbart.modeling_mbart.MBartForConditionalGeneration,
 transformers.models.mt5.modeling_mt5.MT5ForConditionalGeneration,
 transformers.models.pegasus.modeling_pegasus.PegasusForConditionalGeneration,
 transformers.models.prophetnet.modeling_prophetnet.ProphetNetForConditionalGeneration,
 transformers.models.speech_to_text.modeling_speech_to_text.Speech2TextForConditionalGeneration,
 transformers.models.t5.modeling_t5.T5ForConditionalGeneration,
 transformers.models.xlm_prophetnet.modeling_xlm_prophetnet.XLMProphetNetForConditionalGeneration]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pretrained_model_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;facebook/bart-base&#39;</span><span class="p">,</span>
    <span class="s1">&#39;facebook/wmt19-de-en&#39;</span><span class="p">,</span>                      <span class="c1"># FSMT</span>
    <span class="s1">&#39;Helsinki-NLP/opus-mt-de-en&#39;</span><span class="p">,</span>                <span class="c1"># MarianMT</span>
    <span class="c1">#&#39;sshleifer/tiny-mbart&#39;,</span>
    <span class="c1">#&#39;google/mt5-small&#39;,</span>
    <span class="s1">&#39;t5-small&#39;</span>
<span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;wmt16&#39;</span><span class="p">,</span> <span class="s1">&#39;de-en&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train[:1%]&#39;</span><span class="p">)</span>
<span class="n">wmt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;translation&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;de&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">]);</span> <span class="nb">len</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">)</span>
<span class="n">wmt_df</span> <span class="o">=</span> <span class="n">wmt_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset wmt16 (/home/wgilliam/.cache/huggingface/datasets/wmt16/de-en/1.0.0/7b2c4443a7d34c2e13df267eaa8cab4c62dd82f6b62b0d9ecc2e3a673ce17308)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#hide_output</span>
<span class="n">model_cls</span> <span class="o">=</span> <span class="n">AutoModelForSeq2SeqLM</span>
<span class="n">bsz</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">inp_seq_sz</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span> <span class="n">trg_seq_sz</span> <span class="o">=</span> <span class="mi">128</span>

<span class="n">test_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">pretrained_model_names</span><span class="p">:</span>
    <span class="n">error</span><span class="o">=</span><span class="kc">None</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;=== </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1"> ===</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="n">hf_tok_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;sshleifer/tiny-mbart&#39;</span><span class="p">):</span>
        <span class="n">hf_tok_kwargs</span><span class="p">[</span><span class="s1">&#39;src_lang&#39;</span><span class="p">],</span> <span class="n">hf_tok_kwargs</span><span class="p">[</span><span class="s1">&#39;tgt_lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;de_DE&quot;</span><span class="p">,</span> <span class="s2">&quot;en_XX&quot;</span>
            
    
    <span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span> <span class="o">=</span> <span class="n">BLURR</span><span class="o">.</span><span class="n">get_hf_objects</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> 
                                                                      <span class="n">model_cls</span><span class="o">=</span><span class="n">model_cls</span><span class="p">,</span> 
                                                                      <span class="n">tokenizer_kwargs</span><span class="o">=</span><span class="n">hf_tok_kwargs</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;architecture:</span><span class="se">\t</span><span class="si">{</span><span class="n">hf_arch</span><span class="si">}</span><span class="se">\n</span><span class="s1">tokenizer:</span><span class="se">\t</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s1">model:</span><span class="se">\t\t</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># 1. build your DataBlock</span>
    <span class="n">text_gen_kwargs</span> <span class="o">=</span> <span class="n">default_text_gen_kwargs</span><span class="p">(</span><span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s1">&#39;translation&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_t5_prefix</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;translate German to English: </span><span class="si">{</span><span class="n">inp</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">hf_arch</span> <span class="o">==</span> <span class="s1">&#39;t5&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">inp</span>
    
    <span class="n">before_batch_tfm</span> <span class="o">=</span> <span class="n">HF_Seq2SeqBeforeBatchTransform</span><span class="p">(</span><span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">,</span>
                                                      <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;max_length&#39;</span><span class="p">,</span> 
                                                      <span class="n">max_length</span><span class="o">=</span><span class="n">inp_seq_sz</span><span class="p">,</span> 
                                                      <span class="n">max_target_length</span><span class="o">=</span><span class="n">trg_seq_sz</span><span class="p">,</span> 
                                                      <span class="n">text_gen_kwargs</span><span class="o">=</span><span class="n">text_gen_kwargs</span><span class="p">)</span>
    
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">HF_Seq2SeqBlock</span><span class="p">(</span><span class="n">before_batch_tfm</span><span class="o">=</span><span class="n">before_batch_tfm</span><span class="p">),</span> <span class="n">noop</span><span class="p">)</span>
    <span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> 
                   <span class="n">get_x</span><span class="o">=</span><span class="n">Pipeline</span><span class="p">([</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">&#39;de&#39;</span><span class="p">),</span> <span class="n">add_t5_prefix</span><span class="p">]),</span> 
                   <span class="n">get_y</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">&#39;en&#39;</span><span class="p">),</span> 
                   <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">())</span>

    <span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bsz</span><span class="p">)</span> 
    <span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>

    <span class="c1"># 2. build your Learner</span>
    <span class="n">seq2seq_metrics</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">HF_BaseModelWrapper</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>
    <span class="n">fit_cbs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ShortEpochCallback</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">short_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> 
        <span class="n">HF_Seq2SeqMetricsCallback</span><span class="p">(</span><span class="n">custom_metrics</span><span class="o">=</span><span class="n">seq2seq_metrics</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> 
                    <span class="n">model</span><span class="p">,</span>
                    <span class="n">opt_func</span><span class="o">=</span><span class="n">ranger</span><span class="p">,</span>
                    <span class="n">loss_func</span><span class="o">=</span><span class="n">HF_PreCalculatedLoss</span><span class="p">(),</span>
                    <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">HF_BaseModelCallback</span><span class="p">],</span>
                    <span class="n">splitter</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">seq2seq_splitter</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">hf_arch</span><span class="p">))</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">()</span>

    <span class="n">learn</span><span class="o">.</span><span class="n">create_opt</span><span class="p">()</span> 
    <span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
    
    <span class="c1"># 3. Run your tests</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** TESTING DataLoaders ***</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]),</span> <span class="n">bsz</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">bsz</span><span class="p">,</span> <span class="n">inp_seq_sz</span><span class="p">]))</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">bsz</span><span class="p">)</span>

<span class="c1">#         print(&#39;*** TESTING One pass through the model ***&#39;)</span>
<span class="c1">#         preds = learn.model(b[0])</span>
<span class="c1">#         test_eq(preds[1].shape[0], bsz)</span>
<span class="c1">#         test_eq(preds[1].shape[2], hf_config.vocab_size)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** TESTING Training/Results ***&#39;</span><span class="p">)</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">fit_cbs</span><span class="p">)</span>

        <span class="n">test_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">hf_arch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;PASSED&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">test_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">hf_arch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;FAILED&#39;</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># cleanup</span>
        <span class="k">del</span> <span class="n">learn</span><span class="p">;</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>arch</th>
      <th>tokenizer</th>
      <th>model_name</th>
      <th>result</th>
      <th>error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>bart</td>
      <td>BartTokenizerFast</td>
      <td>BartForConditionalGeneration</td>
      <td>PASSED</td>
      <td></td>
    </tr>
    <tr>
      <th>1</th>
      <td>fsmt</td>
      <td>FSMTTokenizer</td>
      <td>FSMTForConditionalGeneration</td>
      <td>PASSED</td>
      <td></td>
    </tr>
    <tr>
      <th>2</th>
      <td>marian</td>
      <td>MarianTokenizer</td>
      <td>MarianMTModel</td>
      <td>PASSED</td>
      <td></td>
    </tr>
    <tr>
      <th>3</th>
      <td>t5</td>
      <td>T5TokenizerFast</td>
      <td>T5ForConditionalGeneration</td>
      <td>PASSED</td>
      <td></td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Cleanup">Cleanup<a class="anchor-link" href="#Cleanup"> </a></h2>
</div>
</div>
</div>
</div>
 

