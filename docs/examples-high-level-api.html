---

title: Using the high-level Blurr API


keywords: fastai
sidebar: home_sidebar

summary: "Show all of the high-level `BlurrFor<Task>` classes in action here with the raw data sourced from the <a href='https://Hugging Face.co/docs/datasets/index.html'>Hugging Face Datasets library</a>."
description: "Show all of the high-level `BlurrFor<Task>` classes in action here with the raw data sourced from the <a href='https://Hugging Face.co/docs/datasets/index.html'>Hugging Face Datasets library</a>."
nb_path: "nbs/99a_examples-high-level-api.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/99a_examples-high-level-api.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Here&#39;s what we&#39;re running with ...

Using pytorch 1.7.1
Using fastai 2.4
Using transformers 4.8.1
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Using GPU #1: GeForce GTX 1080 Ti
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The high-level Blurr API provides one liners to build your DataBlock, DataLoaders, and Learner (with sensible defaults) from a DataFrame, CSV file, or a list of dictionaries like we get back from Hugging Face Datasets.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Sequence-Classification">Sequence Classification<a class="anchor-link" href="#Sequence-Classification"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Multiclassification-(one-input)">Multiclassification (one input)<a class="anchor-link" href="#Multiclassification-(one-input)"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;glue&#39;</span><span class="p">,</span> <span class="s1">&#39;cola&#39;</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset glue (/home/wgilliam/.cache/huggingface/datasets/glue/cola/1.0.0/dacbe3125aa31d7f70367a07a8a9e72a5a0bfeb5fc42e75c9db75b96da6053ad)
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>DatasetDict({
    train: Dataset({
        features: [&#39;sentence&#39;, &#39;label&#39;, &#39;idx&#39;],
        num_rows: 8551
    })
    validation: Dataset({
        features: [&#39;sentence&#39;, &#39;label&#39;, &#39;idx&#39;],
        num_rows: 1043
    })
    test: Dataset({
        features: [&#39;sentence&#39;, &#39;label&#39;, &#39;idx&#39;],
        num_rows: 1063
    })
})

{&#39;idx&#39;: 0, &#39;label&#39;: 1, &#39;sentence&#39;: &#34;Our friends won&#39;t buy this analysis, let alone the next one we propose.&#34;}

{&#39;sentence&#39;: Value(dtype=&#39;string&#39;, id=None), &#39;label&#39;: ClassLabel(num_classes=2, names=[&#39;unacceptable&#39;, &#39;acceptable&#39;], names_file=None, id=None), &#39;idx&#39;: Value(dtype=&#39;int32&#39;, id=None)}

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Capture the indexes for both train and validation sets, use the datasets <code>concatenate_datasets</code> to put them into a single dataset, and finally use the <code>IndexSplitter</code> method to define our train/validation splits as such:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_ds</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="c1">#.select(range(10000))</span>
<span class="n">valid_ds</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">]</span><span class="c1">#.select(range(2000))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">n_train</span><span class="p">,</span> <span class="n">n_valid</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">valid_ds</span><span class="o">.</span><span class="n">num_rows</span>
<span class="n">train_idxs</span><span class="p">,</span> <span class="n">valid_idxs</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">)),</span> <span class="n">L</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="n">n_train</span> <span class="o">+</span> <span class="n">n_valid</span><span class="p">))</span>
<span class="n">raw_ds</span> <span class="o">=</span> <span class="n">concatenate_datasets</span><span class="p">([</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">valid_ds</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dl_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bs&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;val_bs&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
<span class="n">learn_kwargs</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">]</span> <span class="p">}</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">BlearnerForSequenceClassification</span><span class="o">.</span><span class="n">from_dictionaries</span><span class="p">(</span><span class="n">raw_ds</span><span class="p">,</span> <span class="s1">&#39;distilroberta-base&#39;</span><span class="p">,</span> 
                                                            <span class="n">text</span><span class="o">=</span><span class="s1">&#39;sentence&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span>
                                                            <span class="n">dblock_splitter</span><span class="o">=</span><span class="n">IndexSplitter</span><span class="p">(</span><span class="n">valid_idxs</span><span class="p">),</span>
                                                            <span class="n">dl_kwargs</span><span class="o">=</span><span class="n">dl_kwargs</span><span class="p">,</span> <span class="n">learner_kwargs</span><span class="o">=</span><span class="n">learn_kwargs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">dataloaders</span><span class="o">=</span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>category</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Everybody who has ever, worked in any office which contained any typewriter which had ever been used to type any letters which had to be signed by any administrator who ever worked in any department like mine will know what I mean.</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Reports the covers of which the government prescribes the height of the lettering on almost always put me to sleep.</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>We talked about the issues we had worked on as students and that our perspectives had changed over the years.</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Paul has interviewed any student who was at the scene of the crime and Kate has interviewed them too.</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">2e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.500305</td>
      <td>0.483770</td>
      <td>0.779482</td>
      <td>01:04</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>category</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Scientists at the South Hanoi Institute of Technology have succeeded in raising one dog with five legs, another with a cow's liver, and a third with no head.</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>The newspaper has reported that they are about to appoint someone, but I can't remember who the newspaper has reported that they are about to appoint.</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Sandy is very anxious to see if the students will be able to solve the homework problem in a particular way, but she won't tell us which.</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Clinton is anxious to find out which budget dilemmas Panetta would be willing to tackle in a certain way, but he won't say in which.</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Harry told Sue that Albania is a lovely place for a vacation, and Tom told Sally that Albania is a lovely place for a vacation.</td>
      <td>1</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Multiclassification-(two-inputs)">Multiclassification (two inputs)<a class="anchor-link" href="#Multiclassification-(two-inputs)"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;glue&#39;</span><span class="p">,</span> <span class="s1">&#39;mrpc&#39;</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset glue (/home/wgilliam/.cache/huggingface/datasets/glue/mrpc/1.0.0/dacbe3125aa31d7f70367a07a8a9e72a5a0bfeb5fc42e75c9db75b96da6053ad)
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>DatasetDict({
    train: Dataset({
        features: [&#39;sentence1&#39;, &#39;sentence2&#39;, &#39;label&#39;, &#39;idx&#39;],
        num_rows: 3668
    })
    validation: Dataset({
        features: [&#39;sentence1&#39;, &#39;sentence2&#39;, &#39;label&#39;, &#39;idx&#39;],
        num_rows: 408
    })
    test: Dataset({
        features: [&#39;sentence1&#39;, &#39;sentence2&#39;, &#39;label&#39;, &#39;idx&#39;],
        num_rows: 1725
    })
})

{&#39;idx&#39;: 0, &#39;label&#39;: 1, &#39;sentence1&#39;: &#39;Amrozi accused his brother , whom he called &#34; the witness &#34; , of deliberately distorting his evidence .&#39;, &#39;sentence2&#39;: &#39;Referring to him as only &#34; the witness &#34; , Amrozi accused his brother of deliberately distorting his evidence .&#39;}

{&#39;sentence1&#39;: Value(dtype=&#39;string&#39;, id=None), &#39;sentence2&#39;: Value(dtype=&#39;string&#39;, id=None), &#39;label&#39;: ClassLabel(num_classes=2, names=[&#39;not_equivalent&#39;, &#39;equivalent&#39;], names_file=None, id=None), &#39;idx&#39;: Value(dtype=&#39;int32&#39;, id=None)}

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Capture the indexes for both train and validation sets, use the datasets <code>concatenate_datasets</code> to put them into a single dataset, and finally use the <code>IndexSplitter</code> method to define our train/validation splits as such:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_ds</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="c1">#.select(range(10000))</span>
<span class="n">valid_ds</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">]</span><span class="c1">#.select(range(2000))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">n_train</span><span class="p">,</span> <span class="n">n_valid</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">valid_ds</span><span class="o">.</span><span class="n">num_rows</span>
<span class="n">train_idxs</span><span class="p">,</span> <span class="n">valid_idxs</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">)),</span> <span class="n">L</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="n">n_train</span> <span class="o">+</span> <span class="n">n_valid</span><span class="p">))</span>
<span class="n">raw_ds</span> <span class="o">=</span> <span class="n">concatenate_datasets</span><span class="p">([</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">valid_ds</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dl_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bs&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;val_bs&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
<span class="n">learn_kwargs</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">F1Score</span><span class="p">(),</span> <span class="n">accuracy</span><span class="p">]</span> <span class="p">}</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">BlearnerForSequenceClassification</span><span class="o">.</span><span class="n">from_dictionaries</span><span class="p">(</span><span class="n">raw_ds</span><span class="p">,</span> <span class="s1">&#39;distilroberta-base&#39;</span><span class="p">,</span> 
                                                            <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sentence1&#39;</span><span class="p">,</span> <span class="s1">&#39;sentence2&#39;</span><span class="p">],</span> 
                                                            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span>
                                                            <span class="n">dblock_splitter</span><span class="o">=</span><span class="n">IndexSplitter</span><span class="p">(</span><span class="n">valid_idxs</span><span class="p">),</span>
                                                            <span class="n">dl_kwargs</span><span class="o">=</span><span class="n">dl_kwargs</span><span class="p">,</span> <span class="n">learner_kwargs</span><span class="o">=</span><span class="n">learn_kwargs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">dataloaders</span><span class="o">=</span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>category</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Amrozi accused his brother, whom he called " the witness ", of deliberately distorting his evidence. Referring to him as only " the witness ", Amrozi accused his brother of deliberately distorting his evidence.</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Then the authority can hold another set of public hearings on raising commuting costs, the judge said. But the judge, Louis York, said the authority can hold another set of public hearings on raising commuting costs afterward.</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>She met Lady Mary at her Double Bay home yesterday to thank her for the donation. She met Lady Mary for the first time at her Double Bay home in Sydney yesterday to thank her in person for the donation.</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>" We disagree with the judge's decision on notice for Engine Company 261, " said a statement by Michael A. Cardozo, the city's corporation counsel. He added that : " We disagree with the judge's decision on notice for Engine Company 261. "</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">2e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>f1_score</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.520961</td>
      <td>0.461445</td>
      <td>0.850318</td>
      <td>0.769608</td>
      <td>00:26</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>category</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>He said the foodservice pie business doesn 't fit the company's long-term growth strategy. " The foodservice pie business does not fit our long-term growth strategy.</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>SPOT products run a Microsoft operating system and the company's DirectBand radio technology developed with SCA Data Systems. The DirectBand network was developed with the assistance of SCA Data Systems.</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Morrill's wife, Ellie, sobbed and hugged Bondeson's sister-in-law during the service. At the service Morrill's widow, Ellie, sobbed and hugged Bondeson's sister-in-law as people consoled her.</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>" But they never climb out of the pot of beer again. " It's just that they never climb out of the beer again. "</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Christina's aunt, Shelley Riling, said the defense's claims were preposterous. Christina's aunt, Shelley Riling, said she will address the court.</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Multilabel-classification">Multilabel classification<a class="anchor-link" href="#Multilabel-classification"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;civil_comments&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Using custom data configuration default
Reusing dataset civil_comments (/home/wgilliam/.cache/huggingface/datasets/civil_comments/default/0.9.0/e7a3aacd2ab7d135fa958e7209d10b1fa03807d44c486e3c34897aa08ea8ffab)
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>DatasetDict({
    train: Dataset({
        features: [&#39;text&#39;, &#39;toxicity&#39;, &#39;severe_toxicity&#39;, &#39;obscene&#39;, &#39;threat&#39;, &#39;insult&#39;, &#39;identity_attack&#39;, &#39;sexual_explicit&#39;],
        num_rows: 1804874
    })
    validation: Dataset({
        features: [&#39;text&#39;, &#39;toxicity&#39;, &#39;severe_toxicity&#39;, &#39;obscene&#39;, &#39;threat&#39;, &#39;insult&#39;, &#39;identity_attack&#39;, &#39;sexual_explicit&#39;],
        num_rows: 97320
    })
    test: Dataset({
        features: [&#39;text&#39;, &#39;toxicity&#39;, &#39;severe_toxicity&#39;, &#39;obscene&#39;, &#39;threat&#39;, &#39;insult&#39;, &#39;identity_attack&#39;, &#39;sexual_explicit&#39;],
        num_rows: 97320
    })
})

{&#39;identity_attack&#39;: 0.0, &#39;insult&#39;: 0.0, &#39;obscene&#39;: 0.0, &#39;severe_toxicity&#39;: 0.0, &#39;sexual_explicit&#39;: 0.0, &#39;text&#39;: &#34;This is so cool. It&#39;s like, &#39;would you want your mother to read this??&#39; Really great idea, well done!&#34;, &#39;threat&#39;: 0.0, &#39;toxicity&#39;: 0.0}

{&#39;text&#39;: Value(dtype=&#39;string&#39;, id=None), &#39;toxicity&#39;: Value(dtype=&#39;float32&#39;, id=None), &#39;severe_toxicity&#39;: Value(dtype=&#39;float32&#39;, id=None), &#39;obscene&#39;: Value(dtype=&#39;float32&#39;, id=None), &#39;threat&#39;: Value(dtype=&#39;float32&#39;, id=None), &#39;insult&#39;: Value(dtype=&#39;float32&#39;, id=None), &#39;identity_attack&#39;: Value(dtype=&#39;float32&#39;, id=None), &#39;sexual_explicit&#39;: Value(dtype=&#39;float32&#39;, id=None)}

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lbl_cols</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;identity_attack&#39;</span><span class="p">,</span> <span class="s1">&#39;insult&#39;</span><span class="p">,</span> <span class="s1">&#39;obscene&#39;</span><span class="p">,</span> <span class="s1">&#39;toxicity&#39;</span><span class="p">,</span> <span class="s1">&#39;severe_toxicity&#39;</span><span class="p">,</span> <span class="s1">&#39;sexual_explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;threat&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_ds</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">))</span>
<span class="n">valid_ds</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Capture the indexes for both train and validation sets, use the datasets <code>concatenate_datasets</code> to put them into a single dataset, and finally use the <code>IndexSplitter</code> method to define our train/validation splits as such:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">n_train</span><span class="p">,</span> <span class="n">n_valid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_ds</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_ds</span><span class="p">)</span>
<span class="n">train_idxs</span><span class="p">,</span> <span class="n">valid_idxs</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">)),</span> <span class="n">L</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="n">n_train</span> <span class="o">+</span> <span class="n">n_valid</span><span class="p">))</span>
<span class="n">raw_ds</span> <span class="o">=</span> <span class="n">concatenate_datasets</span><span class="p">([</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">valid_ds</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The labels need to be OHE as ints (the raw data has them as floats). We could also do this kind of preprocessing by passing in a <code>preprocess_func</code> to our <a href="/blurr/modeling-core.html#BlearnerForSequenceClassification"><code>BlearnerForSequenceClassification</code></a> factory method, especially useful if such preprocessing depends on one or more of the Hugging Face objects (e.g., config, tokenizer, model, architecture)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">make_ohe</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">lbl_cols</span><span class="p">):</span>
            <span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">item</span>

<span class="n">raw_ds</span> <span class="o">=</span> <span class="n">raw_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">make_ohe</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Loading cached processed dataset at /home/wgilliam/.cache/huggingface/datasets/civil_comments/default/0.9.0/e7a3aacd2ab7d135fa958e7209d10b1fa03807d44c486e3c34897aa08ea8ffab/cache-615cf128814440d8.arrow
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dl_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bs&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;val_bs&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
<span class="n">learn_kwargs</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">F1ScoreMulti</span><span class="p">(),</span> <span class="n">accuracy_multi</span><span class="p">]</span> <span class="p">}</span>

<span class="c1"># using a List[dict] such as a Hugging Face dataset</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">BlearnerForSequenceClassification</span><span class="o">.</span><span class="n">from_dictionaries</span><span class="p">(</span><span class="n">raw_ds</span><span class="p">,</span> <span class="s1">&#39;distilroberta-base&#39;</span><span class="p">,</span> 
                                                            <span class="n">text</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lbl_cols</span><span class="p">,</span>
                                                            <span class="n">dblock_splitter</span><span class="o">=</span><span class="n">IndexSplitter</span><span class="p">(</span><span class="n">valid_idxs</span><span class="p">),</span>
                                                            <span class="n">dl_kwargs</span><span class="o">=</span><span class="n">dl_kwargs</span><span class="p">,</span> <span class="n">learner_kwargs</span><span class="o">=</span><span class="n">learn_kwargs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">dataloaders</span><span class="o">=</span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>None</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Predatory patrol towing isn't a big subject, and there is no advocacy group that is paying any attention to it, but the City of Portland has completely backed off of enforcing state law where the towing predators are operating on private property, and this is Commissioner Novick's failure. He's in charge of towing.\n\nThe City has allowed Retriever Towing to operate in open violation of ADA for years at their NW Quimby lot, and there is absolutely no provision in city ordinance that takes into ac</td>
      <td></td>
    </tr>
    <tr>
      <th>1</th>
      <td>Addiction to  legal pharmaceutical opioids like Percocet, Oxycodone, Percodan, are proven to be a direct GATEWAY to heroin use.  Prescription drugs are directly responsible for over 237,000 deaths yearly in the US plus over 5,000 killed due to pharmaceutical intoxicated drivers.  A child is admitted to an emergency room every 9 minutes for prescription drug poisoning the USA.  \n\n\nAlcohol consumption is a direct GATEWAY to domestic violence, traffic fatalities, teen pregnancies and death.  Over</td>
      <td></td>
    </tr>
    <tr>
      <th>2</th>
      <td>I'm sure you've heard the adage: "A lie gone unchallenged becomes the truth in 24 hours." Why would you advocate allowing lies to stand unchallenged, simply because you can deal with them?  Sorry, but I find that level of complacency disgusting.\n\nUnless...  The idea of floating lies is not unique to the Left, but it is a prominent arrow in their quiver and has been used so frequently, that it has permanently altered the political climate for both sides.\n\nObjoke: \n\nQ: How can you tell when a Rep</td>
      <td></td>
    </tr>
    <tr>
      <th>3</th>
      <td>I was one of 60-odd kids who were the first kindergarten class to participate in SI, which at the time was a grand experiment with kids from all walks in across the city. With all the challenges we encountered as the first K-12 SI class, we still find ourselves largely in Portland, well educated, compassionate, independently-minded and engaged people who loved the program we participated in. Many of us refer to SI as a family. For a public education, it was truly one of a kind, and I would hope</td>
      <td></td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">2e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>f1_score</th>
      <th>accuracy_multi</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.029738</td>
      <td>0.041094</td>
      <td>0.165975</td>
      <td>0.987499</td>
      <td>01:14</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/wgilliam/miniconda3/envs/blurr/lib/python3.9/site-packages/sklearn/metrics/_classification.py:1495: UndefinedMetricWarning: F-score is ill-defined and being set to 0.0 in labels with no true nor predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">trun_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/wgilliam/miniconda3/envs/blurr/lib/python3.9/site-packages/sklearn/metrics/_classification.py:1495: UndefinedMetricWarning: F-score is ill-defined and being set to 0.0 in labels with no true nor predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>None</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Everyone tries to hack everyone else.   I have no doubt Russia would try to hack even canada.   However, the US has been doing the same, if we recall Snowden.\n\nEven Merkel's phone conversations were being tapped by the CIA. \n\nThe real purpose of this issue is political.  Trump is upset because people are trying to imply that he didn't deserve his victory, that the Russians helped him.  It's an ego thing.  Good CEOs sometimes have giant egos.  I have no problem with that as long as they produce results, I gladly buy shares in their company.\n\nOtoh, Russia did invade Crimea recently, and their missile brought down a commercial airliner and killed lots of innocent people.  The world has a right to be annoyed at the Russians.\n\nIf you want to find evidence of Russians hacking, you will find them.  But if you want to find China or some guy in a basement somewhere, I have no doubt you can find the same as well.  Whether they succeeded or not, that's hard to prove, but there's lots of blackhats</td>
      <td></td>
      <td>[]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Glad to see, as Canadians we are more and more conscious and aware, of all these abuses from immigration, Trudeau can save travel time and costs if he would have paid attention in the first place, foreign labor and foreign student policies hurting the Canadians (middle-class and families and employees and youth! and disadvantaged disabled, homeless and aboriginals) The bad immigration policy list and abuse, goes on and on and on, it's hard to keep track, write it down people! Now it is high-time for all Canadian politicians to take their heads out of the sand, or wherever they may have them, learn something useful to help Canadians, and put a stop to this abuse, nonsense and madness we have been having with too much immigration, and do their jobs! do what's right. Lot's of attention and resources need to be focused on reducing immigration, fixing our bad policies, limiting foreign labor, etc. etc. it is not even funny! Nothing else matters. 40k per year. McCallum, Barton goodbye thanks</td>
      <td></td>
      <td>[]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Zuri, I mostly agree with you. Yes, i see that many people face those problems. Where our office / internet cafe is in Waianae is the official Homeless Outreach center for the whole Waianae Coast. Most people that want to move into the area shelters have to pass through our office to process the paperwork. So i see first hand the problems. \n.\nBut that "minority" you are referring to, is in fact the majority land owners along the coast, and the people that serve on the neighborhood boards, own businesses and the stores.\n.\nMy point is, at some point this community needs to grab opportunity by the ***** and take control of the community, or someone else eventually will.  That someone will be land developers, or drug dealers, or both. You cant be passive and expect to accomplish great things. I hear all of the time that the people of Waianae want better. Well, EXCELLENT! Lets start with the basics and have the people on the boards and land owners kick out the drug dealers and other trash.</td>
      <td></td>
      <td>[]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Thank you for this article.\nErrata: My father, Dr. James Ford Lewis, was minister of the First Unitarian Church in Portland in '58-'60; he wasn't Portland's "first Unitarian minister." The church was founded here in 1867 (http://bit.ly/29ClQCp).  \nI met Mr. Ellison at Sacramento City College, not at my own university.\nAt PCS, for "Astoria" I am coaching the Shoshoni language, not "Shoshona," which does not exist, and there is no such thing as "Scotch-Canadian patois." The Scots-Canadian accent is what I spoke of. The Iowa, Arikara, Hawaiian languages will also be heard, along with another 10+ accents of English. \nMy work as OnStar's voice began with years of work at General Magic, where I recorded tens of thousands of prompts (rather than "a succession of responses") for a system, not doomed but premature, that supported 2.5 million users at its peak. (http://bit.ly/29Q7P7a).  And I am the longest-working pro voice in *speech recognition,* not in general. That would be some bold claim!</td>
      <td></td>
      <td>[]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>a) President Trump is not threatening to annihilate many countries.  Kim is.\nb) Kim has stated that NK can produce as many hydrogen bombs as it wishes;  there is no reason not to believe him.\nc) NK has tested 2 ICBMs and several intermediate range missiles.\nd) Fascists believe in racial purity, the dominance of the state over the individual, and the use of force to accomplish their goals.  Kim believes that Koreans are racially superior, that the state is superior to the individual and can use any means necessary to control the individual, and Kim believes in the use of force to realize his goals.  Kim is clearly a fascist.\ne) Nominally, Kim is a "communist," but neither he nor the regime has any truck whatsoever with the key element of communism:  "From each according to his ability, to each according to his needs."  Moreover, Kim and the élite have lots of private property which is'streng verboten' under communism.\n\nYou have a fundamental misunderstanding of Kim and NK.\n\nVery sad.</td>
      <td></td>
      <td>[]</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Token-Classification">Token Classification<a class="anchor-link" href="#Token-Classification"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;germeval_14&#39;</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset germ_eval14 (/home/wgilliam/.cache/huggingface/datasets/germ_eval14/germeval_14/2.0.0/0f174b84866aa3b8ebae65c271610520be4422405d7e8467bd24cfd493d325f0)
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>DatasetDict({
    train: Dataset({
        features: [&#39;id&#39;, &#39;source&#39;, &#39;tokens&#39;, &#39;ner_tags&#39;, &#39;nested_ner_tags&#39;],
        num_rows: 24000
    })
    validation: Dataset({
        features: [&#39;id&#39;, &#39;source&#39;, &#39;tokens&#39;, &#39;ner_tags&#39;, &#39;nested_ner_tags&#39;],
        num_rows: 2200
    })
    test: Dataset({
        features: [&#39;id&#39;, &#39;source&#39;, &#39;tokens&#39;, &#39;ner_tags&#39;, &#39;nested_ner_tags&#39;],
        num_rows: 5100
    })
})

{&#39;id&#39;: &#39;0&#39;, &#39;ner_tags&#39;: [19, 0, 0, 0, 7, 0, 0, 0, 0, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], &#39;nested_ner_tags&#39;: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], &#39;source&#39;: &#39;n-tv.de vom 26.02.2005 [2005-02-26] &#39;, &#39;tokens&#39;: [&#39;Schartau&#39;, &#39;sagte&#39;, &#39;dem&#39;, &#39;&#34;&#39;, &#39;Tagesspiegel&#39;, &#39;&#34;&#39;, &#39;vom&#39;, &#39;Freitag&#39;, &#39;,&#39;, &#39;Fischer&#39;, &#39;sei&#39;, &#39;&#34;&#39;, &#39;in&#39;, &#39;einer&#39;, &#39;Weise&#39;, &#39;aufgetreten&#39;, &#39;,&#39;, &#39;die&#39;, &#39;alles&#39;, &#39;andere&#39;, &#39;als&#39;, &#39;überzeugend&#39;, &#39;war&#39;, &#39;&#34;&#39;, &#39;.&#39;]}

{&#39;id&#39;: Value(dtype=&#39;string&#39;, id=None), &#39;source&#39;: Value(dtype=&#39;string&#39;, id=None), &#39;tokens&#39;: Sequence(feature=Value(dtype=&#39;string&#39;, id=None), length=-1, id=None), &#39;ner_tags&#39;: Sequence(feature=ClassLabel(num_classes=25, names=[&#39;O&#39;, &#39;B-LOC&#39;, &#39;I-LOC&#39;, &#39;B-LOCderiv&#39;, &#39;I-LOCderiv&#39;, &#39;B-LOCpart&#39;, &#39;I-LOCpart&#39;, &#39;B-ORG&#39;, &#39;I-ORG&#39;, &#39;B-ORGderiv&#39;, &#39;I-ORGderiv&#39;, &#39;B-ORGpart&#39;, &#39;I-ORGpart&#39;, &#39;B-OTH&#39;, &#39;I-OTH&#39;, &#39;B-OTHderiv&#39;, &#39;I-OTHderiv&#39;, &#39;B-OTHpart&#39;, &#39;I-OTHpart&#39;, &#39;B-PER&#39;, &#39;I-PER&#39;, &#39;B-PERderiv&#39;, &#39;I-PERderiv&#39;, &#39;B-PERpart&#39;, &#39;I-PERpart&#39;], names_file=None, id=None), length=-1, id=None), &#39;nested_ner_tags&#39;: Sequence(feature=ClassLabel(num_classes=25, names=[&#39;O&#39;, &#39;B-LOC&#39;, &#39;I-LOC&#39;, &#39;B-LOCderiv&#39;, &#39;I-LOCderiv&#39;, &#39;B-LOCpart&#39;, &#39;I-LOCpart&#39;, &#39;B-ORG&#39;, &#39;I-ORG&#39;, &#39;B-ORGderiv&#39;, &#39;I-ORGderiv&#39;, &#39;B-ORGpart&#39;, &#39;I-ORGpart&#39;, &#39;B-OTH&#39;, &#39;I-OTH&#39;, &#39;B-OTHderiv&#39;, &#39;I-OTHderiv&#39;, &#39;B-OTHpart&#39;, &#39;I-OTHpart&#39;, &#39;B-PER&#39;, &#39;I-PER&#39;, &#39;B-PERderiv&#39;, &#39;I-PERderiv&#39;, &#39;B-PERpart&#39;, &#39;I-PERpart&#39;], names_file=None, id=None), length=-1, id=None)}

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Capture the indexes for both train and validation sets, use the datasets <code>concatenate_datasets</code> to put them into a single dataset, and finally use the <code>IndexSplitter</code> method to define our train/validation splits as such:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_ds</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="c1">#.select(range(1000))</span>
<span class="n">valid_ds</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">]</span><span class="c1">#.select(range(500))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">n_train</span><span class="p">,</span> <span class="n">n_valid</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">valid_ds</span><span class="o">.</span><span class="n">num_rows</span>
<span class="n">train_idxs</span><span class="p">,</span> <span class="n">valid_idxs</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">)),</span> <span class="n">L</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="n">n_train</span> <span class="o">+</span> <span class="n">n_valid</span><span class="p">))</span>
<span class="n">raw_ds</span> <span class="o">=</span> <span class="n">concatenate_datasets</span><span class="p">([</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">valid_ds</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can grab the "labels" a token can be associated with as we do here or we can let the <a href="/blurr/modeling-token-classification.html#BlearnerForTokenClassification"><code>BlearnerForTokenClassification</code></a> factory methods figure it out for us.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;ner_tags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">names</span>
<span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>25</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As we need pass the tag (not the index) for each example's tokens in a list, we use the handy <code>datasets.map</code> function to create a new attribute, "token_labels", with that data.  This could also be done by passing in a <code>preprocess_func</code>  to a <a href="/blurr/modeling-token-classification.html#BlearnerForTokenClassification"><code>BlearnerForTokenClassification</code></a> factory method; especially useful if we need to use one or more of the Hugging Face objects (e.g., tokenzier, model, config, or architecture name)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_item_labels</span><span class="p">(</span><span class="n">example</span><span class="p">):</span>
    <span class="n">example</span><span class="p">[</span><span class="s1">&#39;token_labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">labels</span><span class="p">[</span><span class="n">tag_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">tag_idx</span> <span class="ow">in</span> <span class="n">example</span><span class="p">[</span><span class="s1">&#39;ner_tags&#39;</span><span class="p">]</span> <span class="p">]</span>
    <span class="k">return</span> <span class="n">example</span>
                         
<span class="n">raw_ds</span> <span class="o">=</span> <span class="n">raw_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">get_item_labels</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">BlearnerForTokenClassification</span><span class="o">.</span><span class="n">from_dictionaries</span><span class="p">(</span><span class="n">raw_ds</span><span class="p">,</span> <span class="s1">&#39;bert-base-multilingual-cased&#39;</span><span class="p">,</span> 
                                                         <span class="n">tokens</span><span class="o">=</span><span class="s1">&#39;tokens&#39;</span><span class="p">,</span> <span class="n">token_labels</span><span class="o">=</span><span class="s1">&#39;token_labels&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                                                         <span class="n">dblock_splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">(),</span> 
                                                         <span class="n">dl_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bs&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>

<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">fit_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">HF_TokenClassMetricsCallback</span><span class="p">()]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">dataloaders</span><span class="o">=</span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>token / target label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>[('Andere', 'O'), ('Albumtitel', 'O'), ('sind', 'O'), ('an', 'O'), ('bekannte', 'O'), ('Begriffe', 'O'), ('angelehnt', 'O'), (':', 'O'), ('Fettes', 'B-OTH'), ('Brot', 'I-OTH'), ('für', 'I-OTH'), ('die', 'I-OTH'), ('Welt', 'I-OTH'), ('(', 'O'), ('Brot', 'O'), ('für', 'O'), ('die', 'O'), ('Welt', 'O'), ('),', 'O'), ('Auf', 'O'), ('einem', 'B-OTH'), ('Auge', 'I-OTH'), ('blöd', 'I-OTH'), ('(', 'I-OTH'), ('„', 'O'), ('Auf', 'O'), ('einem', 'O'), ('Auge', 'O'), ('blind', 'O'), ('),', 'O'), ('Am', 'O'), ('Wasser', 'O'), ('gebaut', 'O'), ('(', 'B-OTH'), ('„', 'I-OTH'), ('Nah', 'I-OTH'), ('am', 'O'), ('Wasser', 'O'), ('gebaut', 'O'), (')', 'O'), ('und', 'O'), ('Strom', 'O'), ('und', 'O'), ('Drang', 'O'), ('(', 'O'), ('„', 'B-OTH'), ('Sturm', 'I-OTH'), ('und', 'I-OTH'), ('Drang', 'O'), (').', 'O')]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>[('Demnach', 'O'), ('kommt', 'O'), ('die', 'O'), ('Staatsoper', 'O'), ('Unter', 'B-LOC'), ('den', 'I-LOC'), ('Linden', 'I-LOC'), ('auf', 'O'), ('72,', 'O'), ('8', 'O'), ('Prozent', 'O'), ('(', 'O'), ('76,', 'O'), ('4', 'O'), ('in', 'O'), ('2003', 'O'), ('),', 'O'), ('die', 'B-ORG'), ('Deutsche', 'I-ORG'), ('Oper', 'O'), ('auf', 'O'), ('64', 'O'), ('Prozent', 'O'), ('(', 'O'), ('61,', 'O'), ('9', 'O'), ('in', 'O'), ('2003', 'O'), (')', 'O'), ('und', 'O'), ('die', 'O'), ('Komische', 'O'), ('Oper', 'O'), ('auf', 'O'), ('52,', 'O'), ('7', 'O'), ('Prozent', 'O'), ('(', 'O'), ('48,', 'O'), ('7', 'O')]</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span> <span class="mf">3e-5</span><span class="p">,</span> <span class="n">moms</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.8</span><span class="p">),</span> <span class="n">cbs</span><span class="o">=</span><span class="n">fit_cbs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.054739</td>
      <td>0.064740</td>
      <td>0.980470</td>
      <td>0.852643</td>
      <td>0.840121</td>
      <td>0.846336</td>
      <td>15:17</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/wgilliam/miniconda3/envs/blurr/lib/python3.9/site-packages/seqeval/metrics/v1.py:57: UndefinedMetricWarning: Recall and F-score are ill-defined and being set to 0.0 in labels with no true samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, msg_start, len(result))
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>token / target label / predicted label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>[('Jetzt', 'O', 'O'), ('noch', 'O', 'O'), ('Gleichgesinnte', 'O', 'O'), ('treffen,', 'O', 'O'), ('das', 'O', 'O'), ('wäre', 'O', 'O'), ('ein', 'O', 'O'), ('sauberer', 'O', 'O'), ('Abschluss', 'O', 'O'), ('und', 'O', 'O')]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>[('Da', 'O', 'O'), ('Intrigen,', 'O', 'O'), ('Verschwörungen', 'O', 'O'), ('und', 'O', 'O'), ('das', 'O', 'O'), ('brutale', 'O', 'O'), ('Verfolgen', 'O', 'O'), ('der', 'O', 'O'), ('eigenen', 'O', 'O'), ('Interessen', 'O', 'O')]</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">token_classification_report</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>              precision    recall  f1-score   support

         LOC       0.91      0.89      0.90      1890
    LOCderiv       0.91      0.86      0.89       664
     LOCpart       0.69      0.75      0.72       118
         ORG       0.78      0.78      0.78      1258
    ORGderiv       0.00      0.00      0.00         0
     ORGpart       0.79      0.71      0.75       200
         OTH       0.70      0.70      0.70       638
    OTHderiv       0.66      0.56      0.61        55
     OTHpart       0.17      0.62      0.27         8
         PER       0.94      0.91      0.92      1739
    PERderiv       0.00      0.00      0.00         0
     PERpart       0.34      0.31      0.33        35

   micro avg       0.85      0.84      0.85      6605
   macro avg       0.57      0.59      0.57      6605
weighted avg       0.86      0.84      0.85      6605

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">txt</span> <span class="o">=</span><span class="s2">&quot;I live in California, but I&#39;d love to travel to Scotland and visit the Macallan distillery.&quot;</span>
<span class="n">txt2</span> <span class="o">=</span> <span class="s2">&quot;Jane Doe loves working for ohmeow.com.&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">blurr_predict_tokens</span><span class="p">([</span><span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">txt2</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">[(</span><span class="n">tok</span><span class="p">,</span> <span class="n">lbl</span><span class="p">)</span> <span class="k">for</span> <span class="n">tok</span><span class="p">,</span><span class="n">lbl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[(&#39;I&#39;, &#39;O&#39;), (&#39;live&#39;, &#39;O&#39;), (&#39;in&#39;, &#39;O&#39;), (&#39;California,&#39;, &#39;B-LOC&#39;), (&#39;but&#39;, &#39;O&#39;), (&#34;I&#39;d&#34;, &#39;O&#39;), (&#39;love&#39;, &#39;O&#39;), (&#39;to&#39;, &#39;O&#39;), (&#39;travel&#39;, &#39;O&#39;), (&#39;to&#39;, &#39;O&#39;), (&#39;Scotland&#39;, &#39;B-LOC&#39;), (&#39;and&#39;, &#39;O&#39;), (&#39;visit&#39;, &#39;O&#39;), (&#39;the&#39;, &#39;O&#39;), (&#39;Macallan&#39;, &#39;B-ORG&#39;), (&#39;distillery.&#39;, &#39;I-ORG&#39;)]

[(&#39;Jane&#39;, &#39;B-PER&#39;), (&#39;Doe&#39;, &#39;I-PER&#39;), (&#39;loves&#39;, &#39;O&#39;), (&#39;working&#39;, &#39;O&#39;), (&#39;for&#39;, &#39;O&#39;), (&#39;ohmeow.com.&#39;, &#39;B-OTH&#39;)]

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Question-Answering">Question Answering<a class="anchor-link" href="#Question-Answering"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;squad_v2&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset squad_v2 (/home/wgilliam/.cache/huggingface/datasets/squad_v2/squad_v2/2.0.0/ba48bc29b974701e9ba8d80ac94f3e3df924aba41b764dcf9851debea7c672e4)
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>DatasetDict({
    train: Dataset({
        features: [&#39;id&#39;, &#39;title&#39;, &#39;context&#39;, &#39;question&#39;, &#39;answers&#39;],
        num_rows: 130319
    })
    validation: Dataset({
        features: [&#39;id&#39;, &#39;title&#39;, &#39;context&#39;, &#39;question&#39;, &#39;answers&#39;],
        num_rows: 11873
    })
})

{&#39;answers&#39;: {&#39;answer_start&#39;: [269], &#39;text&#39;: [&#39;in the late 1990s&#39;]}, &#39;context&#39;: &#39;Beyoncé Giselle Knowles-Carter (/biːˈjɒnseɪ/ bee-YON-say) (born September 4, 1981) is an American singer, songwriter, record producer and actress. Born and raised in Houston, Texas, she performed in various singing and dancing competitions as a child, and rose to fame in the late 1990s as lead singer of R&amp;B girl-group Destiny\&#39;s Child. Managed by her father, Mathew Knowles, the group became one of the world\&#39;s best-selling girl groups of all time. Their hiatus saw the release of Beyoncé\&#39;s debut album, Dangerously in Love (2003), which established her as a solo artist worldwide, earned five Grammy Awards and featured the Billboard Hot 100 number-one singles &#34;Crazy in Love&#34; and &#34;Baby Boy&#34;.&#39;, &#39;id&#39;: &#39;56be85543aeaaa14008c9063&#39;, &#39;question&#39;: &#39;When did Beyonce start becoming popular?&#39;, &#39;title&#39;: &#39;Beyoncé&#39;}

{&#39;id&#39;: Value(dtype=&#39;string&#39;, id=None), &#39;title&#39;: Value(dtype=&#39;string&#39;, id=None), &#39;context&#39;: Value(dtype=&#39;string&#39;, id=None), &#39;question&#39;: Value(dtype=&#39;string&#39;, id=None), &#39;answers&#39;: Sequence(feature={&#39;text&#39;: Value(dtype=&#39;string&#39;, id=None), &#39;answer_start&#39;: Value(dtype=&#39;int32&#39;, id=None)}, length=-1, id=None)}

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_ds</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We use the <code>preprocess_func</code> here as the preprocessing is dependent upon the Hugging Face tokenizer which will vary dependending on the pretrained model we use for the task.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">preprocess_ds</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">,</span> 
                  <span class="n">context</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">tok_ans_start</span><span class="p">,</span> <span class="n">tok_ans_end</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">_preprocess</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
        <span class="n">tok_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="o">.</span><span class="n">padding_side</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">):</span>
            <span class="n">tok_input</span> <span class="o">=</span> <span class="n">hf_tokenizer</span><span class="o">.</span><span class="n">convert_ids_to_tokens</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">question</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="n">context</span><span class="p">]),</span> 
                                                           <span class="o">**</span><span class="n">tok_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tok_input</span> <span class="o">=</span> <span class="n">hf_tokenizer</span><span class="o">.</span><span class="n">convert_ids_to_tokens</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">context</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="n">question</span><span class="p">]),</span> 
                                                           <span class="o">**</span><span class="n">tok_kwargs</span><span class="p">)</span>

        <span class="n">tok_ans</span> <span class="o">=</span> <span class="n">hf_tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;answers&#39;</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="o">**</span><span class="n">tok_kwargs</span><span class="p">)</span>
        
        <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
        
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tok_input</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_seq_len</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tok</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tok_input</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">tok</span> <span class="o">==</span> <span class="n">tok_ans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tok_input</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok_ans</span><span class="p">)]</span> <span class="o">==</span> <span class="n">tok_ans</span><span class="p">):</span> 
                        <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok_ans</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;tokenized_input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tok_input</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;tokenized_input_len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok_input</span><span class="p">)</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;tok_answer_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_idx</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;tok_answer_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_idx</span>

        <span class="k">return</span> <span class="n">item</span>
    
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_preprocess</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pretrained_model_name</span> <span class="o">=</span> <span class="s1">&#39;bert-large-uncased-whole-word-masking-finetuned-squad&#39;</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">BlearnerForQuestionAnswering</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">pretrained_model_name</span><span class="p">,</span>
                                                    <span class="n">preprocess_func</span><span class="o">=</span><span class="n">preprocess_ds</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
                                                    <span class="n">dblock_splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">(),</span> <span class="n">dl_kwargs</span><span class="o">=</span><span class="p">{</span> <span class="s1">&#39;bs&#39;</span><span class="p">:</span> <span class="mi">4</span> <span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">dataloaders</span><span class="o">=</span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>start/end</th>
      <th>answer</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>how many copies of 4 sold in the first week? her fourth studio album 4 was released on june 28, 2011 in the us. 4 sold 310, 000 copies in its first week and debuted atop the billboard 200 chart, giving beyonce her fourth consecutive number - one album in the us. the album was preceded by two of its singles " run the world ( girls ) " and " best thing i never had ", which both attained moderate success. the fourth single " love on top " was a commercial success in the us. 4 also produced four oth</td>
      <td>(31, 34)</td>
      <td>310, 000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>which campaign does beyonce contribute to that encourages leadership in females? in an interview published by vogue in april 2013, beyonce was asked if she considers herself a feminist, to which she said, " that word can be very extreme... but i guess i am a modern - day feminist. i do believe in equality ". she would later align herself more publicly with the movement, sampling " we should all be feminists ", a speech delivered by nigerian author chimamanda ngozi adichie at a tedxeuston confere</td>
      <td>(132, 135)</td>
      <td>ban bossy</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.233430</td>
      <td>1.807422</td>
      <td>00:47</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1.479179</td>
      <td>1.103898</td>
      <td>00:47</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1.053905</td>
      <td>1.113511</td>
      <td>00:47</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>start/end</th>
      <th>answer</th>
      <th>pred start/end</th>
      <th>pred answer</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>how was the single released? on february 6, 2016, one day before her performance at the super bowl, beyonce released a new single exclusively on music streaming service tidal called " formation ".</td>
      <td>(29, 30)</td>
      <td>exclusively</td>
      <td>(29, 35)</td>
      <td>exclusively on music streaming service tidal</td>
    </tr>
    <tr>
      <th>1</th>
      <td>who has beyonce at number one on her five best singer / dancers? beyonce has received praise for her stage presence and voice during live performances. jarett wieselman of the new york post placed her at number one on her list of the five best singer / dancers. according to barbara ellen of the guardian beyonce is the most in - charge female artist she's seen onstage, while alice jones of the independent wrote she " takes her role as entertainer so seriously she's almost too good. " the ex - pre</td>
      <td>(30, 35)</td>
      <td>jarett wieselman</td>
      <td>(30, 35)</td>
      <td>jarett wieselman</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Cleanup">Cleanup<a class="anchor-link" href="#Cleanup"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In summary, whether you want to work with Blurr's low, mid, or high-level API ... we got you covered :)</p>

</div>
</div>
</div>
</div>
 

