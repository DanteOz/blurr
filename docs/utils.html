---

title: utils


keywords: fastai
sidebar: home_sidebar

summary: "Various utility classes and functions used by the `BLURR` library."
description: "Various utility classes and functions used by the `BLURR` library."
nb_path: "nbs/00_utils.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_utils.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Utility-classes-and-methods">Utility classes and methods<a class="anchor-link" href="#Utility-classes-and-methods"> </a></h2><p>The <a href="/blurr/utils.html#Singleton"><code>Singleton</code></a> class and <a href="/blurr/utils.html#str_to_type"><code>str_to_type</code></a> methods are used in the construction of the <code>BLURR</code> instance, as well as, in other parts of the library. <a href="/blurr/utils.html#print_versions"><code>print_versions</code></a> is a nicety added for developers wishing to know what versions of specific libraries are being used for documentation and troubleshooting.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Singleton" class="doc_header"><code>class</code> <code>Singleton</code><a href="https://github.com/ohmeow/blurr/tree/master/blurr/utils.py#L20" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Singleton</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/blurr/utils.html#Singleton"><code>Singleton</code></a> functions as python decorator.  Use this above any class to turn that class into a singleton (see <a href="https://python-3-patterns-idioms-test.readthedocs.io/en/latest/Singleton.html">here</a> for more info on the singleton pattern).</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@Singleton</span>
<span class="k">class</span> <span class="nc">TestSingleton</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="n">a</span> <span class="o">=</span> <span class="n">TestSingleton</span><span class="p">()</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">TestSingleton</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="str_to_type" class="doc_header"><code>str_to_type</code><a href="https://github.com/ohmeow/blurr/tree/master/blurr/utils.py#L31" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>str_to_type</code>(<strong><code>typename</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Converts a type represented as a string to the actual class</p>
<table>
<thead><tr>
<th></th>
<th>Type</th>
<th>Default</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>typename</code></strong></td>
<td><code>str</code></td>
<td></td>
<td><em>No Content</em></td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>How to use:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">str_to_type</span><span class="p">(</span><span class="s2">&quot;test_eq&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">str_to_type</span><span class="p">(</span><span class="s2">&quot;TestSingleton&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>&lt;function test_eq at 0x7fc972f39dc0&gt;
&lt;__main__.Singleton object at 0x7fc92fe3cfa0&gt;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="print_versions" class="doc_header"><code>print_versions</code><a href="https://github.com/ohmeow/blurr/tree/master/blurr/utils.py#L37" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>print_versions</code>(<strong><code>packages</code></strong>:<code>Union</code>[<code>str</code>, List[str]`])</p>
</blockquote>
<p>Prints the name and version of one or more packages in your environment</p>
<table>
<thead><tr>
<th></th>
<th>Type</th>
<th>Default</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>packages</code></strong></td>
<td><code>List[str]]</code></td>
<td></td>
<td>A string of space delimited package names or a list of package names</td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>How to use:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">print_versions</span><span class="p">(</span><span class="s2">&quot;torch transformers fastai&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
<span class="n">print_versions</span><span class="p">([</span><span class="s2">&quot;torch&quot;</span><span class="p">,</span> <span class="s2">&quot;transformers&quot;</span><span class="p">,</span> <span class="s2">&quot;fastai&quot;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>torch: 1.10.1+cu111
transformers: 4.16.2
fastai: 2.5.6
---
torch: 1.10.1+cu111
transformers: 4.16.2
fastai: 2.5.6
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="set_seed" class="doc_header"><code>set_seed</code><a href="https://github.com/fastai/fastai/tree/master/fastai/torch_core.py#L141" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>set_seed</code>(<strong><code>s</code></strong>, <strong><code>reproducible</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Set random seed for <code>random</code>, <code>torch</code>, and <code>numpy</code> (where available)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Loss-functions">Loss functions<a class="anchor-link" href="#Loss-functions"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="PreCalculatedLoss"><a href="/blurr/utils.html#PreCalculatedLoss"><code>PreCalculatedLoss</code></a><a class="anchor-link" href="#PreCalculatedLoss"> </a></h3><p>If you want to let your Hugging Face model calculate the loss for you, make sure you include the <code>labels</code> argument in your inputs and use <a href="/blurr/utils.html#PreCalculatedLoss"><code>PreCalculatedLoss</code></a> as your loss function. Even though we don't really need a loss function per se, we have to provide a custom loss class/function for fastai to function properly (e.g. one with a <code>decodes</code> and <code>activation</code> methods).  Why?  Because these methods will get called in methods like <code>show_results</code> to get the actual predictions.</p>
<p><strong>Note</strong>: The Hugging Face models <strong><em>will always</em></strong> calculate the loss for you <strong><em>if</em></strong> you pass a <code>labels</code> dictionary along with your other inputs (so only include it if that is what you intend to happen)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="PreCalculatedLoss" class="doc_header"><code>class</code> <code>PreCalculatedLoss</code><a href="https://github.com/ohmeow/blurr/tree/master/blurr/utils.py#L69" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>PreCalculatedLoss</code>(<strong><code>loss_cls</code></strong>, <strong>*<code>args</code></strong>, <strong><code>axis</code></strong>=<em><code>-1</code></em>, <strong><code>flatten</code></strong>=<em><code>True</code></em>, <strong><code>floatify</code></strong>=<em><code>False</code></em>, <strong><code>is_2d</code></strong>=<em><code>True</code></em>, <strong>**<code>kwargs</code></strong>) :: <code>BaseLoss</code></p>
</blockquote>
<p>Same as <code>loss_cls</code>, but flattens input and target.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="PreCalculatedCrossEntropyLoss" class="doc_header"><code>class</code> <code>PreCalculatedCrossEntropyLoss</code><a href="https://github.com/ohmeow/blurr/tree/master/blurr/utils.py#L74" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>PreCalculatedCrossEntropyLoss</code>(<strong>*<code>args</code></strong>, <strong><code>axis</code></strong>=<em><code>-1</code></em>, <strong><code>weight</code></strong>=<em><code>None</code></em>, <strong><code>ignore_index</code></strong>=<em><code>-100</code></em>, <strong><code>reduction</code></strong>=<em><code>'mean'</code></em>, <strong><code>flatten</code></strong>=<em><code>True</code></em>, <strong><code>floatify</code></strong>=<em><code>False</code></em>, <strong><code>is_2d</code></strong>=<em><code>True</code></em>) :: <a href="/blurr/utils.html#PreCalculatedLoss"><code>PreCalculatedLoss</code></a></p>
</blockquote>
<p>Same as <code>nn.CrossEntropyLoss</code>, but flattens input and target.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="PreCalculatedBCELoss" class="doc_header"><code>class</code> <code>PreCalculatedBCELoss</code><a href="https://github.com/ohmeow/blurr/tree/master/blurr/utils.py#L78" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>PreCalculatedBCELoss</code>(<strong>*<code>args</code></strong>, <strong><code>axis</code></strong>=<em><code>-1</code></em>, <strong><code>floatify</code></strong>=<em><code>True</code></em>, <strong><code>thresh</code></strong>=<em><code>0.5</code></em>, <strong><code>weight</code></strong>=<em><code>None</code></em>, <strong><code>reduction</code></strong>=<em><code>'mean'</code></em>, <strong><code>pos_weight</code></strong>=<em><code>None</code></em>, <strong><code>flatten</code></strong>=<em><code>True</code></em>, <strong><code>is_2d</code></strong>=<em><code>True</code></em>) :: <a href="/blurr/utils.html#PreCalculatedLoss"><code>PreCalculatedLoss</code></a></p>
</blockquote>
<p>Same as <code>nn.BCEWithLogitsLoss</code>, but flattens input and target.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="PreCalculatedMSELoss" class="doc_header"><code>class</code> <code>PreCalculatedMSELoss</code><a href="https://github.com/ohmeow/blurr/tree/master/blurr/utils.py#L82" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>PreCalculatedMSELoss</code>(<strong>*<code>args</code></strong>, <strong><code>axis</code></strong>=<em><code>-1</code></em>, <strong><code>floatify</code></strong>=<em><code>True</code></em>, <strong>**<code>kwargs</code></strong>) :: <a href="/blurr/utils.html#PreCalculatedLoss"><code>PreCalculatedLoss</code></a></p>
</blockquote>
<p>Same as <code>loss_cls</code>, but flattens input and target.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="MultiTargetLoss"><a href="/blurr/utils.html#MultiTargetLoss"><code>MultiTargetLoss</code></a><a class="anchor-link" href="#MultiTargetLoss"> </a></h3><p>This new loss function can be used in many other multi-modal architectures, with any mix of loss functions.  For example, this can be ammended to include the <code>is_impossible</code> task, as well as the start/end token tasks in the SQUAD v2 dataset (or in any extractive question/answering task)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="MultiTargetLoss" class="doc_header"><code>class</code> <code>MultiTargetLoss</code><a href="https://github.com/ohmeow/blurr/tree/master/blurr/utils.py#L88" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>MultiTargetLoss</code>(<strong><code>loss_classes</code></strong>:<code>List</code>[Callable<code>\]=*</code>[&lt;class 'fastai.losses.CrossEntropyLossFlat'&gt;, &lt;class 'fastai.losses.CrossEntropyLossFlat'&gt;]<code>*, **</code>loss_classes_kwargs<code>**:</code>List<code>\[</code>dict<code>\]=*</code>[{}, {}]<code>*, **</code>weights<code>**:</code>Union<code>\[List[float]</code>, List[int]<code>\]=*</code>[1, 1]<code>*, **</code>reduction<code>**:</code>str<code>=*</code>'mean'<code>*) ::</code>Module`</p>
</blockquote>
<p>Provides the ability to apply different loss functions to multi-modal targets/predictions</p>
<table>
<thead><tr>
<th></th>
<th>Type</th>
<th>Default</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>loss_classes</code></strong></td>
<td><code>Callable]</code></td>
<td><code>(CrossEntropyLossFlat, CrossEntropyLossFlat)</code></td>
<td>The loss function for each target</td>
</tr>
<tr>
<td><strong><code>loss_classes_kwargs</code></strong></td>
<td><code>List[dict]</code></td>
<td><code>({}, {})</code></td>
<td>Any kwargs you want to pass to the loss functions above</td>
</tr>
<tr>
<td><strong><code>weights</code></strong></td>
<td><code>List[int]]</code></td>
<td><code>(1, 1)</code></td>
<td>The weights you want to apply to each loss (default: [1,1])</td>
</tr>
<tr>
<td><strong><code>reduction</code></strong></td>
<td><code>str</code></td>
<td><code>mean</code></td>
<td>The <code>reduction</code> parameter of the lass function (default: 'mean')</td>
</tr>
</tbody>
</table>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Summary">Summary<a class="anchor-link" href="#Summary"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>utils</code> module provides several across-the-board classes and methods used throughout the <code>BLURR</code> library</p>

</div>
</div>
</div>
</div>
 

