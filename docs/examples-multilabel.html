---

title: Multi-label classification


keywords: fastai
sidebar: home_sidebar

summary: "This is an example of how to use blurr for multilabel classification tasks using both the mid and high level Blurr API"
description: "This is an example of how to use blurr for multilabel classification tasks using both the mid and high level Blurr API"
nb_path: "nbs/99d_examples-multilabel.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/99d_examples-multilabel.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Here&#39;s what we&#39;re running with ...

torch: 1.10.1+cu111
fastai: 2.5.3
transformers: 4.16.2
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's start by building our <code>DataBlock</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;civil_comments&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Using custom data configuration default
Reusing dataset civil_comments (/home/wgilliam/.cache/huggingface/datasets/civil_comments/default/0.9.0/e7a3aacd2ab7d135fa958e7209d10b1fa03807d44c486e3c34897aa08ea8ffab)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw_train_df</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">))</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="n">raw_valid_df</span> <span class="o">=</span> <span class="n">raw_datasets</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">))</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

<span class="c1"># --- Option 2: Full dataset (using the predefined training and validation sets) ---</span>
<span class="c1"># raw_train_df = pd.DataFrame(raw_datasets[&#39;train&#39;], columns=list(raw_datasets[&#39;train&#39;].features.keys()))</span>
<span class="c1"># raw_valid_df = pd.DataFrame(raw_datasets[&#39;validation&#39;], columns=list(raw_datasets[&#39;validation&#39;].features.keys()))</span>

<span class="n">raw_train_df</span><span class="p">[</span><span class="s2">&quot;is_valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">raw_valid_df</span><span class="p">[</span><span class="s2">&quot;is_valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">toxic_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">raw_train_df</span><span class="p">,</span> <span class="n">raw_valid_df</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">toxic_df</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>12000
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">toxic_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>identity_attack</th>
      <th>insult</th>
      <th>obscene</th>
      <th>severe_toxicity</th>
      <th>sexual_explicit</th>
      <th>text</th>
      <th>threat</th>
      <th>toxicity</th>
      <th>is_valid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>This is so cool. It's like, 'would you want your mother to read this??' Really great idea, well done!</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>Thank you!! This would make my life a lot less anxiety-inducing. Keep it up, and don't let anyone get in your way!</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>This is such an urgent design problem; kudos to you for taking it on. Very impressive!</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>Is this something I'll be able to install on my site? When will you be releasing it?</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.021277</td>
      <td>0.87234</td>
      <td>0.0</td>
      <td>0.021277</td>
      <td>0.0</td>
      <td>haha you guys are a bunch of losers.</td>
      <td>0.0</td>
      <td>0.893617</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lbl_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;identity_attack&quot;</span><span class="p">,</span> <span class="s2">&quot;insult&quot;</span><span class="p">,</span> <span class="s2">&quot;obscene&quot;</span><span class="p">,</span> <span class="s2">&quot;toxicity&quot;</span><span class="p">,</span> <span class="s2">&quot;severe_toxicity&quot;</span><span class="p">,</span> <span class="s2">&quot;sexual_explicit&quot;</span><span class="p">,</span> <span class="s2">&quot;threat&quot;</span><span class="p">]</span>
<span class="n">lbl_cols</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;identity_attack&#39;,
 &#39;insult&#39;,
 &#39;obscene&#39;,
 &#39;toxicity&#39;,
 &#39;severe_toxicity&#39;,
 &#39;sexual_explicit&#39;,
 &#39;threat&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">toxic_df</span> <span class="o">=</span> <span class="n">toxic_df</span><span class="o">.</span><span class="n">round</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">lbl_cols</span><span class="p">})</span>
<span class="n">toxic_df</span> <span class="o">=</span> <span class="n">toxic_df</span><span class="o">.</span><span class="n">convert_dtypes</span><span class="p">()</span>

<span class="n">toxic_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>identity_attack</th>
      <th>insult</th>
      <th>obscene</th>
      <th>severe_toxicity</th>
      <th>sexual_explicit</th>
      <th>text</th>
      <th>threat</th>
      <th>toxicity</th>
      <th>is_valid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>This is so cool. It's like, 'would you want your mother to read this??' Really great idea, well done!</td>
      <td>0</td>
      <td>0</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>Thank you!! This would make my life a lot less anxiety-inducing. Keep it up, and don't let anyone get in your way!</td>
      <td>0</td>
      <td>0</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>This is such an urgent design problem; kudos to you for taking it on. Very impressive!</td>
      <td>0</td>
      <td>0</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>Is this something I'll be able to install on my site? When will you be releasing it?</td>
      <td>0</td>
      <td>0</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>haha you guys are a bunch of losers.</td>
      <td>0</td>
      <td>1</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Mid-level-API">Mid-level API<a class="anchor-link" href="#Mid-level-API"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-1:-Build-our-Hugging-Face-objects">Step 1: Build our Hugging Face objects<a class="anchor-link" href="#Step-1:-Build-our-Hugging-Face-objects"> </a></h3><p>For our huggingface model, let's used the distilled version of RoBERTa. This should allow us to train the model on bigger mini-batches without much performance loss.  Even on my 1080Ti, I should be able to train all the parameters (which isn't possible with the <code>roberta-base</code> model)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_cls</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span>

<span class="n">pretrained_model_name</span> <span class="o">=</span> <span class="s2">&quot;distilroberta-base&quot;</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">pretrained_model_name</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">num_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lbl_cols</span><span class="p">)</span>

<span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span> <span class="o">=</span> <span class="n">BLURR</span><span class="o">.</span><span class="n">get_hf_objects</span><span class="p">(</span><span class="n">pretrained_model_name</span><span class="p">,</span> <span class="n">model_cls</span><span class="o">=</span><span class="n">model_cls</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="n">hf_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">=</span> <span class="s2">&quot;multi_label_classification&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="n">hf_arch</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_config</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>roberta
&lt;class &#39;transformers.models.roberta.configuration_roberta.RobertaConfig&#39;&gt;
&lt;class &#39;transformers.models.roberta.tokenization_roberta_fast.RobertaTokenizerFast&#39;&gt;
&lt;class &#39;transformers.models.roberta.modeling_roberta.RobertaForSequenceClassification&#39;&gt;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note how we have to configure the <code>num_labels</code> to the number of labels we are predicting. Given that our labels are already encoded, we use a <code>MultiCategoryBlock</code> with encoded=True and vocab equal to the columns with our 1's and 0's.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-2:-Build-our-DataLoaders">Step 2: Build our <code>DataLoaders</code><a class="anchor-link" href="#Step-2:-Build-our-DataLoaders"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">TextBlock</span><span class="p">(</span><span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">),</span> <span class="n">MultiCategoryBlock</span><span class="p">(</span><span class="n">encoded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vocab</span><span class="o">=</span><span class="n">lbl_cols</span><span class="p">))</span>
<span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> <span class="n">get_x</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span> <span class="n">get_y</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="n">lbl_cols</span><span class="p">),</span> <span class="n">splitter</span><span class="o">=</span><span class="n">ColSplitter</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">toxic_df</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">val_bs</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(2, torch.Size([4, 512]), torch.Size([4, 7]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-3:-Build-our-Learner">Step 3: Build our <code>Learner</code><a class="anchor-link" href="#Step-3:-Build-our-Learner"> </a></h3><p>With our DataLoaders built, we can now build our <code>Learner</code> and train.  We'll use mixed precision so we can train with bigger batches</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">BaseModelWrapper</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span>
    <span class="n">dls</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">opt_func</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">Adam</span><span class="p">),</span>
    <span class="n">loss_func</span><span class="o">=</span><span class="n">PreCalculatedBCELoss</span><span class="p">(),</span> <span class="c1"># BCEWithLogitsLossFlat(),</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">partial</span><span class="p">(</span><span class="n">accuracy_multi</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)],</span>
    <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">BaseModelCallback</span><span class="p">],</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">blurr_splitter</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">()</span>

<span class="n">learn</span><span class="o">.</span><span class="n">loss_func</span><span class="o">.</span><span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">preds</span><span class="o">.</span><span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">preds</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([4, 7]),
 SequenceClassifierOutput(loss=TensorMultiCategory(0.7306, device=&#39;cuda:1&#39;, grad_fn=&lt;AliasBackward0&gt;), logits=tensor([[ 0.1651, -0.0486,  0.1606,  0.0890, -0.0652,  0.0174,  0.1820],
         [ 0.1949, -0.0781,  0.1461,  0.0850, -0.0577,  0.0305,  0.1821],
         [ 0.1811, -0.0787,  0.1451,  0.0795, -0.0290,  0.0319,  0.1615],
         [ 0.1804, -0.0760,  0.1438,  0.0824, -0.0140,  0.0327,  0.1537]],
        device=&#39;cuda:1&#39;, grad_fn=&lt;AddmmBackward0&gt;), hidden_states=None, attentions=None))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-4:-Train">Step 4: Train<a class="anchor-link" href="#Step-4:-Train"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "></div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SuggestedLRs(valley=0.005248074419796467)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYIAAAEKCAYAAAAfGVI8AAAAOXRFWHRTb2Z0d2FyZQBNYXRwbG90bGliIHZlcnNpb24zLjUuMSwgaHR0cHM6Ly9tYXRwbG90bGliLm9yZy/YYfK9AAAACXBIWXMAAAsTAAALEwEAmpwYAAArCUlEQVR4nO3deXhU5d3G8e8vyYSQkIQtEAhLCAQh7BhxAYqiglrrWhG1dcNdcan1VbtY69vl7eZateLeWqVIXdBasSpIcYOwE9awBwTClgSSkO15/5hRAyRhAhnOJHN/rmsumDNnZu5hmTvnPOecx5xziIhI5IryOoCIiHhLRSAiEuFUBCIiEU5FICIS4VQEIiIRTkUgIhLhYrwO0FDt27d36enpXscQEWlS5s2bt8M5l1LbY02uCNLT08nJyfE6hohIk2JmG+p6TLuGREQinIpARCTCqQhERCJckxsjEBGpS0VFBfn5+ZSVlXkdxTNxcXF06dIFn88X9HNUBCLSbOTn55OYmEh6ejpm5nWcY845x86dO8nPz6dHjx5BP0+7hkSk2SgrK6Ndu3YRWQIAZka7du0avEUU8UXgnCN3SyEbd5Z4HUVEGkGklsDXjuTzR+yuocqqat7P3cqz/13Hok17AOiTmsjYfqmcM6ATx6UmehtQRJq9Vq1asXfvXtavX8+5557L0qVLPckRkUWwYec+fvj8HDbuKiG9XTy/PK8fFVXVfJC7jcc/Xs1jH60mq1MSFw1N46z+qbT0RVPlHDhIaukjzhft9UcQkcaweAp89BAU5kNyFzj9ARg4zutUx1zEFUFZRRW3/H0+haUVTPrh8ZzetyPRUf5NqetGZlBQvJ/3lnzFG/Pz+dW/lvOrfy0/5DUSW8TQPrEFXdq0JLNDIpkdW5HVKYn+acnfvJaIhLnFU+Cd26Gi1H+/cJP/PhxxGdx333107dqVW2+9FYAHH3yQmJgYZsyYwe7du6moqOBXv/oV559/fp2vUVVVxX333cfMmTPZv38/t956KzfeeCNXXnklF110ERdccAEAV1xxBePGjav3tYJlTW2qyuzsbHc0l5i4/40lvDZnI89flc3pfTvWu27e9mI+X7MTh3+/mwGFpRUUFO+nYO9+Nu4sIW/7XkorqgBoE+9jVO8URh2XwuCubejeNp4oFYPIMbN8+XL69u0b3MqP9Pd/+R8suSvcdWS7aBYsWMCdd97JJ598AkBWVhbTp08nOTmZpKQkduzYwUknncTq1asxs1p3DU2aNInt27fzs5/9jP379zN8+HBef/11Nm7cyCOPPMJbb71FYWEhgwcPZvXq1cTEHPrzfG1/DmY2zzmXXVvuiNoieHNBPq/N2chNo3oetgQAenVIpFeH+scKqqsdm/eUMn/jbj5ZWcDMVQW8tXALAK1axJDVOYlOyXEkt/SR3NJH17bxDEtvS/d28UEN6pRXVlNUVkFRaQXFZZWUVVTROj6WtgmxtIn3ERMd8eP9IkemML9hy4MwZMgQtm/fzpYtWygoKKBNmzakpqZy1113MWvWLKKioti8eTPbtm0jNTW11tf44IMPWLx4MVOnTvXHKSxk9erVjBkzhltuuYWCggL++c9/cvHFF9daAkciYopg1bZifvLGUob1aMuPx/RutNeNijK6to2na9t4zh+cRnW1Y/nWInI3F7F0SyG5W4pYsHEPhaUVFJVV8PUGWEpiC3p3bMXeskp2lZRTWFKBLzqKFjFRtPBFU1ZRRWFpBSXlVfW/v/m3VqIMWsREkxgXQ1Kcv3TatYqlfasWtGsVS1Kcj6SWPhLjYog24+vtwIqqakrLqyitqKK8shozMCA6ymiTEEtKqxZ0SIqjbUIsSXExEX9EhjQjyV3q2CLoclQve8kllzB16lS2bt3KpZdeyt///ncKCgqYN28ePp+P9PT0eg/vdM7xxBNPMHbs2EMeu/LKK3nllVeYPHkyL7744lHlrCliimD26h20iovhz5cNCelP0VFRRr/OyfTrnMw4uh7wWHW1Y03BXuau383c9btYu2MfreNj6dE+geSWPqqco6yimrKKKuJ80bRu6aN1vP8LPCnO/yXeIiaa3SXl7C4pZ9e+ciqrHA5HtfOPfxSXVVJcVsGekgpWb9/L52t3sqekolE+W0yUfZOnVYsY4mOjifNFE23mLxAzYqKM6Cj/rw6orHZUVTla+KLIaN+KXh1akZGSQNe28bRqETH//CQcnf7AgWMEAL6W/uVH4dJLL+X6669nx44dfPLJJ0yZMoUOHTrg8/mYMWMGGzbUeRFQAMaOHcvTTz/N6NGj8fl8rFq1irS0NBISErj66qsZNmwYqampZGVlHVXOmiLmf+K1I3pw8dAuJMcHf9p1Y4uKMjI7JpLZMZHLT+x2zN63sqqavfsrKSqtpKisgmrnMPxf3tFRRnxsNC190cTG+Auy2kFldTW791WwvbiM7UX7a5SPfzdVSXkl+8qr2Lm33F9E1VDtHNXOUVntqKxyRAVePyYqir37K5m2aAs1h6Rax/vo0qYlqUktSU1uQWpSHN3aJZDVKYke7RM08C6h9fWAcCMfNdSvXz+Ki4tJS0ujU6dOXHHFFXzve99jwIABZGdn06dPn3qff91117F+/XqGDh2Kc46UlBTeeustADp27Ejfvn2/GTBuLBE3WCzeKS2vYu2Ovawt2Ef+7lI27ylh065SthWVsbWo7IAtlzhfFH07JXF8tzYc391/65AU52F6aQoaNFjcBJWUlDBgwADmz59PcnJynetpsFjCVsvY6G92m9WmrKKKtQX7WPZVEblbClmSX8hfv9jAc7PXAdC9XTwn9WjHiRltGZHZng6JKgaJHB9++CETJkzgrrvuqrcEjoSKQMJGnC+arM5JZHVO4vvH+wfsyiuryd1SyLwNu/li7S7ez93KP3I2YQaDu7ZmTFYqY/p1pGdKK4/Ti4TWGWeccdjxhSOlIpCwFhsTxZBubRjSrQ3Xjcygutqx7KsiZqzYzgfLtvG791fwu/dX0DMlgTH9UhnbL5WBack6f0OkAVQE0qRERRn905Lpn5bMxNMz2bKnlA+Xb2N67lYmzVrL0zPX0DGpBWdmdWRMVirDe7XXoHOEcc5F9GHORzLuq8FiaTYKSyr4aMU2/rNsGzNXFlBaUcVxHRO575w+nNo7JaK/HCLFunXrSExMjNhLUX89H0FxcfEh8xHUN1isIpBmqayiium5W3n4P6vYsLOEkzPace/ZfRjctbXX0SSENENZ3TOUqQgkYpVXVvPanI089tFqdu0rZ3SfDtxxeiaDVAgSYeorgpBeqMbMzjKzlWaWZ2b31fL4I2a2MHBbZWZ7QplHIk9sTBRXnZLOrP85jXvGHsf8jbs5/8lPue7lHNbv2Od1PJGwELItAjOLBlYBZwL5wFzgMufcsjrWnwgMcc5dW9/raotAjkZxWQUvf7aev3yylvLKam4clcEtp/aiZazmmJDmzastgmFAnnNurXOuHJgM1Hfh7MuA10KYR4TEOB+3jc7k47tHcc6AVJ74OI8zHv6EL9bu9DqaiGdCWQRpQM1L++UHlh3CzLoDPYCP63j8BjPLMbOcgoKCRg8qkadDUhyPjh/C5BtOIjYmisuf/YJH/rOKyqpqr6OJHHPhcjH78cBU51yt11x2zk1yzmU757JTUlKOcTRpzk7KaMc7E0dw4ZAuPPbRai5/9ku27Ck9/BNFmpFQFsFmOOA6zF0Cy2ozHu0WEo+0ahHDn8YN4tFLB5O7pZBzn5jNrFXa8pTIEcoimAtkmlkPM4vF/2U/7eCVzKwP0Ab4PIRZRA7rgiFpTJs4gpRWLbjqxTk8+uEqqqqb1uHVIkciZEXgnKsEbgOmA8uBKc65XDN7yMzOq7HqeGCya2onNEiz1DOlFW/eegoXDk7j0Q9Xc9Mr8yiv1LiBNG86oUykFs45Xvx0PQ+9u4zvDuzE4+OH6JpF0qRpPgKRBjIzrh3Rg6pqx6/fW05LXzS/v3igrmoqzZKKQKQe138ng737K3nso9UkxEbz4Hn9IvJiZtK8qQhEDuPOMzIpKa/k2f+uo0NSHLee1svrSCKNSkUgchhmxk/O6cuOveX8YfpKUpPiuDgwg5pIc6AiEAmCmfG7iweyvbiMe/+5mJTEFnynt05ulOYhXM4sFgl7sTFRPP2D4+nVoRU3vzKPFVuLvI4k0ihUBCINkBTn46VrhhHfIoZb/j6fvfsrvY4kctRUBCINlJocx2PjB7N+xz5++uaSI5ojViScqAhEjsApPdtz1xm9eXvhFl6ds9HrOCJHRUUgcoRuPa0X3+mdwi/fWcbSzYVexxE5YioCkSMUFWU8Mm4QbeNjuWPyAkrLa72KukjYUxGIHIV2rVrwx0sGsaZgH797f4XXcUSOiIpA5CiNyGzPNcPTeemz9ZrHQJokFYFII7j3rD706tCKe6YuYk9JuddxRBpERSDSCOJ80Tx66WB27i3ngbdzvY4j0iAqApFG0j8tmVtP68W0RVuYu36X13FEgqYiEGlEN47KoENiC37z3nKdaCZNhopApBHFx8Zw95jeLNi4h/eWbPU6jkhQVAQijez7x3fluI6J/H76Cs13LE2CikCkkUVHGfef04cNO0t45YsNXscROSwVgUgIjOqdwohe7Xn849UUllZ4HUekXioCkRAw828V7CmpYNKsNV7HEamXikAkRPp1Tua8QZ15YfZ6theVeR1HpE4qApEQ+tGZvamoquaJj/O8jiJSJxWBSAilt09g/LCuvDZnIxt3lngdR6RWKgKRELt9dCYx0cbD/1npdRSRWqkIREKsQ1Ic1w7vwduLtrBsiya8l/CjIhA5Bm4c1ZNWLWJ4/KPVXkcROYSKQOQYSG7p45rhPXg/dysrtmqrQMKLikDkGLl2eDoJsdH8WUcQSZhREYgcI63jY7nqlHT+teQr8rYXex1H5BsqApFj6LqRGbT0aatAwouKQOQYapsQyw9O6s60RVtYt2Of13FEgBAXgZmdZWYrzSzPzO6rY51xZrbMzHLN7NVQ5hEJB9ePzMAXHcWTM7RVIOEhZEVgZtHAk8DZQBZwmZllHbROJnA/MNw51w+4M1R5RMJFSmILLhvWjbcWbGbznlKv44iEdItgGJDnnFvrnCsHJgPnH7TO9cCTzrndAM657SHMIxI2bvhOBgDPzlrrcRKR0BZBGrCpxv38wLKaegO9zexTM/vCzM4KYR6RsNG5dUsuGprGa3M2smPvfq/jSITzerA4BsgETgUuA541s9YHr2RmN5hZjpnlFBQUHNuEIiFy06ielFdV88LsdV5HkQgXyiLYDHStcb9LYFlN+cA051yFc24dsAp/MRzAOTfJOZftnMtOSUkJWWCRYykjpRXn9O/E3z7fQFGZZjET74SyCOYCmWbWw8xigfHAtIPWeQv/1gBm1h7/riLtNJWIcfOpPSneX8nfPtfcxuKdkBWBc64SuA2YDiwHpjjncs3sITM7L7DadGCnmS0DZgD3OOd2hiqTSLjpn5bMqcel8MLsdZSWV3kdRyKUOee8ztAg2dnZLicnx+sYIo0mZ/0uvv+Xz3ng3CyuHdHD6zjSTJnZPOdcdm2PeT1YLBLxstPbclJGW56ZtYb9ldoqkGNPRSASBiaOzmRb0X6mzsv3OopEIBWBSBg4pWc7hnRrzdMz11BRVe11HIkwKgKRMGBmTBzdi/zdpby9cIvXcSTCqAhEwsRpx3Ugq1MST83Io6q6aR3EIU2bikAkTJgZt43uxdod+3h/6Vav40gEURGIhJGx/VJJbxfPpFlraGqHdkvTpSIQCSPRUcZ1IzNYlF/Il+t2eR1HIoSKQCTMfP/4LrRNiGWSLlEtx4iKQCTMxPmiufLk7ny8Yjurt2mSewk9FYFIGLry5HTifFHaKpBjQkUgEobaJsRyyfFdeWvhZrYVlXkdR5o5FYFImLpuZA+qqh0vfKqJayS0VAQiYap7uwTOHtCJV7/YqIlrJKRUBCJh7OZR/olrXvlCE9dI6KgIRMJY/7RkRma254XZ6ymr0CWqJTRUBCJh7uZTe7Jjry5RLaGjIhAJcydntGNw19ZMmrWWSl2iWkJARSAS5syMm0/tycZdJbyni9FJCKgIRJqAM/t2pGdKAk/NyNPF6KTRqQhEmoCoKOOWU3uxYmsxHy3f7nUcaWZUBCJNxHmDO9O1bUue0FaBNDIVgUgT4YuO4uZRvVi0aQ+z83Z4HUeaERWBSBNy8fFppCbF8cTHeV5HkWYkqCIwswQziwr8vreZnWdmvtBGE5GDtYiJ5sZRGcxZt4s5mrhGGkmwWwSzgDgzSwM+AH4IvBSqUCJSt/EndKN9q1h+++/l/GPuRt6Yn8+Mlds1biBHLCbI9cw5V2JmE4CnnHO/N7OFIcwlInVoGRvNzaf24n/fXcaCjXu+Wf6z7/blupEZ3gWTJivoIjCzk4ErgAmBZdGhiSQihzNhRA8uHJJGWUUV5ZXV/OTNJTw9cw2Xn9iN+Nhg/1uL+AW7a+hO4H7gTedcrpllADNClkpEDqttQiydW7ckvX0Cd4/pzc595fz1c12lVBouqCJwzn3inDvPOfe7wKDxDufc7SHOJiJBOr57W0b1TuGZT9awd3+l13GkiQn2qKFXzSzJzBKApcAyM7sntNFEpCHuOrM3u0sqePmz9V5HkSYm2F1DWc65IuAC4N9AD/xHDolImBjctTWn9+nApFlrKdaMZtIAwRaBL3DewAXANOdcBaBj1UTCzF1n9qawtIIXZq/3Ooo0IcEWwTPAeiABmGVm3YGiUIUSkSPTPy2Zsf068tx/17J7X7nXcaSJCHaw+HHnXJpz7hzntwE47XDPM7OzzGylmeWZ2X21PH61mRWY2cLA7boj+AwiUsPdY45jb3klT3+yxuso0kQEO1icbGYPm1lO4PYn/FsH9T0nGngSOBvIAi4zs6xaVv2Hc25w4PZcQz+AiByod8dELhySxsufrWdrYZnXcaQJCHbX0AtAMTAucCsCXjzMc4YBec65tc65cmAycP6RBhWR4N11Rm+qneOxj1Z7HUWagGCLoKdz7heBL/W1zrlfAoc7lz0N2FTjfn5g2cEuNrPFZjbVzLrW9kJmdsPXWyMFBQVBRhaJXF3bxnP5sG5MydnEuh37vI4jYS7YIig1sxFf3zGz4UBpI7z/O0C6c24g8B/g5dpWcs5Ncs5lO+eyU1JSGuFtRZq/20ZnEhsdxZ8+WOl1FAlzwRbBTcCTZrbezNYDfwZuPMxzNgM1f8LvElj2DefcTufc/sDd54Djg8wjIoeRktiCCSN68O7ir1icv8frOBLGgj1qaJFzbhAwEBjonBsCjD7M0+YCmWbWw8xigfHAtJormFmnGnfPA5YHnVxEDuvGURm0TYjlN+8t12WqpU4NmqHMOVcUOMMY4EeHWbcSuA2Yjv8LfkrggnUPmdl5gdVuN7NcM1sE3A5c3aD0IlKvxDgfd5yeyRdrdzFzpcbXpHZ2pD8lmNkm51ytg7uhlJ2d7XJyco7124o0WeWV1fzu9w9xQ8UrdHA7sOQucPoDMHCc19HkGDKzec657NoeO5oLl2s7U6QJiF02lfurnibGBc4pKNwE7wQuHqwyEA6za8jMis2sqJZbMdD5GGUUkaPx0UPEVB10YllFKXz0kDd5JOzUu0XgnEs8VkFEJEQK8xu2XCJOgwaLRaQJSu7SsOUScVQEIs3d6Q+Ar+UBi8qthX+5CCoCkeZv4Dj43uOQ3BUwCmNT+fH+CSxqM8brZBImjuaoIRFpKgaO++YIoaiyCj7740y2vLuM1286GTPzOJx4TVsEIhEmMc7Hj8ccR86G3by7+Cuv40gYUBGIRKBLsruS1SmJ37y3nJLySq/jiMdUBCIRKDrK+OX5/fiqsIynZmgms0inIhCJUCekt+WCwZ2ZNGstG3ZqzoJIpiIQiWD3n9MXX7Txv+8u8zqKeEhFIBLBOibFMfH0TD5cvp0ZK7d7HUc8oiIQiXDXDu9BRvsEfjktl7KKKq/jiAdUBCIRLjYmil+e34/1O0v4yycaOI5EKgIRYWRmCucO7MRTM9ewXpPdRxwVgYgA8PNzs4iNjuKBablhO61lRVU10xZtoaKq2usozYqKQEQA/8Dxj87szaxVBby3ZKvXcWr1n2XbuP21BTz+0WqvozQrKgIR+caVJ3cnq1MSP397KZ/l7fA6ziEW5e8B4KmZa1i4aY+nWZoTFYGIfCMmOoonLh9Cm3gfVzz/JQ9/sJLKMNoNs3RzIT1TEuiY2IK7pyzUUU6NREUgIgfomdKKdyaO4OKhXXj84zwuf+5LissqvI6Fc44l+YUM69GO339/EGsK9vHH6Su9jtUsqAhE5BDxsTH88ZJBPDxuEDnrd/Hbf6/wOhIbd5VQVFbJwC7JjMhszw9O6sbzn67ji7U7vY7W5KkIRKROFw3twnUjM3j1y418via4L9w9JeVc/eIclm0patQsi/MLARiQlgzA/Wf3pVvbeO6esoiiMNhiacpUBCJSr7vO6E16u3jue2MxpeWH3yf/0fLtzFxZwJ3/WMD+yuD24TvneGfRFvaUlNe5ztLNhcRGR9G7YyIACS1ieOTSwWwtKuPBt3OD+zBSKxWBiNSrZWw0/3fxQDbsLOFPHxx+n/zsvB20iIli1ba9PPphcId5Lt1cxMTXFnDH5IV1nsOwOL+QPp0SiY359mtraLc23HZaL95YsJl3F28J7gPJIVQEInJYJ2W044oTu/HCp+uYv3F3nes555idt4Mx/VIZf0JXnvlkTb3rf+39XP9MaZ+sKuCVLzce8nh1tWPplsJvdgvVdNvoXgzq2pqfvrmUrYVlDfhU8jUVgYgE5b6z+9ApuSV3TF5AYWnt++RXbiumoHg/I3u156ff7Uun5Jb8eMqiw+5Sen/pVk7p2Y6Rme35zb+Ws7Zg7wGPb9hVQnFZZa1F4IuO4tFLB1NeWc3dry+kujo8z4oOZyoCEQlKYpyPxy8bwld7yrh36uJad+HMXu0/CW1EZnsS43z84fsDWbtjH797v+6jjvK2F7OmYB9n90/lD98fRGxMFHdNWXTA+QtLNgcGirscWgQAPdon8IvvZfFp3k6embX2aD5mRFIRiEjQju/ehnvP6sP7uVt5+bP1hzw+O28HGSkJdG7dEoBTerXnmuHpvPTZ+jrnO3h/qf9yFmP6pZKaHMevL+zPok17+POMvG/WWZK/h9iYbweKa3PpCV05Z0Aqf/pgpc46biAVgYg0yHUje3BG3w78+r3lLA5c8gFgf2UVX67dxche7Q9Y/96z+tAnNZF7Xl/Mjr37D3m96bnbGNqtNR2T4gA4d2BnLhjcmSc+zmPehl2Af4ugb6ckfNF1f2WZGb+9cCAdk+K4Y/KCsDgJrqlQEYhIg5gZf7xkEB0S47jt1W+/cOdv2ENpRRUjMlMOWD/OF81j44dQVFbB/xy0Syl/dwlLNhdyVv/UA57z0AX96ZQcxx2TF1JYWkHu5iIGpCUdNltyvI9Hxw9m064SHtAhpUFTEYhIg7WOj+XR8YPJ313CLwJfuLPzCoiOMk7KaHvI+selJvKTs/vw8YrtvPjp+m+WT8/dBsDYfgcWQVKcj8fGD+GrwjKufzmH4v2VDExrHVS2E9Lbcvvpmby5YDOv52w6sg8YYVQEInJETkhvy8TRmbyxYDNvLdjM7NU7GNK1NYlxvlrXv+qUdEb36cBD7y7jx68vorCkgulLt9InNZHu7RIOWf/47m24fXQmc9b7dw/1r+WIobpMHJ3JSRlteeDtXFZvKz6yDxhBQloEZnaWma00szwzu6+e9S42M2dm2aHMIyKNa+LoXhzfvQ0/e2spizcXMvyg8YGazIynfzCUW0/ryZsLNnPmI58wd8OuQ3YL1XTraT05Ib0NCbHRZHZsFXSu6CjjsfFDiI+N5tZX5wd1RnQkC1kRmFk08CRwNpAFXGZmWbWslwjcAXwZqiwiEhoxgWP4DXAORmbWXQQALWKiuWdsH96+dThtE2IBOGdAp3pf//mrT+CNW4bXO1Bcm45JcTxy6WBWb9/Lg9M0XlCfUG4RDAPynHNrnXPlwGTg/FrW+1/gd4BOCRRpgrq2jefhSwczuk8HBnVtHdRz+qclM+22EXz0o1H1HhIK/vGC41LrX6cu3+mdwi2n9uQfOZt4Y37+Eb1GJAhlEaQBNUdq8gPLvmFmQ4Guzrl/hTCHiITYmVkdeeHqExr0U3tsTBQZKcHv7jlSd53RmxN7tOUnby5hxdbGvSJqc+HZYLGZRQEPA3cHse4NZpZjZjkFBQWhDycizcbXs64lxvm4+ZX5Or+gFqEsgs1A1xr3uwSWfS0R6A/MNLP1wEnAtNoGjJ1zk5xz2c657JSUlIMfFhGpV4fEOP582RA27irh3n/WfnmMSBbKIpgLZJpZDzOLBcYD075+0DlX6Jxr75xLd86lA18A5znnckKYSUQi1IkZ7bhn7HG8t2Qrz89e53WcsBKyInDOVQK3AdOB5cAU51yumT1kZueF6n1FROpy43cyGJPVkd/+e0XQM65FAmtqm0jZ2dkuJ0cbDSJyZIrLKjj/yU8pLKngnYkjvrlAXnNnZvOcc7Weq6Uzi0UkoiTG+Zj0w2z2V1Zz8yvzKKvQyWYqAhGJOL06tOJP4waxKL+QB95eGvGDxyoCEYlIY/ulMnF0L6bk5PPXzzd4HcdTKgIRiVh3ndGbM/r6L4T3Wd4Or+N4RkUgIhErKsp45NLBZLRP4JZX57NxZ4nXkTyhIhCRiJYY5+O5q7JxDq7/aw5791d6HemYUxGISMTr3i6BJy8fSl7BXm5/bQFV1ZE1eKwiEBEBRmS258Hz+vHxiu389r3lXsc5pmK8DiAiEi5+eFJ31mzfy3Oz19GzQysuG9bN60jHhLYIRERq+Nl3+zKqdwo/f2spn0bIkUQqAhGRGr6+bHXPlFbc9Mo8VkXAnMcqAhGRgyTF+XjhmhOI80VzzYtz2V7cvCdQVBGIiNQirXVLXrz6BHaXlDPhpRxKypvvYaUqAhGROvRPS+aJy4aQu6WQ219bQGVVtdeRQkJFICJSj9P7duSh8/vz4fLt/LyZXqBOh4+KiBzGD07qztbCMv48I4+OSXHceUZvryM1KhWBiEgQ7h7Tm68Ky3j0w9V0TIprVucYqAhERIJgZvzfxQPYsXc/P31zCW0TYhnbL9XrWI1CYwQiIkHyRUfx1BVDGdilNRNfW9Bs5j1WEYiINEBCixhevPoEurWN5/q/5rB0c6HXkY6aikBEpIHaJMTytwnDSG7p4+oX57C2YK/XkY6KikBE5Ah0Sm7JXycMwzn4wXNfsnlPqdeRjpiKQETkCPVMacXL1w6jeH8lVzz7RZO9FIWKQETkKPRPS+ala4axvXg/Vz4/hz0l5V5HajAVgYjIUTq+exuevTKbtTv2ceULcygqq/A6UoOoCEREGsHwXu15+oqhLP+qiKtemNOk5j5WEYiINJLT+3bkicuGsji/kGtfnNtkrliqIhARaURn9U/lsfGDydmwiwkv5VBaXuV1pMNSEYiINLJzB3bm4XGD+XLdTq59aW7Yl4GKQEQkBC4Yksafxg1qEmWgIhARCZELh3Q5oAzCdcxARSAiEkIXDunyzW6iq16YQ3EYHlqqIhARCbELhqTx2PghzN+4hx8+P4fC0vAqAxWBiMgx8L1BnXny8qHkbinkiue+YPe+8DkDOaRFYGZnmdlKM8szs/tqefwmM1tiZgvNbLaZZYUyj4iIl87qn8qkH2azatteLp30OduLwuPaRCErAjOLBp4EzgaygMtq+aJ/1Tk3wDk3GPg98HCo8oiIhIPT+nTgpWtOIH93KZc88zmbdpV4HSmkWwTDgDzn3FrnXDkwGTi/5grOuaIadxMAF8I8IiJh4ZSe7XnluhPZva+ccc98Tt52b+czCGURpAGbatzPDyw7gJndamZr8G8R3F7bC5nZDWaWY2Y5BQUFIQkrInIsDe3Whn/ceDIVVdWMe+ZzFufv8SyL54PFzrknnXM9gXuBn9WxziTnXLZzLjslJeXYBhQRCZG+nZJ4/aZTiI+N5rJJX/Bp3g5PcoSyCDYDXWvc7xJYVpfJwAUhzCMiEnZ6tE/gnzefQpc28Vzz4lzeW/LVMc8QyiKYC2SaWQ8ziwXGA9NqrmBmmTXufhdYHcI8IiJhqWNSHFNuPJkBXZK59dX5/PXz9cf0/UNWBM65SuA2YDqwHJjinMs1s4fM7LzAareZWa6ZLQR+BFwVqjwiIuEsOd7HKxNO5PQ+HXng7Vx+//4KnDs2x8/YsXqjxpKdne1ycnK8jiEiEhKVVdX8/O1cXpuzkYuHduG3Fw0gNubof2Y3s3nOuezaHos56lcXEZFGExMdxW8u7E9qUhyPfLiKbUVlPPWDoSTF+UL2np4fNSQiIgcyM+44I5M/fH8gX6zdySVPf87mPaUhez8VgYhImLokuysvXzuMLXtKufDJT1m6uTAk76MiEBEJY8N7tWfqzacQGxMVsstRaIxARCTMHZeayIc/GkWcLzokr68tAhGRJiBUJQAqAhGRiKciEBGJcCoCEZEIpyIQEYlwKgIRkQinIhARiXAqAhGRCNfkrj5qZgXAhsDdZKCwnt8f/Gt7oKFTANV83WAeO3iZMtafTxkbJ2Ndj4V7xvry1ZartmXKGNzfc3fnXO1TPDrnmuwNmFTf72v5Nedo3iOYxw5epoz151PG0P09N4WM9eWrLY8yHt2/xbpuTX3X0DuH+f3Bvx7tewTz2MHLlPHwz1PG4DT077m25eGWsb58deVRxsMvq+vvuVZNbtfQ0TCzHFfHxAzhQhkbhzI2DmVsHOGesalvETTUJK8DBEEZG4cyNg5lbBxhnTGitghERORQkbZFICIiB1ERiIhEOBWBiEiEUxEEmNlIM/uLmT1nZp95nac2ZhZlZr82syfM7Cqv89TGzE41s/8G/ixP9TpPXcwswcxyzOxcr7PUxsz6Bv4Mp5rZzV7nqY2ZXWBmz5rZP8xsjNd5amNmGWb2vJlN9TrL1wL/9l4O/Nld4XUeaCZFYGYvmNl2M1t60PKzzGylmeWZ2X31vYZz7r/OuZuAd4GXwzEjcD7QBagA8sM0owP2AnFhnBHgXmBKY+drrIzOueWBf4/jgOFhmvEt59z1wE3ApWGaca1zbkJjZztYA7NeBEwN/NmdF+psQWnI2W7hegO+AwwFltZYFg2sATKAWGARkAUMwP9lX/PWocbzpgCJ4ZgRuA+4MfDcqWGaMSrwvI7A38M045nAeOBq4NxwzBh4znnAv4HLwzVj4Hl/AoaGecZG//9yFFnvBwYH1nk1lLmCvTWLyeudc7PMLP2gxcOAPOfcWgAzmwyc75z7LVDr7gAz6wYUOueKwzGjmeUD5YG7VeGYsYbdQItwzBjYZZWA/z9lqZm955yrDqeMgdeZBkwzs38BrzZWvsbKaGYG/B/wb+fc/MbM11gZj5WGZMW/pdwFWEiY7JVpFkVQhzRgU437+cCJh3nOBODFkCU6VEMzvgE8YWYjgVmhDFZDgzKa2UXAWKA18OeQJvtWgzI6534KYGZXAzsaswTq0dA/x1Px70JoAbwXymA1NPTf40TgDCDZzHo55/4SynABDf1zbAf8GhhiZvcHCuNYqSvr48Cfzey7HN2lZRpNcy6CBnPO/cLrDPVxzpXgL6uw5Zx7A39hhT3n3EteZ6iLc24mMNPjGPVyzj2O/0stbDnnduIfwwgbzrl9wDVe56gpLDZLQmQz0LXG/S6BZeFEGRuHMjYOZWxcTSZrcy6CuUCmmfUws1j8g4PTPM50MGVsHMrYOJSxcTWdrF6PVjfGDXgN+IpvD6ucEFh+DrAK/8j9T5VRGZVRGSM9a203XXRORCTCNeddQyIiEgQVgYhIhFMRiIhEOBWBiEiEUxGIiEQ4FYGISIRTEUizYGZ7j/H7NcqcFeafv6HQzBaa2Qoz+2MQz7nAzLIa4/1FQEUgUiszq/c6XM65Uxrx7f7rnBsMDAHONbPDzT9wAf4rp4o0ChWBNFtm1tPM3jezeeafNa1PYPn3zOxLM1tgZh+aWcfA8gfN7G9m9inwt8D9F8xsppmtNbPba7z23sCvpwYenxr4if7vgcszY2bnBJbNM7PHzezd+vI650rxX5o4LfD8681srpktMrN/mlm8mZ2Cf56CPwS2InrW9TlFgqUikOZsEjDROXc88GPgqcDy2cBJzrkhwGTgf2o8Jws4wzl3WeB+H/yX1R4G/MLMfLW8zxDgzsBzM4DhZhYHPAOcHXj/lMOFNbM2QCbfXmL8DefcCc65QcBy/Jct+Az/9Wrucc4Nds6tqedzigRFl6GWZsnMWgGnAK8HfkCHbyfK6QL8w8w64Z85al2Np04L/GT+tX855/YD+81sO/6Z1w6egnOOcy4/8L4LgXT803Wudc59/dqvATfUEXekmS3CXwKPOue2Bpb3N7Nf4Z/boRUwvYGfUyQoKgJprqKAPYF97wd7AnjYOTctMAHMgzUe23fQuvtr/L6K2v/PBLNOff7rnDvXzHoAX5jZFOfcQuAl4ALn3KLAJDqn1vLc+j6nSFC0a0iaJedcEbDOzC4B/7SKZjYo8HAy314X/qoQRVgJZNSYvvCwk7sHth7+D7g3sCgR+CqwO+qKGqsWBx473OcUCYqKQJqLeDPLr3H7Ef4vzwmB3S65+OeLBf8WwOtmNg/YEYowgd1LtwDvB96nGCgM4ql/Ab4TKJCfA18CnwIraqwzGbgnMNjdk7o/p0hQdBlqkRAxs1bOub2Bo4ieBFY75x7xOpfIwbRFIBI61wcGj3Px7456xts4IrXTFoGISITTFoGISIRTEYiIRDgVgYhIhFMRiIhEOBWBiEiEUxGIiES4/weq2ccE8pRU4QAAAABJRU5ErkJggg=="
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.058627</td>
      <td>0.065105</td>
      <td>0.984999</td>
      <td>01:10</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.051616</td>
      <td>0.065715</td>
      <td>0.984999</td>
      <td>02:14</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "></div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Everyone tries to hack everyone else.   I have no doubt Russia would try to hack even canada.   However, the US has been doing the same, if we recall Snowden.\n\nEven Merkel's phone conversations were being tapped by the CIA. \n\nThe real purpose of this issue is political.  Trump is upset because people are trying to imply that he didn't deserve his victory, that the Russians helped him.  It's an ego thing.  Good CEOs sometimes have giant egos.  I have no problem with that as long as they produce results, I gladly buy shares in their company.\n\nOtoh, Russia did invade Crimea recently, and their missile brought down a commercial airliner and killed lots of innocent people.  The world has a right to be annoyed at the Russians.\n\nIf you want to find evidence of Russians hacking, you will find them.  But if you want to find China or some guy in a basement somewhere, I have no doubt you can find the same as well.  Whether they succeeded or not, that's hard to prove, but there's lots of blackhats</td>
      <td>[]</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>And, just as expected, it's quite alright to slag Catholics on these pages.  Civil Comments, yeah sure.\n\n1 poster made a sneering reference is very poor taste 'bout Catholics on another thread, and as predicted, rather than apologizing for something made in poor taste just to slag me, that poster doubled down.  Who me?  No way.  It's the victim who can't take a joke, takes things the wrong way.  It's always that way, that's what bullies do, they blame others, their fault.\n\nEven had another poster rush to his defence.  Wasn't that just precious?  Strength in #s.\n\nCoulds done the proper thing, coulda taken the high road, but no, easier just to feign innocence.\n\nThat's fine, no problem, just hope it's OK to do likewise back at that person, some would say he's a bigot, but I won't go there.  A withdraw woulda sufficed, but apparently it's the Catholics fault.\n\nI guess it's OK to use somebody's religion to make a joke and their fault if they can't take the joke.\n\nPretty low, man, pretty low</td>
      <td>[]</td>
      <td>[]</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">loss_func</span><span class="o">.</span><span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.02</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Those damned affluent white people should only eat their own food, like cod cakes and boiled potatoes. </span>
<span class="s2">No enchiladas for them!</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">learn</span><span class="o">.</span><span class="n">blurr_predict</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[(((#2) [&#39;insult&#39;,&#39;toxicity&#39;],),
  [[False, True, False, True, False, False, False]],
  [[0.0007236572564579546,
    0.028274601325392723,
    0.0050211502239108086,
    0.03941638767719269,
    1.3184367162466515e-06,
    0.0016613906482234597,
    0.00014883848780300468]])]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preds</span><span class="p">,</span> <span class="n">targs</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">with_loss</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">targs</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "></div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([2000, 7]), torch.Size([2000, 7]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="High-level-API">High-level API<a class="anchor-link" href="#High-level-API"> </a></h2><p>With the high-level API, we can create our DataBlock, DataLoaders, and Blearner in one line of code</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-1:-Build-our-Hugging-Face-objects">Step 1: Build our Hugging Face objects<a class="anchor-link" href="#Step-1:-Build-our-Hugging-Face-objects"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_cls</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span>

<span class="n">pretrained_model_name</span> <span class="o">=</span> <span class="s2">&quot;distilroberta-base&quot;</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">pretrained_model_name</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">num_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lbl_cols</span><span class="p">)</span>

<span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span> <span class="o">=</span> <span class="n">BLURR</span><span class="o">.</span><span class="n">get_hf_objects</span><span class="p">(</span><span class="n">pretrained_model_name</span><span class="p">,</span> <span class="n">model_cls</span><span class="o">=</span><span class="n">model_cls</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="n">hf_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">=</span> <span class="s2">&quot;multi_label_classification&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="n">hf_arch</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_config</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>roberta
&lt;class &#39;transformers.models.roberta.configuration_roberta.RobertaConfig&#39;&gt;
&lt;class &#39;transformers.models.roberta.tokenization_roberta_fast.RobertaTokenizerFast&#39;&gt;
&lt;class &#39;transformers.models.roberta.modeling_roberta.RobertaForSequenceClassification&#39;&gt;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-2:-Configure-our-BlearnerForSequenceClassification">Step 2: Configure our <a href="/blurr/modeling-core.html#BlearnerForSequenceClassification"><code>BlearnerForSequenceClassification</code></a><a class="anchor-link" href="#Step-2:-Configure-our-BlearnerForSequenceClassification"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">BlearnerForSequenceClassification</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
    <span class="n">toxic_df</span><span class="p">,</span> <span class="n">pretrained_model_name</span><span class="p">,</span> <span class="n">text_attr</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">label_attr</span><span class="o">=</span><span class="n">lbl_cols</span><span class="p">,</span> <span class="n">dl_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;bs&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">learn</span><span class="o">.</span><span class="n">loss_func</span><span class="o">.</span><span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.02</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-3:-Train">Step 3: Train<a class="anchor-link" href="#Step-3:-Train"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>f1_score</th>
      <th>accuracy_multi</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.041047</td>
      <td>0.066081</td>
      <td>0.000000</td>
      <td>0.984999</td>
      <td>01:04</td>
    </tr>
  </tbody>
</table></div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/wgilliam/miniconda3/envs/blurr/lib/python3.9/site-packages/sklearn/metrics/_classification.py:1580: UndefinedMetricWarning: F-score is ill-defined and being set to 0.0 in labels with no true nor predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, &#34;true nor predicted&#34;, &#34;F-score is&#34;, len(true_sum))
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "></div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/wgilliam/miniconda3/envs/blurr/lib/python3.9/site-packages/sklearn/metrics/_classification.py:1580: UndefinedMetricWarning: F-score is ill-defined and being set to 0.0 in labels with no true nor predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, &#34;true nor predicted&#34;, &#34;F-score is&#34;, len(true_sum))
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Everyone tries to hack everyone else.   I have no doubt Russia would try to hack even canada.   However, the US has been doing the same, if we recall Snowden.\n\nEven Merkel's phone conversations were being tapped by the CIA. \n\nThe real purpose of this issue is political.  Trump is upset because people are trying to imply that he didn't deserve his victory, that the Russians helped him.  It's an ego thing.  Good CEOs sometimes have giant egos.  I have no problem with that as long as they produce results, I gladly buy shares in their company.\n\nOtoh, Russia did invade Crimea recently, and their missile brought down a commercial airliner and killed lots of innocent people.  The world has a right to be annoyed at the Russians.\n\nIf you want to find evidence of Russians hacking, you will find them.  But if you want to find China or some guy in a basement somewhere, I have no doubt you can find the same as well.  Whether they succeeded or not, that's hard to prove, but there's lots of blackhats</td>
      <td>[]</td>
      <td>[insult, toxicity]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Continued...\n\nCat:  Once again it is truly difficult to understand what you are attempting to say by your incoherent comments / gibberish. If you posted in plain English and complete sentences, it might.....might but I cannot say for sure.....help get your points across. \nI don't know why you are so concerned about a market downturn. As you've said, you are mostly and have been for years, in cash. A 30% downturn would not bother me whatsoever. And I doubt that it would bother many true income (dividend / distribution) investors. I can see though how such a decline might scare someone who needs a 10%+ return on their money to pay their bills and who relies solely on trading the market to make those returns. Especially when they won't go short. That wuld scare me too. But for those dividend investors who just cash their dividend cheques / checks or better yet don't need that money and reinvest it and who would benefit from a market decline, share prices don't mean a whole lot.\nSFI</td>
      <td>[]</td>
      <td>[insult, toxicity]</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Those damned affluent white people should only eat their own food, like cod cakes and boiled potatoes. </span>
<span class="s2">No enchiladas for them!</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">learn</span><span class="o">.</span><span class="n">blurr_predict</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[(((#2) [&#39;insult&#39;,&#39;toxicity&#39;],),
  [[False, True, False, True, False, False, False]],
  [[0.0002814286563079804,
    0.034543476998806,
    0.0029982218984514475,
    0.042017482221126556,
    5.5763802464525725e-08,
    0.0013961137738078833,
    1.595290632394608e-05]])]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">preds</span><span class="p">,</span> <span class="n">targs</span><span class="p">,</span> <span class="n">losses</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">with_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">targs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">losses</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "></div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/wgilliam/miniconda3/envs/blurr/lib/python3.9/site-packages/sklearn/metrics/_classification.py:1580: UndefinedMetricWarning: F-score is ill-defined and being set to 0.0 in labels with no true nor predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, &#34;true nor predicted&#34;, &#34;F-score is&#34;, len(true_sum))
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([2000, 7]), torch.Size([2000, 7]), torch.Size([2000]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Low-level-API">Low-level API<a class="anchor-link" href="#Low-level-API"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-1:-Build-our-Hugging-Face-objects">Step 1: Build our Hugging Face objects<a class="anchor-link" href="#Step-1:-Build-our-Hugging-Face-objects"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_cls</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span>

<span class="n">pretrained_model_name</span> <span class="o">=</span> <span class="s2">&quot;distilroberta-base&quot;</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">pretrained_model_name</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">num_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lbl_cols</span><span class="p">)</span>

<span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span> <span class="o">=</span> <span class="n">BLURR</span><span class="o">.</span><span class="n">get_hf_objects</span><span class="p">(</span><span class="n">pretrained_model_name</span><span class="p">,</span> <span class="n">model_cls</span><span class="o">=</span><span class="n">model_cls</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="n">hf_model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">=</span> <span class="s2">&quot;multi_label_classification&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="n">hf_arch</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_config</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>roberta
&lt;class &#39;transformers.models.roberta.configuration_roberta.RobertaConfig&#39;&gt;
&lt;class &#39;transformers.models.roberta.tokenization_roberta_fast.RobertaTokenizerFast&#39;&gt;
&lt;class &#39;transformers.models.roberta.modeling_roberta.RobertaForSequenceClassification&#39;&gt;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-2:-Prepare-your-dataset">Step 2: Prepare your dataset<a class="anchor-link" href="#Step-2:-Prepare-your-dataset"> </a></h3><p>We'll create a <code>labels</code> column that includes the OHE labels for each example. The raw values come in the form of probabilities ranging from 0. to 1., so we simply round those &gt;= .51 to 1.0, else set it to 0. for our purposes here</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">raw_datasets</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;civil_comments&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;train[:1000]&quot;</span><span class="p">,</span> <span class="s2">&quot;validation[:500]&quot;</span><span class="p">])</span>
<span class="n">raw_datasets</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Using custom data configuration default
Reusing dataset civil_comments (/home/wgilliam/.cache/huggingface/datasets/civil_comments/default/0.9.0/e7a3aacd2ab7d135fa958e7209d10b1fa03807d44c486e3c34897aa08ea8ffab)
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[Dataset({
     features: [&#39;identity_attack&#39;, &#39;insult&#39;, &#39;obscene&#39;, &#39;severe_toxicity&#39;, &#39;sexual_explicit&#39;, &#39;text&#39;, &#39;threat&#39;, &#39;toxicity&#39;],
     num_rows: 1000
 }),
 Dataset({
     features: [&#39;identity_attack&#39;, &#39;insult&#39;, &#39;obscene&#39;, &#39;severe_toxicity&#39;, &#39;sexual_explicit&#39;, &#39;text&#39;, &#39;threat&#39;, &#39;toxicity&#39;],
     num_rows: 500
 })]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">tokenize_function</span><span class="p">(</span><span class="n">example</span><span class="p">):</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">hf_tokenizer</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">float</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="n">lbl</span><span class="p">]))</span> <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;identity_attack&quot;</span><span class="p">,</span> <span class="s2">&quot;insult&quot;</span><span class="p">,</span> <span class="s2">&quot;obscene&quot;</span><span class="p">,</span> <span class="s2">&quot;severe_toxicity&quot;</span><span class="p">,</span> <span class="s2">&quot;sexual_explicit&quot;</span><span class="p">,</span> <span class="s2">&quot;threat&quot;</span><span class="p">,</span> <span class="s2">&quot;toxicity&quot;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">targets</span><span class="p">}}</span>


<span class="n">tokenized_datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tokenize_function</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">raw_datasets</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Loading cached processed dataset at /home/wgilliam/.cache/huggingface/datasets/civil_comments/default/0.9.0/e7a3aacd2ab7d135fa958e7209d10b1fa03807d44c486e3c34897aa08ea8ffab/cache-9fafb36afdab0472.arrow
Loading cached processed dataset at /home/wgilliam/.cache/huggingface/datasets/civil_comments/default/0.9.0/e7a3aacd2ab7d135fa958e7209d10b1fa03807d44c486e3c34897aa08ea8ffab/cache-764f62d98456def5.arrow
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-3:-Build-our-DataLoaders">Step 3: Build our <code>DataLoaders</code><a class="anchor-link" href="#Step-3:-Build-our-DataLoaders"> </a></h3><p>By assigning the aforementioned labels to the <code>label_names</code> argument of our <a href="/blurr/data-core.html#BlurrDataLoader"><code>BlurrDataLoader</code></a>s, we get the friendly label printed when we run <code>show_batch</code> or <code>show_results</code> intead of the label's index.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">label_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;identity_attack&quot;</span><span class="p">,</span> <span class="s2">&quot;insult&quot;</span><span class="p">,</span> <span class="s2">&quot;obscene&quot;</span><span class="p">,</span> <span class="s2">&quot;severe_toxicity&quot;</span><span class="p">,</span> <span class="s2">&quot;sexual_explicit&quot;</span><span class="p">,</span> <span class="s2">&quot;threat&quot;</span><span class="p">,</span> <span class="s2">&quot;toxicity&quot;</span><span class="p">]</span>

<span class="n">trn_dl</span> <span class="o">=</span> <span class="n">BlurrDataLoader</span><span class="p">(</span>
    <span class="n">tokenized_datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">hf_arch</span><span class="o">=</span><span class="n">hf_arch</span><span class="p">,</span>
    <span class="n">hf_config</span><span class="o">=</span><span class="n">hf_config</span><span class="p">,</span>
    <span class="n">hf_tokenizer</span><span class="o">=</span><span class="n">hf_tokenizer</span><span class="p">,</span>
    <span class="n">hf_model</span><span class="o">=</span><span class="n">hf_model</span><span class="p">,</span>
    <span class="n">preproccesing_func</span><span class="o">=</span><span class="n">preproc_hf_dataset</span><span class="p">,</span>
    <span class="n">batch_decode_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">label_names</span><span class="p">},</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">val_dl</span> <span class="o">=</span> <span class="n">BlurrDataLoader</span><span class="p">(</span>
    <span class="n">tokenized_datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">hf_arch</span><span class="o">=</span><span class="n">hf_arch</span><span class="p">,</span>
    <span class="n">hf_config</span><span class="o">=</span><span class="n">hf_config</span><span class="p">,</span>
    <span class="n">hf_tokenizer</span><span class="o">=</span><span class="n">hf_tokenizer</span><span class="p">,</span>
    <span class="n">hf_model</span><span class="o">=</span><span class="n">hf_model</span><span class="p">,</span>
    <span class="n">preproccesing_func</span><span class="o">=</span><span class="n">preproc_hf_dataset</span><span class="p">,</span>
    <span class="n">batch_decode_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">label_names</span><span class="p">},</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">dls</span> <span class="o">=</span> <span class="n">DataLoaders</span><span class="p">(</span><span class="n">trn_dl</span><span class="p">,</span> <span class="n">val_dl</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(torch.Size([8, 161]), torch.Size([8, 7]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">dataloaders</span><span class="o">=</span><span class="n">dls</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>These are terrorists.  They  are not people like me.  They are not Oregonians, but invaders from Arizona, Utah, Idaho, Nevada, Ohio, Tennesee, Alabama, and more.  They are used to being chased by the law in their own jurisdictions, not used to being the law.  They are criminals.</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Relentless attempts by liberal pundits to prop-up the notion that we live in a nation deranged and distorted by "White racism" is driven, it seems, by their fear that this ideological (sacred) "cash-cow" is dying, and must be resuscitated at all costs. To use a movie review as an excuse to dredge up what amounts to a liberal conceit, with no basis in reality, is particularly offensive. \n\nSince the'reviewer' raised the issue, it's worth mentioning: while systemic "White-racism" went extinct deca</td>
      <td>[]</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-4:-Train">Step 4: Train<a class="anchor-link" href="#Step-4:-Train"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">BaseModelWrapper</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span>
    <span class="n">dls</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">opt_func</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">Adam</span><span class="p">),</span>
    <span class="n">loss_func</span><span class="o">=</span><span class="n">BCEWithLogitsLossFlat</span><span class="p">(),</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">partial</span><span class="p">(</span><span class="n">accuracy_multi</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)],</span>
    <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">BaseModelCallback</span><span class="p">],</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">blurr_splitter</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">()</span>

<span class="n">learn</span><span class="o">.</span><span class="n">loss_func</span><span class="o">.</span><span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.068528</td>
      <td>0.078455</td>
      <td>0.983714</td>
      <td>00:12</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "></div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>That's why I qualified my allegation with "odds are very good".</td>
      <td>[]</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>If the law forbids him from owning or possessing firearms, why did the court order HPD to give back his weapons after he plead guilty and was convicted of the offense they now say disqualifies him from gun ownership??</td>
      <td>[]</td>
      <td>[]</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Summary">Summary<a class="anchor-link" href="#Summary"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If your sequence classification model isn't training, make sure you have set the <code>num_labels</code> correctly (95% of the time this is the culprit).  And with this example, you can see that Blurr can make both your multiclassification and multilabel classification tasks a breeze.</p>

</div>
</div>
</div>
</div>
 

