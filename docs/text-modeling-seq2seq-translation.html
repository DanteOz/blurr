---

title: text.modeling.seq2seq.translation


keywords: fastai
sidebar: home_sidebar

summary: "This module contains custom models, custom splitters, etc... translation tasks."
description: "This module contains custom models, custom splitters, etc... translation tasks."
nb_path: "nbs/22_text-modeling-seq2seq-translation.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/22_text-modeling-seq2seq-translation.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>What we&#39;re running with at the time this documentation was generated:
torch: 1.10.1+cu111
fastai: 2.5.3
transformers: 4.16.2
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using GPU #</span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">current_device</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Using GPU #1: GeForce GTX 1080 Ti
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Mid-level-API">Mid-level API<a class="anchor-link" href="#Mid-level-API"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Prepare-the-data">Prepare the data<a class="anchor-link" href="#Prepare-the-data"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example">Example<a class="anchor-link" href="#Example"> </a></h3><p>The objective in translation is to generate a representation of a given text in another style. For example, we may want to translate German into English or modern English into old English.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;wmt16&quot;</span><span class="p">,</span> <span class="s2">&quot;de-en&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1200</span><span class="p">))</span>
<span class="n">wmt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;translation&quot;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;de&quot;</span><span class="p">,</span> <span class="s2">&quot;en&quot;</span><span class="p">])</span>
<span class="nb">len</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">)</span>
<span class="n">wmt_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset wmt16 (/home/wgilliam/.cache/huggingface/datasets/wmt16/de-en/1.0.0/af3c5d746b307726d0de73ebe7f10545361b9cb6f75c83a1734c000e48b6264f)
Loading cached shuffled indices for dataset at /home/wgilliam/.cache/huggingface/datasets/wmt16/de-en/1.0.0/af3c5d746b307726d0de73ebe7f10545361b9cb6f75c83a1734c000e48b6264f/cache-8fc54b133c8c43b7.arrow
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>de</th>
      <th>en</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Tada se dio stanovništva preselio uz samu obalu - Pristan, gdje je i nastao Novi grad početkom XX vijeka.</td>
      <td>In that period the majority of the population moved close to the seaside, where the first sea port was founded at the beginning of the 20th century, and later a new city was built.</td>
    </tr>
    <tr>
      <th>1</th>
      <td>"Dieses Video ist nicht verfügbar loger" bitch, daß das Böse, der sein Video auf YouTube hochgeladen hatte nearsyx?</td>
      <td>"This video is no loger available" that evil bitch, who had uploaded his video on youtube nearsyx?</td>
    </tr>
  </tbody>
</table>
</div></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pretrained_model_name</span> <span class="o">=</span> <span class="s2">&quot;Helsinki-NLP/opus-mt-de-en&quot;</span>
<span class="n">model_cls</span> <span class="o">=</span> <span class="n">AutoModelForSeq2SeqLM</span>

<span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span> <span class="o">=</span> <span class="n">NLP</span><span class="o">.</span><span class="n">get_hf_objects</span><span class="p">(</span><span class="n">pretrained_model_name</span><span class="p">,</span> <span class="n">model_cls</span><span class="o">=</span><span class="n">model_cls</span><span class="p">)</span>
<span class="n">hf_arch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_config</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&#39;marian&#39;,
 transformers.models.marian.tokenization_marian.MarianTokenizer,
 transformers.models.marian.configuration_marian.MarianConfig,
 transformers.models.marian.modeling_marian.MarianMTModel)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">Seq2SeqTextBlock</span><span class="p">(</span><span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">),</span> <span class="n">noop</span><span class="p">)</span>
<span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> <span class="n">get_x</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s2">&quot;de&quot;</span><span class="p">),</span> <span class="n">get_y</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s2">&quot;en&quot;</span><span class="p">),</span> <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(2, torch.Size([2, 168]), torch.Size([2, 140]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">dataloaders</span><span class="o">=</span><span class="n">dls</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>"In▁Erwägung▁nachstehender▁Gründe▁sollte das▁Europäische▁Parlament▁keinerlei▁Doppelmoral tolerieren. Indessen und um▁politischen Druck auf▁Journalisten▁auszuüben, die▁Korruptionsfälle aufdecken, die in▁Verbindung mit▁hochrangigen▁Beamten und▁regieren</td>
      <td>'whereas the European Parliament shall not accept double standards; whereas, in order to put political pressure on journalists disclosing corruption cases linked to high-ranking officials and ruling party politicians, the Government administration in</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Der▁Reichtum, die▁Macht und die Illegalität, die durch▁dieses▁versteckte System▁möglich▁gemacht▁werden,▁sind▁mittlerweile so▁umfassend,▁dass▁sie die▁Legitimität der▁Weltwirtschaft▁gefährden;▁insbesondere in▁einer Zeit▁beispielloser▁Einkommensungleich</td>
      <td>The wealth, power, and illegality enabled by this hidden system are now so vast as to threaten the global economys legitimacy, especially at a time of unprecedented income inequality and large budget deficits, owing to governments inability political</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Training">Training<a class="anchor-link" href="#Training"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">seq2seq_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bleu&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;returns&quot;</span><span class="p">:</span> <span class="s2">&quot;bleu&quot;</span><span class="p">},</span> <span class="s2">&quot;meteor&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;returns&quot;</span><span class="p">:</span> <span class="s2">&quot;meteor&quot;</span><span class="p">},</span> <span class="s2">&quot;sacrebleu&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;returns&quot;</span><span class="p">:</span> <span class="s2">&quot;score&quot;</span><span class="p">}}</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">BaseModelWrapper</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>
<span class="n">learn_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">BaseModelCallback</span><span class="p">]</span>
<span class="n">fit_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Seq2SeqMetricsCallback</span><span class="p">(</span><span class="n">custom_metrics</span><span class="o">=</span><span class="n">seq2seq_metrics</span><span class="p">)]</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span>
    <span class="n">dls</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">opt_func</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">Adam</span><span class="p">),</span>
    <span class="n">loss_func</span><span class="o">=</span><span class="n">PreCalculatedCrossEntropyLoss</span><span class="p">(),</span>  <span class="c1"># CrossEntropyLossFlat()</span>
    <span class="n">cbs</span><span class="o">=</span><span class="n">learn_cbs</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">blurr_seq2seq_splitter</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">hf_arch</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># learn = learn.to_native_fp16() #.to_fp16()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[nltk_data] Downloading package wordnet to /home/wgilliam/nltk_data...
[nltk_data]   Package wordnet is already up-to-date!
[nltk_data] Downloading package punkt to /home/wgilliam/nltk_data...
[nltk_data]   Package punkt is already up-to-date!
[nltk_data] Downloading package omw-1.4 to /home/wgilliam/nltk_data...
[nltk_data]   Package omw-1.4 is already up-to-date!
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># learn.summary()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">),</span> <span class="n">preds</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">preds</span><span class="p">[</span><span class="s2">&quot;logits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(4, torch.Size([]), torch.Size([2, 140, 58101]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(2, 3, torch.Size([2, 168]), 2, torch.Size([2, 140]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>3
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">(</span><span class="n">suggest_funcs</span><span class="o">=</span><span class="p">[</span><span class="n">minimum</span><span class="p">,</span> <span class="n">steep</span><span class="p">,</span> <span class="n">valley</span><span class="p">,</span> <span class="n">slide</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "></div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SuggestedLRs(minimum=7.585775847473997e-08, steep=4.786300905834651e-06, valley=0.0003311311302240938, slide=9.120108734350652e-05)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYIAAAEKCAYAAAAfGVI8AAAAOXRFWHRTb2Z0d2FyZQBNYXRwbG90bGliIHZlcnNpb24zLjUuMSwgaHR0cHM6Ly9tYXRwbG90bGliLm9yZy/YYfK9AAAACXBIWXMAAAsTAAALEwEAmpwYAAA08klEQVR4nO3deXxU5bnA8d+TPSEbS0jCEsIW9iUQUUAoiCgKKFYRvVj1qrV2UbDq1d5ai17b2lur4q5V61IrKFoFQetlUVYREnYIEJBASMhC9oSs894/ZhIhJCHbmclknu/nkw8z57xzzvNmyDxzzruJMQallFKey8vVASillHItTQRKKeXhNBEopZSH00SglFIeThOBUkp5OE0ESinl4XxcHUBzdevWzcTGxro6DKWUciuJiYk5xpiI+va5XSKIjY1l+/btrg5DKaXcioikNrRPbw0ppZSH00SglFIeThOBUkp5OLdrI6hPZWUlaWlplJWVuToUtxcQEECvXr3w9fV1dShKKSfpEIkgLS2NkJAQYmNjERFXh+O2jDGcPn2atLQ0+vbt6+pwlFJO0iFuDZWVldG1a1dNAq0kInTt2lWvrJTyMB0iEQCaBNqI/h6Vap++2neKlKxiS47dYRKBO1i+fDlPPfVUo2XS09O54YYbnBSRUsod2GyGX/4ziY+T0iw5fodoI2i23R/CmiegIA3CesG0x2DkjZaf9pprruGaa65ptEyPHj1YtmyZ5bEopdxHXmkFldWGyBB/S47veVcEuz+EFfdBwQnA2P9dcZ99eyscO3aMwYMHc/vttxMXF8f8+fNZvXo1EydOZODAgXz33Xe8/fbb/OpXvwLg9ttv57777mPChAn069ev9sP/2LFjDB8+HIC3336bOXPmMH36dGJjY3nxxRd55plniI+P55JLLiE3NxeAKVOm1I62zsnJoWYKjqa+XinVvmUWlgMQGRpgyfE9LxGseQIqz5y7rfKMfXsrpaSk8MADD5CcnExycjL//Oc/2bhxI08//TR//OMfzyufkZHBxo0b+fzzz3nkkUfqPebevXv55JNP2LZtG7/97W8JCgpix44djB8/nnffffeCMbX29Uop18sssnfg6K6JoI0UNHCPraHtzdC3b19GjBiBl5cXw4YNY9q0aYgII0aM4NixY+eVnzNnDl5eXgwdOpTMzMx6jzl16lRCQkKI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"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">4e-5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">fit_cbs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>bleu</th>
      <th>meteor</th>
      <th>sacrebleu</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.021572</td>
      <td>1.998659</td>
      <td>0.318232</td>
      <td>0.566873</td>
      <td>30.990441</td>
      <td>00:55</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Showing-results">Showing results<a class="anchor-link" href="#Showing-results"> </a></h4><p>And here we create a <code>@typedispatch</code>ed implementation of <code>Learner.show_results</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "></div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>In der▁begrenzten Zeit, die▁mir▁gewährt▁wird, Herr▁Präsident,▁möchte▁ich▁abschließend▁sagen,▁dass▁ich▁daher▁denke,▁dass die▁Europäische Union die▁Forderung der WHO nach▁einer▁fairen▁Verteilung von▁Impfstoffen, zuallererst in den▁Gebieten mit▁hoher▁Sterblichkeit,▁ernsthaft▁unterstützen▁muss und▁dass wir▁auch die▁Bedingungen für private und▁öffentliche▁Partnerschaften▁schaffen und deren▁Entwicklung▁fördern▁müssen, um die▁Impfstoffknappheit in der Welt▁effektiv zu▁bekämpfen.</td>
      <td>In the limited time granted to me, I shall conclude, Mr President, by saying that I therefore think that the European Union must wholeheartedly support the call by the WHO for a fair distribution of vaccines, first and foremost, in the areas of high mortality, and that we must also create the conditions for, and encourage the development of, private and public partnerships so as to effectively combat the shortage of vaccines in the world.</td>
      <td>[In the limited time that I am granted, Mr President, I would like to conclude by saying that I therefore believe that the European Union must give serious support to the call by the WHO for fair distribution of vaccines, first and foremost in areas with high mortality, and that we must also create conditions for private and public partnerships and promote their development in order to effectively combat vaccine shortages in the world., I hope that our amendments will be accepted, because that would also be an opportunity to show the Member States where we want to go at the beginning of the 21st century, namely a common Europe, where all citizens, whatever their nationality, have the same rights and have the same opportunity to build this Europe together.]</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Prediction">Prediction<a class="anchor-link" href="#Prediction"> </a></h4><p>We add here <a href="/blurr/text-modeling-seq2seq-translation.html#Learner.blurr_translate"><code>Learner.blurr_translate</code></a> method to bring the results inline with the format returned via Hugging Face's pipeline method</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_de</span> <span class="o">=</span> <span class="s2">&quot;Ich trinke gerne Bier&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">outputs</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">blurr_generate</span><span class="p">(</span><span class="n">test_de</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;translation_texts&quot;</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">outputs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;translation_texts&#39;: [&#39;I like to drink beer&#39;,
   &#39;I like to drink beer.&#39;,
   &#39;I like to drink beer.&#39;]}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Learner.blurr_translate" class="doc_header"><code>Learner.blurr_translate</code><a href="https://github.com/ohmeow/blurr/tree/master/blurr/text/modeling/seq2seq/translation.py#L29" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.blurr_translate</code>(<strong><code>inp</code></strong>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">blurr_translate</span><span class="p">(</span><span class="n">test_de</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;translation_texts&#39;: [&#39;I like to drink beer&#39;,
   &#39;I like to drink beer.&#39;,
   &#39;I like to drink beer.&#39;]}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Inference">Inference<a class="anchor-link" href="#Inference"> </a></h4><p>Using fast.ai <code>Learner.export</code> and <code>load_learner</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">export_fname</span> <span class="o">=</span> <span class="s2">&quot;translation_export&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">learn</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_fname</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">inf_learn</span> <span class="o">=</span> <span class="n">load_learner</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_fname</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
<span class="n">inf_learn</span><span class="o">.</span><span class="n">blurr_translate</span><span class="p">(</span><span class="n">test_de</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;translation_texts&#39;: &#39;I like to drink beer&#39;}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="High-level-API">High-level API<a class="anchor-link" href="#High-level-API"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="BlearnerForTranslation"><a href="/blurr/text-modeling-seq2seq-translation.html#BlearnerForTranslation"><code>BlearnerForTranslation</code></a><a class="anchor-link" href="#BlearnerForTranslation"> </a></h3><p>We also introduce a task specific <a href="/blurr/text-modeling-core.html#Blearner"><code>Blearner</code></a> that get you your DataBlock, DataLoaders, and BLearner in one line of code!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BlearnerForTranslation" class="doc_header"><code>class</code> <code>BlearnerForTranslation</code><a href="https://github.com/ohmeow/blurr/tree/master/blurr/text/modeling/seq2seq/translation.py#L36" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BlearnerForTranslation</code>(<strong><code>dls</code></strong>:<code>DataLoaders</code>, <strong><code>hf_model</code></strong>:<code>PreTrainedModel</code>, <strong><code>base_model_cb</code></strong>:<a href="/blurr/text-modeling-core.html#BaseModelCallback"><code>BaseModelCallback</code></a>=<em><code>BaseModelCallback</code></em>, <strong><code>loss_func</code></strong>=<em><code>None</code></em>, <strong><code>opt_func</code></strong>=<em><code>Adam</code></em>, <strong><code>lr</code></strong>=<em><code>0.001</code></em>, <strong><code>splitter</code></strong>=<em><code>trainable_params</code></em>, <strong><code>cbs</code></strong>=<em><code>None</code></em>, <strong><code>metrics</code></strong>=<em><code>None</code></em>, <strong><code>path</code></strong>=<em><code>None</code></em>, <strong><code>model_dir</code></strong>=<em><code>'models'</code></em>, <strong><code>wd</code></strong>=<em><code>None</code></em>, <strong><code>wd_bn_bias</code></strong>=<em><code>False</code></em>, <strong><code>train_bn</code></strong>=<em><code>True</code></em>, <strong><code>moms</code></strong>=<em><code>(0.95, 0.85, 0.95)</code></em>) :: <a href="/blurr/text-modeling-core.html#Blearner"><code>Blearner</code></a></p>
</blockquote>
<p>Group together a <code>model</code>, some <code>dls</code> and a <code>loss_func</code> to handle training</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">BlearnerForTranslation</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span>
    <span class="n">wmt_df</span><span class="p">,</span>
    <span class="s2">&quot;Helsinki-NLP/opus-mt-de-en&quot;</span><span class="p">,</span>
    <span class="n">src_lang_name</span><span class="o">=</span><span class="s2">&quot;German&quot;</span><span class="p">,</span>
    <span class="n">src_lang_attr</span><span class="o">=</span><span class="s2">&quot;de&quot;</span><span class="p">,</span>
    <span class="n">trg_lang_name</span><span class="o">=</span><span class="s2">&quot;English&quot;</span><span class="p">,</span>
    <span class="n">trg_lang_attr</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="p">,</span>
    <span class="n">dl_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;bs&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">metrics_cb</span> <span class="o">=</span> <span class="n">BlearnerForTranslation</span><span class="o">.</span><span class="n">get_metrics_cb</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">4e-5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">metrics_cb</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[nltk_data] Downloading package wordnet to /home/wgilliam/nltk_data...
[nltk_data]   Package wordnet is already up-to-date!
[nltk_data] Downloading package punkt to /home/wgilliam/nltk_data...
[nltk_data]   Package punkt is already up-to-date!
[nltk_data] Downloading package omw-1.4 to /home/wgilliam/nltk_data...
[nltk_data]   Package omw-1.4 is already up-to-date!
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>bleu</th>
      <th>meteor</th>
      <th>sacrebleu</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.259140</td>
      <td>2.004386</td>
      <td>0.301326</td>
      <td>0.542822</td>
      <td>28.683969</td>
      <td>00:56</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "></div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>▁Schließen die▁vorgeschlagenen▁Anwendungszwecke▁Empfehlungen über die▁Bekämpfung von oder den▁Schutz▁gegen▁Organismen ein, die▁unter den in der▁vorgesehenen▁Anwendungsregion▁herrschenden▁Bedingungen in▁bezug auf▁Landwirtschaft,▁Pflanzenschutz und Umwelt -▁einschließlich der▁Witterungsverhältnisse - nach den▁Erfahrungen und dem▁wissenschaftlichen▁Erkenntnisstand nicht▁als▁schädlich▁gelten, oder▁ist▁davon▁auszugehen,▁daß die▁anderen▁Wirkungen▁unter▁diesen▁Bedingungen den▁beabsichtigten▁Zweck nicht</td>
      <td>Where relevant, yield response when the product is used and reduction of loss in storage must be quantitatively and/or qualitatively similar to those resulting from the use of suitable reference products. If no suitable reference product exists, the</td>
      <td>[Where the proposed uses include recommendations on the control of or protection against organisms which are not considered harmful under the conditions prevailing in the intended application region in respect of agriculture, plant health and the environment, including climatic conditions, on the basis of experience and scientific knowledge, or where it is assumed that the other effects do not meet the intended purpose under such conditions, no authorisation shall be granted for such uses., This is not intended to deny the importance of traditional energy sources - and I could do so all the less at the moment when Algerian gas reaches Spain and Spain to Portugal and the rest of Europe through such an important construction as the gas pipeline connecting Algeria via Morocco to our continent and our Union, but, of course, the emphasis this report places on renewable and sustainable energy sources and energy saving is very much applauded.]</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_de</span> <span class="o">=</span> <span class="s2">&quot;Ich trinke gerne Bier&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">blurr_translate</span><span class="p">(</span><span class="n">test_de</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;translation_texts&#39;: &#39;I like to drink beer&#39;}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">export_fname</span> <span class="o">=</span> <span class="s2">&quot;translation_export&quot;</span>

<span class="n">learn</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">to_fp32</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_fname</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>

<span class="n">inf_learn</span> <span class="o">=</span> <span class="n">load_learner</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_fname</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
<span class="n">inf_learn</span><span class="o">.</span><span class="n">blurr_generate</span><span class="p">(</span><span class="n">test_de</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;generated_texts&#39;: &#39;I like to drink beer&#39;}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tests">Tests<a class="anchor-link" href="#Tests"> </a></h2><p>The purpose of the following tests is to ensure as much as possible, that the core training code works for the pretrained <strong>translation models</strong> below.  These tests are excluded from the CI workflow because of how long they would take to run and the amount of data that would be required to download.</p>
<p><strong>Note</strong>: Feel free to modify the code below to test whatever pretrained summarization models you are working with ... and if any of your pretrained translation models fail, please submit a github issue <em>(or a PR if you'd like to fix it yourself)</em></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">del</span> <span class="n">learn</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span><span class="n">model_type</span> <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="n">NLP</span><span class="o">.</span><span class="n">get_models</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="s2">&quot;ConditionalGeneration&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">model_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">))]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;BartForConditionalGeneration&#39;,
 &#39;BigBirdPegasusForConditionalGeneration&#39;,
 &#39;BlenderbotForConditionalGeneration&#39;,
 &#39;BlenderbotSmallForConditionalGeneration&#39;,
 &#39;FSMTForConditionalGeneration&#39;,
 &#39;LEDForConditionalGeneration&#39;,
 &#39;M2M100ForConditionalGeneration&#39;,
 &#39;MBartForConditionalGeneration&#39;,
 &#39;MT5ForConditionalGeneration&#39;,
 &#39;PegasusForConditionalGeneration&#39;,
 &#39;ProphetNetForConditionalGeneration&#39;,
 &#39;Speech2TextForConditionalGeneration&#39;,
 &#39;T5ForConditionalGeneration&#39;,
 &#39;XLMProphetNetForConditionalGeneration&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pretrained_model_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;facebook/bart-base&quot;</span><span class="p">,</span>
    <span class="s2">&quot;facebook/wmt19-de-en&quot;</span><span class="p">,</span>  <span class="c1"># FSMT</span>
    <span class="s2">&quot;Helsinki-NLP/opus-mt-de-en&quot;</span><span class="p">,</span>  <span class="c1"># MarianMT</span>
    <span class="c1">#&#39;sshleifer/tiny-mbart&#39;,</span>
    <span class="c1">#&#39;google/mt5-small&#39;,</span>
    <span class="s2">&quot;t5-small&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;wmt16&quot;</span><span class="p">,</span> <span class="s2">&quot;de-en&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1200</span><span class="p">))</span>
<span class="n">wmt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;translation&quot;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;de&quot;</span><span class="p">,</span> <span class="s2">&quot;en&quot;</span><span class="p">])</span>
<span class="nb">len</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset wmt16 (/home/wgilliam/.cache/huggingface/datasets/wmt16/de-en/1.0.0/af3c5d746b307726d0de73ebe7f10545361b9cb6f75c83a1734c000e48b6264f)
Loading cached shuffled indices for dataset at /home/wgilliam/.cache/huggingface/datasets/wmt16/de-en/1.0.0/af3c5d746b307726d0de73ebe7f10545361b9cb6f75c83a1734c000e48b6264f/cache-8fc54b133c8c43b7.arrow
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>1200</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># hide_output</span>
<span class="n">model_cls</span> <span class="o">=</span> <span class="n">AutoModelForSeq2SeqLM</span>
<span class="n">bsz</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">inp_seq_sz</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">trg_seq_sz</span> <span class="o">=</span> <span class="mi">128</span>

<span class="n">test_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">pretrained_model_names</span><span class="p">:</span>
    <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">hf_tok_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;sshleifer/tiny-mbart&quot;</span><span class="p">:</span>
        <span class="n">hf_tok_kwargs</span><span class="p">[</span><span class="s2">&quot;src_lang&quot;</span><span class="p">],</span> <span class="n">hf_tok_kwargs</span><span class="p">[</span><span class="s2">&quot;tgt_lang&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;de_DE&quot;</span><span class="p">,</span> <span class="s2">&quot;en_XX&quot;</span>

    <span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span> <span class="o">=</span> <span class="n">NLP</span><span class="o">.</span><span class="n">get_hf_objects</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_cls</span><span class="o">=</span><span class="n">model_cls</span><span class="p">,</span> <span class="n">tokenizer_kwargs</span><span class="o">=</span><span class="n">hf_tok_kwargs</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;architecture:</span><span class="se">\t</span><span class="si">{</span><span class="n">hf_arch</span><span class="si">}</span><span class="se">\n</span><span class="s2">tokenizer:</span><span class="se">\t</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s2">model:</span><span class="se">\t\t</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 1. build your DataBlock</span>
    <span class="n">text_gen_kwargs</span> <span class="o">=</span> <span class="n">default_text_gen_kwargs</span><span class="p">(</span><span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s2">&quot;translation&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_t5_prefix</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;translate German to English: </span><span class="si">{</span><span class="n">inp</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">hf_arch</span> <span class="o">==</span> <span class="s2">&quot;t5&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">inp</span>

    <span class="n">batch_tokenize_tfm</span> <span class="o">=</span> <span class="n">Seq2SeqBatchTokenizeTransform</span><span class="p">(</span>
        <span class="n">hf_arch</span><span class="p">,</span>
        <span class="n">hf_config</span><span class="p">,</span>
        <span class="n">hf_tokenizer</span><span class="p">,</span>
        <span class="n">hf_model</span><span class="p">,</span>
        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="n">inp_seq_sz</span><span class="p">,</span>
        <span class="n">max_target_length</span><span class="o">=</span><span class="n">trg_seq_sz</span><span class="p">,</span>
        <span class="n">text_gen_kwargs</span><span class="o">=</span><span class="n">text_gen_kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">Seq2SeqTextBlock</span><span class="p">(</span><span class="n">batch_tokenize_tfm</span><span class="o">=</span><span class="n">batch_tokenize_tfm</span><span class="p">),</span> <span class="n">noop</span><span class="p">)</span>
    <span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> <span class="n">get_x</span><span class="o">=</span><span class="n">Pipeline</span><span class="p">([</span><span class="n">ColReader</span><span class="p">(</span><span class="s2">&quot;de&quot;</span><span class="p">),</span> <span class="n">add_t5_prefix</span><span class="p">]),</span> <span class="n">get_y</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s2">&quot;en&quot;</span><span class="p">),</span> <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">())</span>

    <span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bsz</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>

    <span class="c1"># 2. build your Learner</span>
    <span class="n">seq2seq_metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">BaseModelWrapper</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>
    <span class="n">fit_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ShortEpochCallback</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">short_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">Seq2SeqMetricsCallback</span><span class="p">(</span><span class="n">custom_metrics</span><span class="o">=</span><span class="n">seq2seq_metrics</span><span class="p">)]</span>

    <span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span>
        <span class="n">dls</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">opt_func</span><span class="o">=</span><span class="n">ranger</span><span class="p">,</span>
        <span class="n">loss_func</span><span class="o">=</span><span class="n">PreCalculatedCrossEntropyLoss</span><span class="p">(),</span>
        <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">BaseModelCallback</span><span class="p">],</span>
        <span class="n">splitter</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">blurr_seq2seq_splitter</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">hf_arch</span><span class="p">),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">()</span>

    <span class="n">learn</span><span class="o">.</span><span class="n">create_opt</span><span class="p">()</span>
    <span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>

    <span class="c1"># 3. Run your tests</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** TESTING DataLoaders ***</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]),</span> <span class="n">bsz</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">bsz</span><span class="p">,</span> <span class="n">inp_seq_sz</span><span class="p">]))</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">bsz</span><span class="p">)</span>

        <span class="c1">#         print(&#39;*** TESTING One pass through the model ***&#39;)</span>
        <span class="c1">#         preds = learn.model(b[0])</span>
        <span class="c1">#         test_eq(preds[1].shape[0], bsz)</span>
        <span class="c1">#         test_eq(preds[1].shape[2], hf_config.vocab_size)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** TESTING Training/Results ***&quot;</span><span class="p">)</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">fit_cbs</span><span class="p">)</span>

        <span class="n">test_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">hf_arch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;PASSED&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">test_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">hf_arch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># cleanup</span>
        <span class="k">del</span> <span class="n">learn</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>arch</th>
      <th>tokenizer</th>
      <th>model_name</th>
      <th>result</th>
      <th>error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>bart</td>
      <td>BartTokenizerFast</td>
      <td>BartForConditionalGeneration</td>
      <td>PASSED</td>
      <td></td>
    </tr>
    <tr>
      <th>1</th>
      <td>fsmt</td>
      <td>FSMTTokenizer</td>
      <td>FSMTForConditionalGeneration</td>
      <td>PASSED</td>
      <td></td>
    </tr>
    <tr>
      <th>2</th>
      <td>marian</td>
      <td>MarianTokenizer</td>
      <td>MarianMTModel</td>
      <td>PASSED</td>
      <td></td>
    </tr>
    <tr>
      <th>3</th>
      <td>t5</td>
      <td>T5TokenizerFast</td>
      <td>T5ForConditionalGeneration</td>
      <td>PASSED</td>
      <td></td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Summary">Summary<a class="anchor-link" href="#Summary"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This module includes the fundamental bits to use Blurr for translation tasks training and inference.</p>

</div>
</div>
</div>
</div>
 

