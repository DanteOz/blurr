---

title: text.modeling.seq2seq.translation


keywords: fastai
sidebar: home_sidebar

summary: "This module contains custom models, custom splitters, etc... translation tasks."
description: "This module contains custom models, custom splitters, etc... translation tasks."
nb_path: "nbs/22_text-modeling-seq2seq-translation.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/22_text-modeling-seq2seq-translation.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>What we&#39;re running with at the time this documentation was generated:
torch: 1.10.1+cu111
fastai: 2.5.6
transformers: 4.16.2
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using GPU #</span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">current_device</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Using GPU #1: GeForce GTX 1080 Ti
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Mid-level-API">Mid-level API<a class="anchor-link" href="#Mid-level-API"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Prepare-the-data">Prepare the data<a class="anchor-link" href="#Prepare-the-data"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example">Example<a class="anchor-link" href="#Example"> </a></h3><p>The objective in translation is to generate a representation of a given text in another style. For example, we may want to translate German into English or modern English into old English.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;wmt16&quot;</span><span class="p">,</span> <span class="s2">&quot;de-en&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1200</span><span class="p">))</span>
<span class="n">wmt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;translation&quot;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;de&quot;</span><span class="p">,</span> <span class="s2">&quot;en&quot;</span><span class="p">])</span>
<span class="nb">len</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">)</span>
<span class="n">wmt_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset wmt16 (/home/wgilliam/.cache/huggingface/datasets/wmt16/de-en/1.0.0/af3c5d746b307726d0de73ebe7f10545361b9cb6f75c83a1734c000e48b6264f)
Loading cached shuffled indices for dataset at /home/wgilliam/.cache/huggingface/datasets/wmt16/de-en/1.0.0/af3c5d746b307726d0de73ebe7f10545361b9cb6f75c83a1734c000e48b6264f/cache-8fc54b133c8c43b7.arrow
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>de</th>
      <th>en</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Tada se dio stanovništva preselio uz samu obalu - Pristan, gdje je i nastao Novi grad početkom XX vijeka.</td>
      <td>In that period the majority of the population moved close to the seaside, where the first sea port was founded at the beginning of the 20th century, and later a new city was built.</td>
    </tr>
    <tr>
      <th>1</th>
      <td>"Dieses Video ist nicht verfügbar loger" bitch, daß das Böse, der sein Video auf YouTube hochgeladen hatte nearsyx?</td>
      <td>"This video is no loger available" that evil bitch, who had uploaded his video on youtube nearsyx?</td>
    </tr>
  </tbody>
</table>
</div></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pretrained_model_name</span> <span class="o">=</span> <span class="s2">&quot;Helsinki-NLP/opus-mt-de-en&quot;</span>
<span class="n">model_cls</span> <span class="o">=</span> <span class="n">AutoModelForSeq2SeqLM</span>

<span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span> <span class="o">=</span> <span class="n">NLP</span><span class="o">.</span><span class="n">get_hf_objects</span><span class="p">(</span><span class="n">pretrained_model_name</span><span class="p">,</span> <span class="n">model_cls</span><span class="o">=</span><span class="n">model_cls</span><span class="p">)</span>
<span class="n">hf_arch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_config</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&#39;marian&#39;,
 transformers.models.marian.tokenization_marian.MarianTokenizer,
 transformers.models.marian.configuration_marian.MarianConfig,
 transformers.models.marian.modeling_marian.MarianMTModel)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">Seq2SeqTextBlock</span><span class="p">(</span><span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">),</span> <span class="n">noop</span><span class="p">)</span>
<span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> <span class="n">get_x</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s2">&quot;de&quot;</span><span class="p">),</span> <span class="n">get_y</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s2">&quot;en&quot;</span><span class="p">),</span> <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(2, torch.Size([2, 168]), torch.Size([2, 140]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">dataloaders</span><span class="o">=</span><span class="n">dls</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>"In▁Erwägung▁nachstehender▁Gründe▁sollte das▁Europäische▁Parlament▁keinerlei▁Doppelmoral tolerieren. Indessen und um▁politischen Druck auf▁Journalisten▁auszuüben, die▁Korruptionsfälle aufdecken, die in▁Verbindung mit▁hochrangigen▁Beamten und▁regieren</td>
      <td>'whereas the European Parliament shall not accept double standards; whereas, in order to put political pressure on journalists disclosing corruption cases linked to high-ranking officials and ruling party politicians, the Government administration in</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Die Oberligamannschaft Empor▁Lauter wurde 1954 nach Rostock▁delegiert und bestritt am▁14. November 1954 vor 17 000▁Zuschauern▁gegen Chemie Karl-Marx-Stadt (0:0) das▁erste Oberligapunktspiel im▁Ostseestadion. Die▁Gründung des FC Hansa Rostock▁fand▁dan</td>
      <td>Bundesliga, was founded on December 28, 1965, when the football department of SC Empor was made independent of their parent sports club under a government sanctioned program that would groom young talent and provide the East German (DDR) national tea</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Training">Training<a class="anchor-link" href="#Training"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">seq2seq_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bleu&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;returns&quot;</span><span class="p">:</span> <span class="s2">&quot;bleu&quot;</span><span class="p">},</span> <span class="s2">&quot;meteor&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;returns&quot;</span><span class="p">:</span> <span class="s2">&quot;meteor&quot;</span><span class="p">},</span> <span class="s2">&quot;sacrebleu&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;returns&quot;</span><span class="p">:</span> <span class="s2">&quot;score&quot;</span><span class="p">}}</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">BaseModelWrapper</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>
<span class="n">learn_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">BaseModelCallback</span><span class="p">]</span>
<span class="n">fit_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Seq2SeqMetricsCallback</span><span class="p">(</span><span class="n">custom_metrics</span><span class="o">=</span><span class="n">seq2seq_metrics</span><span class="p">)]</span>

<span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span>
    <span class="n">dls</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">opt_func</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">Adam</span><span class="p">),</span>
    <span class="n">loss_func</span><span class="o">=</span><span class="n">PreCalculatedCrossEntropyLoss</span><span class="p">(),</span>  <span class="c1"># CrossEntropyLossFlat()</span>
    <span class="n">cbs</span><span class="o">=</span><span class="n">learn_cbs</span><span class="p">,</span>
    <span class="n">splitter</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">blurr_seq2seq_splitter</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">hf_arch</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># learn = learn.to_native_fp16() #.to_fp16()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[nltk_data] Downloading package wordnet to /home/wgilliam/nltk_data...
[nltk_data]   Package wordnet is already up-to-date!
[nltk_data] Downloading package punkt to /home/wgilliam/nltk_data...
[nltk_data]   Package punkt is already up-to-date!
[nltk_data] Downloading package omw-1.4 to /home/wgilliam/nltk_data...
[nltk_data]   Package omw-1.4 is already up-to-date!
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">),</span> <span class="n">preds</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">preds</span><span class="p">[</span><span class="s2">&quot;logits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(4, torch.Size([]), torch.Size([2, 140, 58101]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(2, 3, torch.Size([2, 168]), 2, torch.Size([2, 140]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>3
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">(</span><span class="n">suggest_funcs</span><span class="o">=</span><span class="p">[</span><span class="n">minimum</span><span class="p">,</span> <span class="n">steep</span><span class="p">,</span> <span class="n">valley</span><span class="p">,</span> <span class="n">slide</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "></div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SuggestedLRs(minimum=6.309573450380412e-08, steep=1.0964781722577754e-06, valley=0.0003981071640737355, slide=1.4454397387453355e-05)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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"
>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">4e-5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">fit_cbs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>bleu</th>
      <th>meteor</th>
      <th>sacrebleu</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.066144</td>
      <td>2.020720</td>
      <td>0.294544</td>
      <td>0.547619</td>
      <td>28.638813</td>
      <td>00:56</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Showing-results">Showing results<a class="anchor-link" href="#Showing-results"> </a></h4><p>And here we create a <code>@typedispatch</code>ed implementation of <code>Learner.show_results</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "></div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Die Messe Frankfurt hat im▁Jahr 2006 in▁Kooperation mit Stylepark ein▁neues und▁bisher so▁noch nicht▁existierendes Format▁etabliert: The Design Annual.Bei The Design Annual▁handelt es sich um eine▁jährlich▁stattfindende Veranstaltung für High-End Design, die Frankfurt am Main▁auch 2008▁wieder zum Zentrum des▁internationalen Designgeschehens▁werden▁lässt. In der▁Frankfurter Festhalle▁präsentieren die▁beiden Partner die▁besten▁Hersteller des High-End Designsegments▁aus den▁Bereichen▁Möbel und▁Auße</td>
      <td>In 2006, Messe Frankfurt in cooperation with Stylepark established a new and quite unprecedented format for a trade fair, namely The Design Annual.</td>
      <td>[Messe Frankfurt established a new format in 2006 in cooperation with Stylepark: The Design Annual.The Design Annual is an annual high-end design event that will once again make Frankfurt the centre of international design in 2008. In the Frankfurt Festhalle, the two partners will present the best manufacturers of the high-end design segment in the areas of furniture and outdoor furniture, textiles and floor coverings, bathroom and kitchens, office furniture, lighting, accessories, cutlery, electrical installations and home entertainment., If there are eggs that are not legally produced after January 2012, these eggs must not be marketed, and if there is evidence of non-compliance with the provision, the Commission could, of course, take all the measures it is entitled to under the current legal framework - and initiate infringement procedures to ensure that EU legislation is properly implemented.]</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Prediction">Prediction<a class="anchor-link" href="#Prediction"> </a></h4><p>We add here <a href="/blurr/text-modeling-seq2seq-translation.html#Learner.blurr_translate"><code>Learner.blurr_translate</code></a> method to bring the results inline with the format returned via Hugging Face's pipeline method</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_de</span> <span class="o">=</span> <span class="s2">&quot;Ich trinke gerne Bier&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">outputs</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">blurr_generate</span><span class="p">(</span><span class="n">test_de</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;translation_texts&quot;</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">outputs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;translation_texts&#39;: [&#39;I like to drink beer&#39;,
   &#39;I like to drink beer.&#39;,
   &#39;I like to drink&#39;]}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Learner.blurr_translate" class="doc_header"><code>Learner.blurr_translate</code><a href="https://github.com/ohmeow/blurr/tree/master/blurr/text/modeling/seq2seq/translation.py#L29" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.blurr_translate</code>(<strong><code>inp</code></strong>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">blurr_translate</span><span class="p">(</span><span class="n">test_de</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;translation_texts&#39;: [&#39;I like to drink beer&#39;,
   &#39;I like to drink beer.&#39;,
   &#39;I like to drink&#39;]}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Inference">Inference<a class="anchor-link" href="#Inference"> </a></h4><p>Using fast.ai <code>Learner.export</code> and <code>load_learner</code></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">export_fname</span> <span class="o">=</span> <span class="s2">&quot;translation_export&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">learn</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_fname</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">inf_learn</span> <span class="o">=</span> <span class="n">load_learner</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_fname</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
<span class="n">inf_learn</span><span class="o">.</span><span class="n">blurr_translate</span><span class="p">(</span><span class="n">test_de</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;translation_texts&#39;: &#39;I like to drink beer&#39;}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="High-level-API">High-level API<a class="anchor-link" href="#High-level-API"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="BlearnerForTranslation"><a href="/blurr/text-modeling-seq2seq-translation.html#BlearnerForTranslation"><code>BlearnerForTranslation</code></a><a class="anchor-link" href="#BlearnerForTranslation"> </a></h3><p>We also introduce a task specific <a href="/blurr/text-modeling-core.html#Blearner"><code>Blearner</code></a> that get you your DataBlock, DataLoaders, and BLearner in one line of code!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BlearnerForTranslation" class="doc_header"><code>class</code> <code>BlearnerForTranslation</code><a href="https://github.com/ohmeow/blurr/tree/master/blurr/text/modeling/seq2seq/translation.py#L36" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BlearnerForTranslation</code>(<strong><code>dls</code></strong>:<code>DataLoaders</code>, <strong><code>hf_model</code></strong>:<code>PreTrainedModel</code>, <strong><code>base_model_cb</code></strong>:<a href="/blurr/text-modeling-core.html#BaseModelCallback"><code>BaseModelCallback</code></a>=<em><code>BaseModelCallback</code></em>, <strong><code>loss_func</code></strong>=<em><code>None</code></em>, <strong><code>opt_func</code></strong>=<em><code>Adam</code></em>, <strong><code>lr</code></strong>=<em><code>0.001</code></em>, <strong><code>splitter</code></strong>=<em><code>trainable_params</code></em>, <strong><code>cbs</code></strong>=<em><code>None</code></em>, <strong><code>metrics</code></strong>=<em><code>None</code></em>, <strong><code>path</code></strong>=<em><code>None</code></em>, <strong><code>model_dir</code></strong>=<em><code>'models'</code></em>, <strong><code>wd</code></strong>=<em><code>None</code></em>, <strong><code>wd_bn_bias</code></strong>=<em><code>False</code></em>, <strong><code>train_bn</code></strong>=<em><code>True</code></em>, <strong><code>moms</code></strong>=<em><code>(0.95, 0.85, 0.95)</code></em>) :: <a href="/blurr/text-modeling-core.html#Blearner"><code>Blearner</code></a></p>
</blockquote>
<p>Group together a <code>model</code>, some <code>dls</code> and a <code>loss_func</code> to handle training</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">BlearnerForTranslation</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span>
    <span class="n">wmt_df</span><span class="p">,</span>
    <span class="s2">&quot;Helsinki-NLP/opus-mt-de-en&quot;</span><span class="p">,</span>
    <span class="n">src_lang_name</span><span class="o">=</span><span class="s2">&quot;German&quot;</span><span class="p">,</span>
    <span class="n">src_lang_attr</span><span class="o">=</span><span class="s2">&quot;de&quot;</span><span class="p">,</span>
    <span class="n">trg_lang_name</span><span class="o">=</span><span class="s2">&quot;English&quot;</span><span class="p">,</span>
    <span class="n">trg_lang_attr</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="p">,</span>
    <span class="n">dl_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;bs&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">metrics_cb</span> <span class="o">=</span> <span class="n">BlearnerForTranslation</span><span class="o">.</span><span class="n">get_metrics_cb</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">4e-5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">metrics_cb</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[nltk_data] Downloading package wordnet to /home/wgilliam/nltk_data...
[nltk_data]   Package wordnet is already up-to-date!
[nltk_data] Downloading package punkt to /home/wgilliam/nltk_data...
[nltk_data]   Package punkt is already up-to-date!
[nltk_data] Downloading package omw-1.4 to /home/wgilliam/nltk_data...
[nltk_data]   Package omw-1.4 is already up-to-date!
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>bleu</th>
      <th>meteor</th>
      <th>sacrebleu</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.060747</td>
      <td>2.086900</td>
      <td>0.332818</td>
      <td>0.555242</td>
      <td>32.818199</td>
      <td>00:52</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "></div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>target</th>
      <th>prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Die▁Zunahme der▁Gewalttätigkeiten▁bei▁nationalen und▁internationalen Sportveranstaltungen▁resultiert nicht▁aus dem▁Fehlen von▁Informationsnetzen und▁ausreichenden▁Unterdrückungsmechanismen,▁sondern▁ist auf die▁Kommerzialisierung des Sports, die▁damit▁zusammenhängenden▁enormen▁wirtschaftlichen▁Interessen, die▁Förderung▁eines desorientierenden'sportlichen'▁Geistes des Fanatismus (Fußballrowdytums)▁sowie die Propagierung▁einer▁Psychologie der▁Gewalt▁insbesondere▁unter den▁Jugendlichen▁zurückzuführe</td>
      <td>The increase in violent clashes at national and international sporting events is not due to a lack of information networks or adequate suppression mechanisms; it is due to the commercialisation of sport, the huge financial interests tied up in it, th</td>
      <td>[The increase in violence at national and international sporting events is not due to the lack of information networks and adequate mechanisms of repression, but to the commercialisation of sport, the associated enormous economic interests, the promotion of a disorienting 'sporty' spirit of fanaticism (football rovdytums) and the promotion of a psychology of violence, especially among young people., Perhaps, however, you would like to ask someone - as Mr Corbett will always be in such cases - to look at our Rules of Procedure, because it is rather strange in this respect: if more than 50 amendments are tabled in plenary on a report, the President, after consultation with the chairman, can ask the committee responsible to hold a meeting to consider the amendments.]</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_de</span> <span class="o">=</span> <span class="s2">&quot;Ich trinke gerne Bier&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">blurr_translate</span><span class="p">(</span><span class="n">test_de</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;translation_texts&#39;: &#39;I like to drink beer&#39;}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">export_fname</span> <span class="o">=</span> <span class="s2">&quot;translation_export&quot;</span>

<span class="n">learn</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">to_fp32</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_fname</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>

<span class="n">inf_learn</span> <span class="o">=</span> <span class="n">load_learner</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_fname</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
<span class="n">inf_learn</span><span class="o">.</span><span class="n">blurr_generate</span><span class="p">(</span><span class="n">test_de</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;generated_texts&#39;: &#39;I like to drink beer&#39;}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tests">Tests<a class="anchor-link" href="#Tests"> </a></h2><p>The purpose of the following tests is to ensure as much as possible, that the core training code works for the pretrained <strong>translation models</strong> below.  These tests are excluded from the CI workflow because of how long they would take to run and the amount of data that would be required to download.</p>
<p><strong>Note</strong>: Feel free to modify the code below to test whatever pretrained summarization models you are working with ... and if any of your pretrained translation models fail, please submit a github issue <em>(or a PR if you'd like to fix it yourself)</em></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">del</span> <span class="n">learn</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="p">[</span><span class="n">model_type</span> <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="n">NLP</span><span class="o">.</span><span class="n">get_models</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="s2">&quot;ConditionalGeneration&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">model_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">))]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;BartForConditionalGeneration&#39;,
 &#39;BigBirdPegasusForConditionalGeneration&#39;,
 &#39;BlenderbotForConditionalGeneration&#39;,
 &#39;BlenderbotSmallForConditionalGeneration&#39;,
 &#39;FSMTForConditionalGeneration&#39;,
 &#39;LEDForConditionalGeneration&#39;,
 &#39;M2M100ForConditionalGeneration&#39;,
 &#39;MBartForConditionalGeneration&#39;,
 &#39;MT5ForConditionalGeneration&#39;,
 &#39;PegasusForConditionalGeneration&#39;,
 &#39;ProphetNetForConditionalGeneration&#39;,
 &#39;Speech2TextForConditionalGeneration&#39;,
 &#39;T5ForConditionalGeneration&#39;,
 &#39;XLMProphetNetForConditionalGeneration&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pretrained_model_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;facebook/bart-base&quot;</span><span class="p">,</span>
    <span class="s2">&quot;facebook/wmt19-de-en&quot;</span><span class="p">,</span>  <span class="c1"># FSMT</span>
    <span class="s2">&quot;Helsinki-NLP/opus-mt-de-en&quot;</span><span class="p">,</span>  <span class="c1"># MarianMT</span>
    <span class="c1">#&#39;sshleifer/tiny-mbart&#39;,</span>
    <span class="c1">#&#39;google/mt5-small&#39;,</span>
    <span class="s2">&quot;t5-small&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;wmt16&quot;</span><span class="p">,</span> <span class="s2">&quot;de-en&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1200</span><span class="p">))</span>
<span class="n">wmt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;translation&quot;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;de&quot;</span><span class="p">,</span> <span class="s2">&quot;en&quot;</span><span class="p">])</span>
<span class="nb">len</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset wmt16 (/home/wgilliam/.cache/huggingface/datasets/wmt16/de-en/1.0.0/af3c5d746b307726d0de73ebe7f10545361b9cb6f75c83a1734c000e48b6264f)
Loading cached shuffled indices for dataset at /home/wgilliam/.cache/huggingface/datasets/wmt16/de-en/1.0.0/af3c5d746b307726d0de73ebe7f10545361b9cb6f75c83a1734c000e48b6264f/cache-8fc54b133c8c43b7.arrow
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>1200</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># hide_output</span>
<span class="n">model_cls</span> <span class="o">=</span> <span class="n">AutoModelForSeq2SeqLM</span>
<span class="n">bsz</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">inp_seq_sz</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">trg_seq_sz</span> <span class="o">=</span> <span class="mi">128</span>

<span class="n">test_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">pretrained_model_names</span><span class="p">:</span>
    <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">hf_tok_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;sshleifer/tiny-mbart&quot;</span><span class="p">:</span>
        <span class="n">hf_tok_kwargs</span><span class="p">[</span><span class="s2">&quot;src_lang&quot;</span><span class="p">],</span> <span class="n">hf_tok_kwargs</span><span class="p">[</span><span class="s2">&quot;tgt_lang&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;de_DE&quot;</span><span class="p">,</span> <span class="s2">&quot;en_XX&quot;</span>

    <span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span> <span class="o">=</span> <span class="n">NLP</span><span class="o">.</span><span class="n">get_hf_objects</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_cls</span><span class="o">=</span><span class="n">model_cls</span><span class="p">,</span> <span class="n">tokenizer_kwargs</span><span class="o">=</span><span class="n">hf_tok_kwargs</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;architecture:</span><span class="se">\t</span><span class="si">{</span><span class="n">hf_arch</span><span class="si">}</span><span class="se">\n</span><span class="s2">tokenizer:</span><span class="se">\t</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s2">model:</span><span class="se">\t\t</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 1. build your DataBlock</span>
    <span class="n">text_gen_kwargs</span> <span class="o">=</span> <span class="n">default_text_gen_kwargs</span><span class="p">(</span><span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s2">&quot;translation&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_t5_prefix</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;translate German to English: </span><span class="si">{</span><span class="n">inp</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">hf_arch</span> <span class="o">==</span> <span class="s2">&quot;t5&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">inp</span>

    <span class="n">batch_tokenize_tfm</span> <span class="o">=</span> <span class="n">Seq2SeqBatchTokenizeTransform</span><span class="p">(</span>
        <span class="n">hf_arch</span><span class="p">,</span>
        <span class="n">hf_config</span><span class="p">,</span>
        <span class="n">hf_tokenizer</span><span class="p">,</span>
        <span class="n">hf_model</span><span class="p">,</span>
        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="n">inp_seq_sz</span><span class="p">,</span>
        <span class="n">max_target_length</span><span class="o">=</span><span class="n">trg_seq_sz</span><span class="p">,</span>
        <span class="n">text_gen_kwargs</span><span class="o">=</span><span class="n">text_gen_kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">Seq2SeqTextBlock</span><span class="p">(</span><span class="n">batch_tokenize_tfm</span><span class="o">=</span><span class="n">batch_tokenize_tfm</span><span class="p">),</span> <span class="n">noop</span><span class="p">)</span>
    <span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> <span class="n">get_x</span><span class="o">=</span><span class="n">Pipeline</span><span class="p">([</span><span class="n">ColReader</span><span class="p">(</span><span class="s2">&quot;de&quot;</span><span class="p">),</span> <span class="n">add_t5_prefix</span><span class="p">]),</span> <span class="n">get_y</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s2">&quot;en&quot;</span><span class="p">),</span> <span class="n">splitter</span><span class="o">=</span><span class="n">RandomSplitter</span><span class="p">())</span>

    <span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">wmt_df</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bsz</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>

    <span class="c1"># 2. build your Learner</span>
    <span class="n">seq2seq_metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">BaseModelWrapper</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>
    <span class="n">fit_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ShortEpochCallback</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">short_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">Seq2SeqMetricsCallback</span><span class="p">(</span><span class="n">custom_metrics</span><span class="o">=</span><span class="n">seq2seq_metrics</span><span class="p">)]</span>

    <span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span>
        <span class="n">dls</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">opt_func</span><span class="o">=</span><span class="n">ranger</span><span class="p">,</span>
        <span class="n">loss_func</span><span class="o">=</span><span class="n">PreCalculatedCrossEntropyLoss</span><span class="p">(),</span>
        <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">BaseModelCallback</span><span class="p">],</span>
        <span class="n">splitter</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">blurr_seq2seq_splitter</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">hf_arch</span><span class="p">),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_fp16</span><span class="p">()</span>

    <span class="n">learn</span><span class="o">.</span><span class="n">create_opt</span><span class="p">()</span>
    <span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>

    <span class="c1"># 3. Run your tests</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** TESTING DataLoaders ***</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]),</span> <span class="n">bsz</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">bsz</span><span class="p">,</span> <span class="n">inp_seq_sz</span><span class="p">]))</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">bsz</span><span class="p">)</span>

        <span class="c1">#         print(&#39;*** TESTING One pass through the model ***&#39;)</span>
        <span class="c1">#         preds = learn.model(b[0])</span>
        <span class="c1">#         test_eq(preds[1].shape[0], bsz)</span>
        <span class="c1">#         test_eq(preds[1].shape[2], hf_config.vocab_size)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** TESTING Training/Results ***&quot;</span><span class="p">)</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">fit_cbs</span><span class="p">)</span>

        <span class="n">test_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">hf_arch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;PASSED&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">input_trunc_at</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">target_trunc_at</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">test_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">hf_arch</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># cleanup</span>
        <span class="k">del</span> <span class="n">learn</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>arch</th>
      <th>tokenizer</th>
      <th>model_name</th>
      <th>result</th>
      <th>error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>bart</td>
      <td>BartTokenizerFast</td>
      <td>BartForConditionalGeneration</td>
      <td>PASSED</td>
      <td></td>
    </tr>
    <tr>
      <th>1</th>
      <td>fsmt</td>
      <td>FSMTTokenizer</td>
      <td>FSMTForConditionalGeneration</td>
      <td>PASSED</td>
      <td></td>
    </tr>
    <tr>
      <th>2</th>
      <td>marian</td>
      <td>MarianTokenizer</td>
      <td>MarianMTModel</td>
      <td>PASSED</td>
      <td></td>
    </tr>
    <tr>
      <th>3</th>
      <td>t5</td>
      <td>T5TokenizerFast</td>
      <td>T5ForConditionalGeneration</td>
      <td>PASSED</td>
      <td></td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Summary">Summary<a class="anchor-link" href="#Summary"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This module includes the fundamental bits to use Blurr for translation tasks training and inference.</p>

</div>
</div>
</div>
</div>
 

